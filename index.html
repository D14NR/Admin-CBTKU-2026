
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login Admin - Portal Admin CBT 2026</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
      :root {
        --bg: #f3f4f6;
        --surface: #ffffff;
        --surface-alt: #f9fafb;
        --border: #e5e7eb;
        --border-strong: #d1d5db;
        --primary: #2563eb;
        --primary-soft: rgba(37, 99, 235, 0.12);
        --primary-hover: #1d4ed8;
        --danger: #dc2626;
        --danger-soft: rgba(220, 38, 38, 0.1);
        --danger-hover: #b91c1c;
        --text: #111827;
        --text-muted: #6b7280;
        --radius-sm: 6px;
        --radius-md: 10px;
        --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.06);
        --shadow-md: 0 4px 6px rgba(15, 23, 42, 0.08);
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html, body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      /* Body untuk halaman login */
      body.login-page {
        background: radial-gradient(circle at top left, #e0f2fe 0, #eef2ff 35%, #f9fafb 70%, #f3f4f6 100%);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Body untuk halaman app */
      body.app-page {
        background: radial-gradient(circle at top left, #e0f2fe 0, #eef2ff 35%, #f9fafb 70%, #f3f4f6 100%);
        min-height: 100vh;
      }

      /* LOGIN STYLES */
      #login-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        padding: 20px;
        width: 100%;
      }

      .login-card {
        background: #ffffff;
        width: 100%;
        max-width: 360px;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.8);
        text-align: center;
        margin-bottom: 60px;
      }

      .login-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text);
      }

      .login-subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 24px;
      }

      .login-form input {
        margin-bottom: 12px;
        width: 100%;
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-strong);
        font-size: 14px;
      }

      .login-btn {
        width: 100%;
        margin-top: 8px;
        padding: 10px;
        font-size: 14px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
      }

      .login-btn:hover {
        background: var(--primary-hover);
      }

      /* Password wrapper styles */
      .password-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .password-wrapper input {
        flex: 1;
        padding-right: 40px;
        margin-bottom: 0;
      }

      .toggle-password {
        position: absolute;
        right: 8px;
        background: transparent;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 100%;
      }

      .toggle-password:hover {
        color: var(--primary);
        background: transparent;
        box-shadow: none;
      }

      /* APP STYLES */
      .app-shell {
        max-width: 1200px;
        margin: 24px auto 40px;
        padding: 0 16px;
        display: none;
      }

      .app-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 16px;
      }

      .app-title {
        margin: 0;
        font-size: 20px;
        font-weight: 650;
        color: var(--text);
      }

      .app-subtitle {
        margin: 2px 0 0;
        font-size: 13px;
        color: var(--text-muted);
        max-width: 520px;
      }

      .app-badge {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--primary-soft);
        color: var(--primary);
        border: 1px solid rgba(37, 99, 235, 0.25);
        align-self: flex-start;
        white-space: nowrap;
        cursor: pointer;
      }

      /* Tabs */
      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 6px;
        background: rgba(255,255,255,0.9);
        border-radius: 999px;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(148, 163, 184, 0.4);
        position: sticky;
        top: 12px;
        z-index: 50;
        backdrop-filter: blur(10px);
      }

      .tab-button {
        flex: 1 1 auto;
        border-radius: 999px;
        border: none;
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 500;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease, box-shadow 0.15s;
        white-space: nowrap;
      }

      .tab-button:hover {
        background: rgba(15,23,42,0.04);
        color: var(--text);
      }

      .tab-button.active {
        background: #ffffff;
        color: var(--primary);
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
      }

      .tab-content {
        margin-top: 18px;
        padding: 16px 18px 20px;
        background: rgba(255,255,255,0.95);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
      }

      .section-header {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-bottom: 10px;
      }

      .section-header h2 {
        margin: 0;
        font-size: 17px;
        font-weight: 600;
      }

      .section-subtitle {
        margin: 0;
        font-size: 12px;
        color: var(--text-muted);
      }

      /* Forms */
      form {
        margin-bottom: 16px;
        padding: 14px 16px 16px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        background: var(--surface);
        box-shadow: var(--shadow-sm);
        max-width: 900px;
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: var(--text);
        margin-bottom: 10px;
      }

      label > input,
      label > select,
      label > textarea {
        margin-top: 4px;
      }

      input[type="text"],
      input[type="password"],
      input[type="tel"],
      input[type="number"],
      input[type="datetime-local"],
      select,
      textarea {
        width: 100%;
        padding: 7px 9px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-strong);
        background: var(--surface-alt);
        font-size: 13px;
        color: var(--text);
        transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      }

      input[type="text"]:focus,
      input[type="password"]:focus,
      input[type="tel"]:focus,
      input[type="number"]:focus,
      input[type="datetime-local"]:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 1px var(--primary-soft);
        background: #ffffff;
      }

      textarea {
        resize: vertical;
        min-height: 70px;
      }

      input[readonly] {
        background: #f3f4f6;
        color: var(--text-muted);
      }

      /* Buttons */
      button {
        border-radius: 999px;
        border: none;
        padding: 7px 14px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        background: var(--primary);
        color: #ffffff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: background-color 0.15s ease, box-shadow 0.15s ease, transform 0.04s ease;
      }

      button:hover {
        background: var(--primary-hover);
        box-shadow: 0 3px 6px rgba(37, 99, 235, 0.25);
      }

      button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.25);
      }

      button[disabled] {
        opacity: 0.65;
        cursor: default;
        box-shadow: none;
      }

      button[onclick^="delete"],
      button[onclick^="hapus"],
      button[onclick^="deleteSelected"] {
        background: var(--danger);
      }

      button[onclick^="delete"]:hover,
      button[onclick^="hapus"]:hover,
      button[onclick^="deleteSelected"]:hover {
        background: var(--danger-hover);
        box-shadow: 0 3px 6px rgba(220, 38, 38, 0.24);
      }

      button[onclick="generateTokenUjian()"] {
        background: #0f172a;
      }

      button[onclick="generateTokenUjian()"]:hover {
        background: #020617;
      }

      .actions button {
        padding: 4px 10px;
        font-size: 12px;
      }

      /* Tables */
      .table-card {
        margin-top: 4px;
        padding: 10px 12px 12px;
        border-radius: var(--radius-md);
        background: var(--surface);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
      }

      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
        min-width: 700px;
      }

      th, td {
        border-bottom: 1px solid var(--border);
        padding: 7px 8px;
        text-align: left;
      }

      th {
        background: var(--surface-alt);
        font-weight: 600;
        color: var(--text-muted);
        position: sticky;
        top: 0;
        z-index: 1;
      }

      tbody tr:nth-child(even) {
        background: #f9fafb;
      }

      tbody tr:hover {
        background: #eff6ff;
      }

      th:first-child,
      td:first-child {
        padding-left: 10px;
      }

      th:last-child,
      td:last-child {
        padding-right: 10px;
      }

      th input[type="checkbox"] {
        transform: translateY(1px);
      }

      /* Bank Soal sections */
      #group-pg,
      #group-pernyataan,
      #group-pejodohan {
        border-radius: var(--radius-sm);
        border: 1px dashed var(--border-strong);
        background: #f9fafb;
        padding: 12px;
        margin-top: 8px;
      }

      #group-pg strong,
      #group-pernyataan strong,
      #group-pejodohan strong {
        font-size: 13px;
        color: var(--text);
        display: block;
        margin-bottom: 8px;
      }

      /* Kartu Peserta - Print Styles */
      .kartu-container {
        page-break-inside: avoid;
        border: 2px solid #111827;
        padding: 16px;
        margin: 12px auto;
        width: 8.5cm;
        height: 12cm;
        font-size: 13px;
        background: #ffffff;
        font-family: "Segoe UI", system-ui, sans-serif;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .kartu-logo {
        text-align: center;
        margin-bottom: 8px;
        color: #2563eb;
        font-weight: bold;
        font-size: 14px;
      }

      .kartu-header {
        text-align: center;
        font-weight: 700;
        margin-bottom: 8px;
        border-bottom: 3px double #111827;
        padding-bottom: 8px;
        letter-spacing: 0.05em;
        font-size: 16px;
        color: #1e293b;
      }

      .kartu-title {
        text-align: center;
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 12px;
        color: #2563eb;
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        padding: 4px 0;
      }

      .kartu-table {
        width: 100%;
        border-collapse: collapse;
        margin: 8px 0;
      }

      .kartu-table td {
        padding: 6px 4px;
        vertical-align: top;
        border-bottom: 1px solid #e5e7eb;
      }

      .kartu-table td.label {
        width: 45%;
        font-weight: 600;
        color: #374151;
      }

      .kartu-table tr:last-child td {
        border-bottom: none;
      }

      .kartu-footer {
        margin-top: 12px;
        font-size: 10px;
        color: #6b7280;
        text-align: center;
        padding: 8px;
        border-top: 1px dashed #d1d5db;
        background: #f9fafb;
        border-radius: 6px;
      }

      .kartu-watermark {
        position: absolute;
        bottom: 8px;
        right: 8px;
        font-size: 9px;
        color: #9ca3af;
        font-style: italic;
      }

      /* Print area */
      #printArea {
        display: none;
      }

      @media print {
        body * {
          visibility: hidden;
        }
        #printArea,
        #printArea * {
          visibility: visible;
        }
        #printArea {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          margin: 0;
          padding: 20px;
          display: grid !important;
          grid-template-columns: repeat(2, 1fr);
          gap: 16px;
        }
        
        .kartu-container {
          width: 100% !important;
          height: auto !important;
          margin: 0 !important;
          break-inside: avoid;
          box-shadow: none !important;
          border: 1.5px solid #000 !important;
        }
        
        @page {
          margin: 15mm;
          size: A4 portrait;
        }
      }

      /* Modal */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-backdrop.show {
        display: flex;
      }

      .modal {
        background: #ffffff;
        border-radius: 12px;
        width: 100%;
        max-width: 720px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
        border: 1px solid rgba(148, 163, 184, 0.6);
      }

      .modal-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .modal-title {
        font-size: 15px;
        font-weight: 600;
      }

      .modal-close-btn {
        border-radius: 999px;
        border: none;
        width: 26px;
        height: 26px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 18px;
        padding: 0;
      }

      .modal-close-btn:hover {
        background: rgba(15,23,42,0.05);
        color: var(--text);
      }

      .modal-body {
        padding: 12px 16px 14px;
        overflow: auto;
      }

      .modal-body form {
        box-shadow: none;
        border: none;
        padding: 0;
        margin: 0;
        max-width: 100%;
      }

      @media (max-width: 768px) {
        .app-shell {
          margin: 16px auto 24px;
          padding: 0 10px;
        }
        .tab-content {
          padding: 12px 12px 16px;
        }
        .app-header {
          margin-bottom: 10px;
        }
        .tabs {
          border-radius: 16px;
        }
        table {
          min-width: 600px;
        }
        .kartu-container {
          width: 100%;
          height: auto;
        }
      }

      @media (max-width: 480px) {
        .tabs {
          flex-wrap: nowrap;
          overflow-x: auto;
        }
        .tab-button {
          flex: 0 0 auto;
        }
      }

      /* ====== MODERN NOTIFICATION SYSTEM ====== */
      .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 99999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
        pointer-events: none;
      }

      .notification {
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        border-left: 5px solid;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        transform: translateX(120%);
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        pointer-events: auto;
        max-width: 380px;
        min-width: 300px;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.hide {
        transform: translateX(120%);
      }

      .notification-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 14px;
        font-weight: bold;
      }

      .notification-content {
        flex: 1;
        min-width: 0;
      }

      .notification-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        color: #111827;
      }

      .notification-message {
        font-size: 13px;
        color: #4b5563;
        line-height: 1.4;
      }

      .notification-close {
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 4px;
        font-size: 18px;
        line-height: 1;
        flex-shrink: 0;
        transition: color 0.2s;
      }

      .notification-close:hover {
        color: #6b7280;
      }

      /* Notification Types */
      .notification.success {
        border-left-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4, #ffffff);
      }

      .notification.success .notification-icon {
        background: #10b981;
        color: white;
      }

      .notification.error {
        border-left-color: #ef4444;
        background: linear-gradient(135deg, #fef2f2, #ffffff);
      }

      .notification.error .notification-icon {
        background: #ef4444;
        color: white;
      }

      .notification.warning {
        border-left-color: #f59e0b;
        background: linear-gradient(135deg, #fffbeb, #ffffff);
      }

      .notification.warning .notification-icon {
        background: #f59e0b;
        color: white;
      }

      .notification.info {
        border-left-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff, #ffffff);
      }

      .notification.info .notification-icon {
        background: #3b82f6;
        color: white;
      }

      /* Progress bar */
      .notification-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 0 0 12px 12px;
        overflow: hidden;
      }

      .notification-progress-bar {
        height: 100%;
        width: 100%;
        transform-origin: left;
        transform: scaleX(1);
        transition: transform linear;
      }

      .notification.success .notification-progress-bar {
        background: #10b981;
      }

      .notification.error .notification-progress-bar {
        background: #ef4444;
      }

      .notification.warning .notification-progress-bar {
        background: #f59e0b;
      }

      .notification.info .notification-progress-bar {
        background: #3b82f6;
      }

      /* Confirmation Dialog */
      .confirmation-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.75);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(4px);
      }

      .confirmation-dialog.show {
        display: flex;
      }

      .confirmation-box {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
        animation: dialogSlideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }

      @keyframes dialogSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .confirmation-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        font-size: 28px;
      }

      .confirmation-icon.warning {
        background: #fef3c7;
        color: #f59e0b;
      }

      .confirmation-icon.info {
        background: #dbeafe;
        color: #3b82f6;
      }

      .confirmation-title {
        font-size: 18px;
        font-weight: 600;
        text-align: center;
        margin-bottom: 8px;
        color: #111827;
      }

      .confirmation-message {
        font-size: 14px;
        color: #6b7280;
        text-align: center;
        margin-bottom: 24px;
        line-height: 1.5;
      }

      .confirmation-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .confirmation-btn {
        padding: 10px 24px;
        border-radius: 999px;
        border: none;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 100px;
      }

      .confirmation-btn.cancel {
        background: #f3f4f6;
        color: #4b5563;
      }

      .confirmation-btn.cancel:hover {
        background: #e5e7eb;
      }

      .confirmation-btn.confirm {
        background: #3b82f6;
        color: white;
      }

      .confirmation-btn.confirm:hover {
        background: #2563eb;
      }

      .confirmation-btn.confirm.delete {
        background: #ef4444;
      }

      .confirmation-btn.confirm.delete:hover {
        background: #dc2626;
      }

      /* Toast Notification */
      .toast-notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: #1f2937;
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 14px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 90%;
      }

      .toast-notification.show {
        transform: translateX(-50%) translateY(0);
      }

      .toast-icon {
        font-size: 18px;
      }

      .toast-message {
        flex: 1;
      }

      /* ====== FOOTER STYLES ====== */
      .site-footer {
        padding: 16px;
        text-align: center;
        font-size: 13px;
        color: var(--text-muted);
        border-top: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        width: 100%;
        margin-top: auto;
      }

      .footer-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .footer-text {
        font-weight: 500;
        color: var(--primary);
        letter-spacing: 0.5px;
      }

      .footer-subtext {
        font-size: 11px;
        color: var(--text-muted);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .site-footer {
          margin-top: 20px;
          padding: 12px;
          font-size: 12px;
        }
        
        .footer-subtext {
          font-size: 10px;
        }
      }

      /* Image preview */
      .image-preview {
        margin-top: 10px;
        max-width: 200px;
        max-height: 150px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        object-fit: contain;
      }

      .preview-container {
        margin-top: 8px;
      }

      /* Checkbox Grid untuk Mapel */
.mapel-checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 6px;
  margin-top: 4px;
}

.mapel-checkbox-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 8px;
  background: white;
  border: 1px solid var(--border);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.mapel-checkbox-item:hover {
  background: var(--primary-soft);
  border-color: var(--primary);
}

.mapel-checkbox-item input[type="checkbox"] {
  margin: 0;
  cursor: pointer;
}

.mapel-checkbox-label {
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  flex: 1;
}

.mapel-checkbox-count {
  font-size: 11px;
  color: var(--text-muted);
  background: var(--surface-alt);
  padding: 1px 6px;
  border-radius: 10px;
}

/* Tabel Jawaban Permapel */
.jawaban-permapel-table {
  font-size: 12px;
  width: 100%;
  border-collapse: collapse;
}

.jawaban-permapel-table th {
  background: #f1f5f9;
  font-weight: 600;
  color: var(--text);
  padding: 8px 6px;
  border: 1px solid var(--border);
  text-align: center;
  white-space: nowrap;
}

.jawaban-permapel-table td {
  padding: 6px 5px;
  border: 1px solid var(--border);
  text-align: center;
}

.jawaban-permapel-table tr:nth-child(even) {
  background: #f8fafc;
}

.jawaban-permapel-table tr:hover {
  background: #e0f2fe;
}

/* Header yang sticky */
.jawaban-table-container {
  max-height: 500px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-top: 10px;
}

.jawaban-table-container table {
  margin-bottom: 0;
}

/* Warna untuk jawaban */
.jawaban-benar {
  background-color: #dcfce7;
  color: #166534;
  font-weight: 600;
}

.jawaban-salah {
  background-color: #fee2e2;
  color: #991b1b;
  font-weight: 600;
}

.jawaban-kosong {
  background-color: #f3f4f6;
  color: #6b7280;
  font-style: italic;
}
    </style>
  </head>
  <body class="login-page">

    <!-- LOGIN SECTION -->
    <div id="login-section">
      <div class="login-card">
        <div class="login-title">Login Admin</div>
        <div class="login-subtitle">Portal Admin CBT 2026</div>
        <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
          <input type="text" id="login_username" placeholder="Username" required>
          
          <div class="password-wrapper">
            <input type="password" id="login_password" placeholder="Password" required>
            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('login_password', this)">
              üëÅÔ∏è
            </button>
          </div>
          
          <button type="submit" class="login-btn">Masuk</button>
        </form>
      </div>
    </div>

    <!-- MAIN APP SHELL (Hidden by default) -->
    <div class="app-shell" id="app-shell">
      <header class="app-header">
        <div>
          <h1 class="app-title">Portal Admin CBT 2026</h1>
          <p class="app-subtitle">
            Kelola peserta, agenda ujian, mata pelajaran, bank soal, monitoring, jawaban siswa, dan cetak kartu peserta.
          </p>
        </div>
        <div class="app-badge" onclick="handleLogout()" title="Klik untuk Logout">
          Admin CBT2026 (Logout)
        </div>
      </header>

      <!-- TAB MENU -->
      <div class="tabs">
        <button id="tab-btn-peserta" class="tab-button active" onclick="showTab('peserta')">
          Peserta
        </button>
        <button id="tab-btn-agenda" class="tab-button" onclick="showTab('agenda')">
          Agenda Ujian
        </button>
        <button id="tab-btn-mapel" class="tab-button" onclick="showTab('mapel')">
          Mata Pelajaran
        </button>
        <button id="tab-btn-banksoal" class="tab-button" onclick="showTab('banksoal')">
          Bank Soal
        </button>
        <button id="tab-btn-monitoring" class="tab-button" onclick="showTab('monitoring')">
          Monitoring Pengerjaan
        </button>
        <button id="tab-btn-jawaban" class="tab-button" onclick="showTab('jawaban')">
          Jawaban Siswa
        </button>
        <button id="tab-btn-cekjawabanmapel" class="tab-button" onclick="showTab('cekjawabanmapel')">
          Cek Jawaban Permapel
        </button>
        <button id="tab-btn-cetakkartu" class="tab-button" onclick="showTab('cetakkartu')">
          Cetak Kartu
        </button>
      </div>

      <!-- TAB PESERTA -->
      <div id="tab-peserta" class="tab-content" style="display:block;">
        <div class="section-header">
          <h2>Data Peserta</h2>
          <p class="section-subtitle">Input dan kelola data peserta ujian untuk setiap agenda.</p>
        </div>

        <div style="margin-bottom:8px; display:flex; flex-wrap:wrap; gap:6px;">
          <button type="button" onclick="openPesertaModalForCreate()">+ Tambah Peserta</button>
          <button type="button" onclick="showModal('modal-import-peserta')">Import Data</button>
          <button type="button" onclick="exportPesertaToCsv()">Export Data</button>
        </div>

        <div class="section-header">
          <h2>Daftar Peserta</h2>
          <p class="section-subtitle">Data peserta yang tersimpan di Firebase.</p>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="pesertaTable">
              <thead>
                <tr>
                  <th>NIS_Username</th>
                  <th>Nama_Peserta</th>
                  <th>Password</th>
                  <th>Jenjang_Studi</th>
                  <th>Kelas</th>
                  <th>Asal_Sekolah</th>
                  <th>No_WA_Peserta</th>
                  <th>No_WA_Ortu</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB AGENDA UJIAN -->
      <div id="tab-agenda" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Agenda Ujian</h2>
          <p class="section-subtitle">Atur jadwal, token, dan deskripsi setiap agenda ujian.</p>
        </div>

        <div style="margin-bottom:8px;">
          <button type="button" onclick="openAgendaModalForCreate()">+ Tambah Agenda</button>
        </div>

        <div class="section-header">
          <h2>Daftar Agenda Ujian</h2>
          <p class="section-subtitle">Semua agenda ujian yang sudah dibuat.</p>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="agendaTable">
              <thead>
                <tr>
                  <th>Agenda_Ujian</th>
                  <th>Deskripsi_Ujian</th>
                  <th>Jenjang_Studi</th>
                  <th>Jenis_Tes</th>
                  <th>TglJam_Mulai</th>
                  <th>TglJam_Selesai</th>
                  <th>Token_Ujian</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB MATA PELAJARAN -->
      <div id="tab-mapel" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Mata Pelajaran</h2>
          <p class="section-subtitle">Tetapkan mapel, jumlah soal, dan durasi per agenda ujian.</p>
        </div>

        <label>
          Pilih Agenda Ujian:
          <select id="Mapel_Agenda_Select" onchange="onChangeAgendaMapel()">
            <option value="">-- Pilih Agenda Ujian dulu --</option>
          </select>
        </label>

        <div style="margin:8px 0 10px;">
          <button type="button" onclick="openMapelModalForCreate()">+ Tambah Mata Pelajaran</button>
        </div>

        <div class="section-header">
          <h2>Daftar Mata Pelajaran</h2>
          <p class="section-subtitle">Berdasarkan agenda ujian yang dipilih.</p>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="mapelTable">
              <thead>
                <tr>
                  <th>Nama_Mata_Pelajaran</th>
                  <th>Jumlah_Soal</th>
                  <th>Durasi_Ujian (menit)</th>
                  <th>Status_Mapel</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB BANK SOAL -->
      <div id="tab-banksoal" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Bank Soal</h2>
          <p class="section-subtitle">Input dan kelola butir soal per agenda dan mata pelajaran.</p>
        </div>

        <label>
          Pilih Agenda Ujian:
          <select id="Bank_Agenda_Select" onchange="onChangeAgendaBankSoal()">
            <option value="">-- Pilih Agenda Ujian dulu --</option>
          </select>
        </label>

        <label>
          Pilih Mata Pelajaran:
          <select id="Bank_Mapel_Select" onchange="onChangeMapelBankSoal()">
            <option value="">-- Pilih Mata Pelajaran --</option>
          </select>
        </label>

        <div style="margin:8px 0 10px; display:flex; flex-wrap:wrap; gap:6px;">
          <button type="button" onclick="openBankSoalModalForCreate()">+ Tambah Soal</button>
          <button type="button" onclick="openImportBankSoalModal()">Import Data</button>
          <button type="button" onclick="deleteSelectedBankSoal()" style="background: var(--danger);">Hapus Terpilih</button>
          <button type="button" onclick="selectAllBankSoal()">Pilih Semua</button>
          <button type="button" onclick="deselectAllBankSoal()">Batal Pilih</button>
          <button type="button" onclick="deleteAllBankSoal()" style="background: var(--danger);">Hapus Semua di Mapel Ini</button>
        </div>

        <div class="section-header">
          <h2>Daftar Soal</h2>
          <p class="section-subtitle">Berdasarkan agenda dan mata pelajaran yang dipilih.</p>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="bankSoalTable">
              <thead>
                <tr>
                  <th style="width: 30px;">
                    <input type="checkbox" id="bankSoal_select_all" onclick="toggleSelectAllBankSoal(this)">
                  </th>
                  <th>No_Soal</th>
                  <th>Type_Soal</th>
                  <th>Pertanyaan</th>
                  <th>Gambar</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB MONITORING PENGERJAAN -->
      <div id="tab-monitoring" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Monitoring Pengerjaan</h2>
          <p class="section-subtitle">Pantau aktivitas login dan status pengerjaan peserta.</p>
        </div>

        <div style="margin-bottom:8px;">
          <button type="button" onclick="deleteSelectedMonitoring()">Hapus Terpilih</button>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="monitoringTable">
              <thead>
                <tr>
                  <th><input type="checkbox" id="monitoring_select_all" onclick="toggleSelectAllMonitoring(this)"></th>
                  <th>NIS_Username</th>
                  <th>Nama_Peserta</th>
                  <th>Aktivitas_Login</th>
                  <th>Judul_Ujian</th>
                  <th>Mata_Pelajaran</th>
                  <th>Status_Pengerjaan</th>
                  <th>TglJam_Mulai</th>
                  <th>Last_Update</th>
                  <th>TglJam_Selesai</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- TAB CEK JAWABAN PERMAPEL -->
<div id="tab-cekjawabanmapel" class="tab-content" style="display:none;">
  <div class="section-header">
    <h2>Cek Jawaban Permapel</h2>
    <p class="section-subtitle">Lihat jawaban siswa per mata pelajaran untuk agenda tertentu.</p>
  </div>

  <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 20px;">
    <div style="flex: 1; min-width: 250px;">
      <label>
        Pilih Agenda Ujian:
        <select id="CekJawaban_Agenda_Select" onchange="onChangeAgendaCekJawaban()">
          <option value="">-- Pilih Agenda Ujian --</option>
        </select>
      </label>
    </div>
    
    <div style="flex: 2; min-width: 300px;">
      <div style="margin-bottom: 6px; font-size: 13px; font-weight: 500;">Pilih Mata Pelajaran:</div>
      <div id="mapelCheckboxContainer" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface-alt);">
        <!-- Checkbox akan diisi oleh JavaScript -->
        <div style="font-size: 12px; color: var(--text-muted);">Pilih agenda ujian terlebih dahulu</div>
      </div>
    </div>
  </div>

  <div style="margin: 8px 0 16px; display: flex; gap: 8px;">
    <button type="button" onclick="loadJawabanPermapel()">Tampilkan Jawaban</button>
    <button type="button" onclick="exportJawabanPermapelToExcel()">Export ke Excel</button>
    <button type="button" onclick="clearJawabanPermapel()">Clear</button>
  </div>

  <div id="cekJawabanMapelTableContainer">
    <!-- Tabel akan ditampilkan di sini -->
    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px;">
      <div>üìã</div>
      <div>Pilih agenda ujian dan mata pelajaran, lalu klik "Tampilkan Jawaban"</div>
    </div>
  </div>
</div>

      <!-- TAB JAWABAN SISWA -->
      <div id="tab-jawaban" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Jawaban Siswa</h2>
          <p class="section-subtitle">Rekap jawaban peserta untuk setiap sesi ujian.</p>
        </div>

        <div style="margin-bottom:8px; display:flex; flex-wrap:wrap; gap:6px;">
          <button type="button" onclick="deleteSelectedJawaban()">Hapus Terpilih</button>
          <button type="button" onclick="exportJawabanToCsv()">Export Data</button>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="jawabanTable">
              <thead>
                <tr id="jawabanHeaderRow">
                  <!-- header diisi dinamis oleh JS -->
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB CETAK KARTU -->
      <div id="tab-cetakkartu" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Cetak Kartu Peserta</h2>
          <p class="section-subtitle">Pilih agenda dan peserta yang akan dicetak kartunya.</p>
        </div>

        <label>
          Pilih Agenda Ujian:
          <select id="CetakKartu_Agenda_Select" onchange="onChangeAgendaCetakKartu()">
            <option value="">-- Pilih Agenda Ujian dulu --</option>
          </select>
        </label>

        <div style="margin:8px 0 10px;">
          <button type="button" onclick="printKartuSelected()">Print Kartu Terpilih</button>
        </div>

        <div class="section-header">
          <h2>Daftar Peserta</h2>
          <p class="section-subtitle">Peserta pada agenda ujian yang dipilih.</p>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="cetakKartuTable">
              <thead>
                <tr>
                  <th><input type="checkbox" id="kartu_select_all" onclick="toggleSelectAllKartu(this)"></th>
                  <th>NIS_Username</th>
                  <th>Nama_Peserta</th>
                  <th>Password</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- MODALS -->

    <!-- Modal Peserta -->
    <div id="modal-peserta" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Form Peserta</div>
            <p class="section-subtitle">Tambah atau edit data peserta ujian.</p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-peserta')">&times;</button>
        </div>
        <div class="modal-body">
          <form id="pesertaForm" onsubmit="event.preventDefault(); savePeserta();">
            <input type="hidden" id="firebaseId">
            <input type="hidden" id="ID_Peserta">

            <label>
              NIS / Username (otomatis dari No. WA Peserta):
              <input type="text" id="NIS_Username" readonly>
            </label>

            <label>
              Nama Peserta:
              <input type="text" id="Nama_Peserta" required>
            </label>

            <label>
              Password:
              <div class="password-wrapper">
                <input type="password" id="Password" required>
                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('Password', this)">
                  üëÅÔ∏è
                </button>
              </div>
            </label>

            <label>
              Jenjang Studi:
              <select id="Jenjang_Studi" required>
                <option value="">-- Pilih Jenjang --</option>
                <option value="SD">SD</option>
                <option value="SMP">SMP</option>
                <option value="SMA">SMA</option>
                <option value="SMK">SMK</option>
              </select>
            </label>

            <label>
              Kelas:
              <input type="text" id="Kelas" required placeholder="Contoh: 7A, 12 IPA 1">
            </label>

            <label>
              Asal Sekolah:
              <input type="text" id="Asal_Sekolah" required>
            </label>

            <label>
              No. WA Peserta:
              <input type="tel" id="No_WA_Peserta" required
                     placeholder="Contoh: 08123456789 atau +628123456789"
                     oninput="handleNoWAChange()">
            </label>

            <label>
              No. WA Orang Tua:
              <input type="tel" id="No_WA_Ortu">
            </label>

            <label>
              Agenda (diambil dari data Agenda Ujian):
              <select id="ID_Agenda_Peserta" required>
                <option value="">-- Pilih Agenda --</option>
              </select>
            </label>

            <div style="margin-top:8px;">
              <button type="submit">Simpan</button>
              <button type="button" onclick="resetForm()" style="margin-left:6px;">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Agenda -->
    <div id="modal-agenda" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Form Agenda Ujian</div>
            <p class="section-subtitle">Tambah atau edit agenda ujian.</p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-agenda')">&times;</button>
        </div>
        <div class="modal-body">
          <form id="agendaForm" onsubmit="event.preventDefault(); saveAgenda();">
            <input type="hidden" id="firebaseAgendaId">
            <input type="hidden" id="ID_Agenda_Agenda">

            <label>
              Agenda Ujian:
              <input type="text" id="Agenda_Ujian" required>
            </label>

            <label>
              Deskripsi Ujian:
              <input type="text" id="Deskripsi_Ujian" required>
            </label>

            <label>
              Jenjang Studi:
              <select id="Jenjang_Studi_Agenda" required>
                <option value="">-- Pilih Jenjang --</option>
                <option value="SD">SD</option>
                <option value="SMP">SMP</option>
                <option value="SMA">SMA</option>
                <option value="UMUM">UMUM</option>
              </select>
            </label>

            <label>
              Jenis Tes:
              <select id="Jenis_Tes" required>
                <option value="">-- Pilih Jenis Tes --</option>
                <option value="SNBT">SNBT</option>
                <option value="UMUM">UMUM</option>
                <option value="TKA">TKA</option>
                <option value="KEDINASAN">KEDINASAN</option>
              </select>
            </label>

            <label>
              Tanggal & Jam Mulai:
              <input type="datetime-local" id="TglJam_Mulai" required>
            </label>

            <label>
              Tanggal & Jam Selesai:
              <input type="datetime-local" id="TglJam_Selesai" required>
            </label>

            <label>
              Token Ujian (6‚Äì8 karakter, huruf & angka):
              <div style="display:flex; gap:8px;">
                <input type="text" id="Token_Ujian" maxlength="8"
                       placeholder="Contoh: AB12CD, X9K2M3, 7F8G9H"
                       style="flex:1;">
                <button type="button" onclick="generateTokenUjian()">Generate</button>
              </div>
            </label>

            <div style="margin-top:8px;">
              <button type="submit">Simpan</button>
              <button type="button" onclick="resetAgendaForm()" style="margin-left:6px;">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Mapel -->
    <div id="modal-mapel" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Form Mata Pelajaran</div>
            <p class="section-subtitle">Tambah atau edit mata pelajaran untuk agenda terpilih.</p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-mapel')">&times;</button>
        </div>
        <div class="modal-body">
          <form id="mapelForm" onsubmit="event.preventDefault(); saveMapel();">
            <input type="hidden" id="firebaseMapelId">
            <input type="hidden" id="ID_Agenda_Mapel">
            <input type="hidden" id="ID_Mapel_Mapel">

            <label>
              Nama Mata Pelajaran:
              <select id="Nama_Mata_Pelajaran" required>
                <option value="">-- Pilih Mata Pelajaran --</option>
                <option value="Matematika">Matematika</option>
                <option value="Matematika Tingkat Lanjut">Matematika Tingkat Lanjut</option>
                <option value="Fisika">Fisika</option>
                <option value="Kimia">Kimia</option>
                <option value="Biologi">Biologi</option>
                <option value="Ekonomi">Ekonomi</option>
                <option value="Geografi">Geografi</option>
                <option value="Sosiologi">Sosiologi</option>
                <option value="Sejarah">Sejarah</option>
                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                <option value="Bahasa Indonesia Tingkat Lanjut">Bahasa Indonesia Tingkat Lanjut</option>
                <option value="Bahasa Inggris">Bahasa Inggris</option>
                <option value="Bahasa Inggris Tingkat Lanjut">Bahasa Inggris Tingkat Lanjut</option>
                <option value="Ilmu Pengetahuan Alam">Ilmu Pengetahuan Alam</option>
                <option value="Ilmu Pengetahuan Sosial">Ilmu Pengetahuan Sosial</option>
                <option value="Ilmu Pengetahuan Alam &amp; Sosial">Ilmu Pengetahuan Alam &amp; Sosial</option>
                <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                <option value="Produk/Projek Kreatif dan Kewirausahaan">Produk/Projek Kreatif dan Kewirausahaan</option>
                <option value="Penalaran Umum (PU)">Penalaran Umum (PU)</option>
                <option value="Pengetahuan dan Pemahaman Umum (PPU)">Pengetahuan dan Pemahaman Umum (PPU)</option>
                <option value="Pemahaman Bacaan dan Menulis (PBM)">Pemahaman Bacaan dan Menulis (PBM)</option>
                <option value="Pengetahuan Kuantitatif (PK)">Pengetahuan Kuantitatif (PK)</option>
                <option value="Literasi Bahasa Indonesia (LBIND)">Literasi Bahasa Indonesia (LBIND)</option>
                <option value="Literasi Bahasa Inggris (LBING)">Literasi Bahasa Inggris (LBING)</option>
                <option value="Penalaran Matematika (PM)">Penalaran Matematika (PM)</option>
                <option value="Tes Intelegensi Umum (TIU)">Tes Intelegensi Umum (TIU)</option>
                <option value="Prakarya dan Kewirausahaan (PKWU)">Prakarya dan Kewirausahaan (PKWU)</option>
                <option value="Tes Karakteristik Pribadi (TKP)">Tes Karakteristik Pribadi (TKP)</option>
                <option value="Tes Bahasa Inggris (TBI)">Tes Bahasa Inggris (TBI)</option>
                <option value="Tes Potensi Akademik (TPA)">Tes Potensi Akademik (TPA)</option>
              </select>
            </label>

            <label>
              Jumlah Soal:
              <input type="number" id="Jumlah_Soal" min="1" required>
            </label>

            <label>
              Durasi Ujian (menit):
              <input type="number" id="Durasi_Ujian" min="1" required placeholder="Contoh: 90">
            </label>

            <input type="hidden" id="Status_Mapel" value="Draft">

            <div style="margin-top:8px;">
              <button type="submit">Simpan</button>
              <button type="button" onclick="resetMapelForm()" style="margin-left:6px;">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Bank Soal (form manual) -->
    <div id="modal-banksoal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Form Soal</div>
            <p class="section-subtitle">Tambah atau edit butir soal untuk mapel terpilih.</p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-banksoal')">&times;</button>
        </div>
        <div class="modal-body">
          <form id="bankSoalForm" onsubmit="event.preventDefault(); saveSoal();">
            <input type="hidden" id="firebaseSoalId">
            <input type="hidden" id="Gambar_Url">
            <input type="hidden" id="ID_Agenda_Bank">
            <input type="hidden" id="ID_Mapel_Bank">

            <label>
              Nama Mata Pelajaran:
              <input type="text" id="Nama_Mata_Pelajaran_Bank" readonly>
            </label>

            <label>
              No. Soal:
              <input type="number" id="No_Soal" min="1" required readonly>
            </label>

            <label>
              Pertanyaan:
              <textarea id="Pertanyaan" rows="3" required></textarea>
            </label>

            <label>
              Gambar (opsional):
              <input type="file" id="Gambar" accept="image/*" onchange="previewImage(this)">
              <div id="imagePreviewContainer" class="preview-container"></div>
            </label>

            <label>
              Type Soal:
              <select id="Type_Soal" onchange="onTypeSoalChange()" required>
                <option value="">-- Pilih type soal --</option>
                <option value="Pilihan Ganda Tunggal">Pilihan Ganda Tunggal</option>
                <option value="Pilihan Ganda Kompleks">Pilihan Ganda Kompleks</option>
                <option value="Pilihan Benar/Salah">Pilihan Benar/Salah</option>
                <option value="Pilihan Setuju/Tidak">Pilihan Setuju/Tidak</option>
                <option value="Pilihan Pejodohan">Pilihan Pejodohan</option>
                <option value="Uraian">Uraian</option>
              </select>
            </label>

            <!-- Pilihan Ganda A‚ÄìE -->
            <div id="group-pg" style="display:none; padding:8px; margin-top:8px;">
              <strong>Pilihan Ganda (A‚ÄìE)</strong>
              <label>Pilihan A: <input type="text" id="Pilihan_A"></label>
              <label>Pilihan B: <input type="text" id="Pilihan_B"></label>
              <label>Pilihan C: <input type="text" id="Pilihan_C"></label>
              <label>Pilihan D: <input type="text" id="Pilihan_D"></label>
              <label>Pilihan E: <input type="text" id="Pilihan_E"></label>
            </div>

            <!-- Pernyataan 1‚Äì10 -->
            <div id="group-pernyataan" style="display:none; padding:8px; margin-top:8px;">
              <strong>Pernyataan (1‚Äì10)</strong>
              <label>Pernyataan 1: <input type="text" id="Pernyataan_1"></label>
              <label>Pernyataan 2: <input type="text" id="Pernyataan_2"></label>
              <label>Pernyataan 3: <input type="text" id="Pernyataan_3"></label>
              <label>Pernyataan 4: <input type="text" id="Pernyataan_4"></label>
              <label>Pernyataan 5: <input type="text" id="Pernyataan_5"></label>
              <label>Pernyataan 6: <input type="text" id="Pernyataan_6"></label>
              <label>Pernyataan 7: <input type="text" id="Pernyataan_7"></label>
              <label>Pernyataan 8: <input type="text" id="Pernyataan_8"></label>
              <label>Pernyataan 9: <input type="text" id="Pernyataan_9"></label>
              <label>Pernyataan 10:<input type="text" id="Pernyataan_10"></label>
            </div>

            <!-- Pejodohan kiri/kanan 1‚Äì10 -->
            <div id="group-pejodohan" style="display:none; padding:8px; margin-top:8px;">
              <strong>Pejodohan (Pasangan Kiri & Kanan 1‚Äì10)</strong>
              <div style="display:flex; gap:10px; margin-top:6px;">
                <div style="flex:1;">
                  <em>Pasangan Kiri</em>
                  <label>Kiri 1: <input type="text" id="Pasangan_kiri_1"></label>
                  <label>Kiri 2: <input type="text" id="Pasangan_kiri_2"></label>
                  <label>Kiri 3: <input type="text" id="Pasangan_kiri_3"></label>
                  <label>Kiri 4: <input type="text" id="Pasangan_kiri_4"></label>
                  <label>Kiri 5: <input type="text" id="Pasangan_kiri_5"></label>
                  <label>Kiri 6: <input type="text" id="Pasangan_kiri_6"></label>
                  <label>Kiri 7: <input type="text" id="Pasangan_kiri_7"></label>
                  <label>Kiri 8: <input type="text" id="Pasangan_kiri_8"></label>
                  <label>Kiri 9: <input type="text" id="Pasangan_kiri_9"></label>
                  <label>Kiri 10:<input type="text" id="Pasangan_kiri_10"></label>
                </div>
                <div style="flex:1;">
                  <em>Pasangan Kanan</em>
                  <label>Kanan 1: <input type="text" id="Pasangan_kanan_1"></label>
                  <label>Kanan 2: <input type="text" id="Pasangan_kanan_2"></label>
                  <label>Kanan 3: <input type="text" id="Pasangan_kanan_3"></label>
                  <label>Kanan 4: <input type="text" id="Pasangan_kanan_4"></label>
                  <label>Kanan 5: <input type="text" id="Pasangan_kanan_5"></label>
                  <label>Kanan 6: <input type="text" id="Pasangan_kanan_6"></label>
                  <label>Kanan 7: <input type="text" id="Pasangan_kanan_7"></label>
                  <label>Kanan 8: <input type="text" id="Pasangan_kanan_8"></label>
                  <label>Kanan 9: <input type="text" id="Pasangan_kanan_9"></label>
                  <label>Kanan 10:<input type="text" id="Pasangan_kanan_10"></label>
                </div>
              </div>
            </div>

            <div style="margin-top:10px;">
              <button type="submit">Simpan Soal</button>
              <button type="button" onclick="resetBankSoalForm()" style="margin-left:6px;">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Import Peserta -->
    <div id="modal-import-peserta" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Import Data Peserta</div>
            <p class="section-subtitle">Upload file CSV sesuai template untuk menambah banyak peserta sekaligus.</p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-import-peserta')">&times;</button>
        </div>
        <div class="modal-body">
          <p style="font-size:12px; color:var(--text-muted); margin-top:0;">
            Format: CSV dipisah koma, tanpa tanda kutip ganda di dalam isi. Hindari penggunaan koma di dalam isi kolom.
          </p>
          <button type="button" onclick="downloadTemplatePeserta()">Download Template Peserta</button>
          <div style="margin-top:10px;">
            <label>
              Pilih file CSV:
              <input type="file" id="file_import_peserta" accept=".csv" style="margin-top:6px;">
            </label>
          </div>
          <div style="margin-top:10px;">
            <button type="button" onclick="importPesertaFromFile()">Import</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Import Bank Soal -->
    <div id="modal-import-banksoal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Import Bank Soal</div>
            <p class="section-subtitle">
              Upload file CSV soal untuk agenda yang dipilih, lalu pilih mata pelajaran mana saja
              yang akan diimport. Gunakan kolom <strong>Mata_Pelajaran</strong> di template.
            </p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-import-banksoal')">&times;</button>
        </div>
        <div class="modal-body">
          <p style="font-size:12px; color:var(--text-muted); margin-top:0;">
            Pastikan sudah memilih <strong>Agenda Ujian</strong> di Tab Bank Soal.
            File CSV harus memiliki kolom: No_Soal, Mata_Pelajaran, Pertanyaan, Type_Soal
            (opsional: Gambar_URL, pilihan, pernyataan, pasangan).
          </p>

          <!-- daftar mapel yg tersedia utk agenda ini -->
          <div id="import-banksoal-mapel-list"
               style="margin:8px 0 10px; padding:8px; border-radius:6px; border:1px solid #e5e7eb; background:#f9fafb; font-size:12px;">
            <!-- diisi dinamis oleh JS -->
          </div>

          <button type="button" onclick="downloadTemplateBankSoal()">Download Template Bank Soal</button>

          <div style="margin-top:10px;">
            <label>
              Pilih file CSV:
              <input type="file" id="file_import_banksoal" accept=".csv" style="margin-top:6px;">
            </label>
          </div>
          <div style="margin-top:10px;">
            <button type="button" onclick="importBankSoalFromFile()">Import</button>
          </div>
        </div>
      </div>
    </div>
    

    <!-- Modern Notification System -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog">
      <div class="confirmation-box">
        <div class="confirmation-icon warning">‚ö†Ô∏è</div>
        <h3 class="confirmation-title" id="dialogTitle">Konfirmasi</h3>
        <p class="confirmation-message" id="dialogMessage">Apakah Anda yakin?</p>
        <div class="confirmation-buttons">
          <button class="confirmation-btn cancel" onclick="hideConfirmation()">Batal</button>
          <button class="confirmation-btn confirm" id="confirmActionBtn">Ya, Lanjutkan</button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-notification" id="toastNotification">
      <span class="toast-icon">üìã</span>
      <span class="toast-message" id="toastMessage">Pesan toast</span>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-text">Developed by D14nr ¬© 2026</div>
        <div class="footer-subtext">Portal Admin CBT 2026</div>
      </div>
    </footer>

    <!-- Area khusus untuk print kartu -->
    <div id="printArea"></div>

    <script>
      // ====== KONFIGURASI ======
      const firebaseConfig = {
        apiKey: "AIzaSyC1Yakfe4BkvRKs54Vqp3-mcrf-wSn5Gro",
        authDomain: "appku-aa5b2.firebaseapp.com",
        databaseURL: "https://appku-aa5b2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "appku-aa5b2",
        storageBucket: "appku-aa5b2.firebasestorage.app",
        messagingSenderId: "431489373226",
        appId: "1:431489373226:web:1ac51282e3cdb8ccf29f53",
        measurementId: "G-90LQBNR7RG"
      };

      // ====== GOOGLE APPS SCRIPT URL ======
      // GANTI DENGAN URL WEB APP ANDA SETELAH DEPLOY
      const GAS_WEB_APP_URL = 'https://script.google.com/a/~/macros/s/AKfycbyEPeFHezFoLo6n-EsuzFJm960K2vgVlCyZXfIAk4H4AtlipL2rvJ8CJMb4gVHSFBMLjQ/exec';

      // ====== INISIALISASI FIREBASE ======
      let firebaseApp;
      let db;
      let pesertaRef;
      let agendaRef;
      let mapelRef;
      let bankSoalRef;
      let monitoringRef;
      let jawabanRef;
      let storage;

      try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        storage = firebase.storage();
        
        pesertaRef = db.ref('peserta');
        agendaRef = db.ref('agenda_ujian');
        mapelRef = db.ref('mata_pelajaran');
        bankSoalRef = db.ref('bank_soal');
        monitoringRef = db.ref('monitoring_pengerjaan');
        jawabanRef = db.ref('jawaban_siswa');
        
        console.log('Firebase initialized successfully');
      } catch (error) {
        console.error('Firebase initialization error:', error);
        showNotification('error', 'Firebase Error', 'Gagal menginisialisasi Firebase. Periksa koneksi internet.');
      }

      // ====== VARIABEL GLOBAL ======
      let pesertaNameMap = {};
      let currentAgendaForMapel = '';
      let currentAgendaForBank = '';
      let importBankSoalMapelMap = {};
      let currentMapelForBank = '';
      let selectedMapelsForJawaban = [];
      let jawabanPermapelData = [];
      let currentAgendaForKartu = '';
      let kartuPesertaList = [];
      let agendaCache = {};

      // ====== UTILITY FUNCTIONS ======
      
      // Fungsi untuk menampilkan notifikasi
      function showNotification(type, title, message, duration = 5000) {
        const container = document.getElementById('notificationContainer');
        const id = 'notification-' + Date.now();
        
        const iconMap = {
          success: '‚úì',
          error: '‚úó',
          warning: '‚ö†',
          info: '‚Ñπ'
        };
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.id = id;
        
        notification.innerHTML = `
          <div class="notification-icon">${iconMap[type] || '‚Ñπ'}</div>
          <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
          </div>
          <button class="notification-close" onclick="closeNotification('${id}')">&times;</button>
          <div class="notification-progress">
            <div class="notification-progress-bar" style="transform: scaleX(1); transition: transform ${duration}ms linear;"></div>
          </div>
        `;
        
        container.appendChild(notification);
        
        setTimeout(() => {
          notification.classList.add('show');
          
          setTimeout(() => {
            const progressBar = notification.querySelector('.notification-progress-bar');
            if (progressBar) {
              progressBar.style.transform = 'scaleX(0)';
            }
          }, 10);
        }, 10);
        
        if (duration > 0) {
          setTimeout(() => {
            closeNotification(id);
          }, duration);
        }
        
        return id;
      }

      function closeNotification(id) {
        const notification = document.getElementById(id);
        if (notification) {
          notification.classList.remove('show');
          notification.classList.add('hide');
          
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 400);
        }
      }

      function hideAllNotifications() {
        const notifications = document.querySelectorAll('.notification');
        notifications.forEach(notification => {
          notification.classList.remove('show');
          notification.classList.add('hide');
          
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 400);
        });
      }

      function showConfirmation(title, message, onConfirm) {
        document.getElementById('dialogTitle').textContent = title;
        document.getElementById('dialogMessage').textContent = message;
        
        const confirmBtn = document.getElementById('confirmActionBtn');
        confirmBtn.onclick = function() {
          hideConfirmation();
          if (typeof onConfirm === 'function') {
            onConfirm();
          }
        };
        
        document.getElementById('confirmationDialog').classList.add('show');
      }

      function hideConfirmation() {
        document.getElementById('confirmationDialog').classList.remove('show');
      }

      // ====== GOOGLE DRIVE UPLOAD FUNCTIONS ======
      
      // Konversi file ke base64
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // Upload ke Google Drive via Google Apps Script
async function uploadToGoogleDrive(file, context) {
  try {
    showNotification('info', 'Upload Gambar', 'Mengunggah ke Google Drive...', 0);
    
    // Convert file to base64
    const base64Data = await fileToBase64(file);
    const base64String = base64Data.split(',')[1]; // Remove data URL prefix
    
    // Generate filename
    const safeAgenda = (context.agenda || 'agenda')
      .replace(/[^a-z0-9]/gi, '_')
      .substring(0, 30);
    
    const safeMapel = (context.mapel || 'mapel')
      .replace(/[^a-z0-9]/gi, '_')
      .substring(0, 30);
    
    const timestamp = new Date().getTime();
    const extension = file.name.split('.').pop().toLowerCase();
    const fileName = `soal_${safeAgenda}_${safeMapel}_${context.noSoal}_${timestamp}.${extension}`;
    
    // Prepare request data
    const requestData = {
      base64Data: base64String,
      fileName: fileName,
      mimeType: file.type || 'image/jpeg'
    };
    
    console.log('Uploading to Google Apps Script:', GAS_WEB_APP_URL);
    
    // Send to Google Apps Script via fetch with CORS workaround
    const response = await fetch(GAS_WEB_APP_URL, {
      method: 'POST',
      mode: 'cors',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestData)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    
    if (result.success) {
      hideAllNotifications();
      showNotification('success', 'Upload Berhasil', 'Gambar berhasil diupload ke Google Drive!');
      
      // ‚úÖ PASTIKAN MENGEMBALIKAN thumbnailUrl DARI RESPONSE
      if (result.thumbnailUrl) {
        return result.thumbnailUrl; // Format: https://drive.google.com/thumbnail?id=...&sz=w1200
      } else {
        // Fallback jika thumbnailUrl tidak ada
        return result.directUrl || result.viewUrl || '';
      }
    } else {
      throw new Error(result.error || 'Upload gagal');
    }
    
  } catch (error) {
    console.error('Google Drive upload error:', error);
    
    // ‚ùå JANGAN gunakan base64 sebagai fallback
    // ‚ùå return base64Data; // HAPUS INI!
    
    // ‚úÖ Lebih baik kembalikan string kosong atau throw error
    hideAllNotifications();
    showNotification('error', 'Upload Gagal', 'Gagal mengupload gambar ke Google Drive. Silakan coba lagi.');
    
    // Atau throw error agar bisa ditangani di fungsi pemanggil
    throw new Error('Google Drive upload failed: ' + error.message);
    
    // Atau return empty string
    // return '';
  }
}

      // Preview image sebelum upload
      function previewImage(input) {
        const container = document.getElementById('imagePreviewContainer');
        container.innerHTML = '';
        
        if (input.files && input.files[0]) {
          const file = input.files[0];
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'image-preview';
            img.alt = 'Preview Gambar';
            
            container.appendChild(img);
          };
          
          reader.readAsDataURL(file);
        }
      }

      // ====== LOGIN FUNCTIONS ======
      function checkLoginStatus() {
        const loggedIn = sessionStorage.getItem('adminLoggedIn');
        
        if (loggedIn === 'true') {
          document.body.className = 'app-page';
          showApp();
        } else {
          document.body.className = 'login-page';
          showLogin();
        }
      }

      function handleLogin() {
        const username = document.getElementById('login_username').value;
        const password = document.getElementById('login_password').value;

        // Simple authentication (in production, use Firebase Auth)
        const validCredentials = [
          { user: 'Admin', pass: '290192' },
          { user: 'admin', pass: 'admin123' }
        ];
        
        const isValid = validCredentials.some(cred => 
          cred.user === username && cred.pass === password
        );
        
        if (isValid) {
          sessionStorage.setItem('adminLoggedIn', 'true');
          document.body.className = 'app-page';
          showApp();
          showNotification('success', 'Login Berhasil', 'Selamat datang di Portal Admin CBT 2026');
        } else {
          showNotification('error', 'Login Gagal', 'Username atau Password salah!');
          document.getElementById('login_password').value = '';
          document.getElementById('login_password').focus();
        }
      }

      function handleLogout() {
        showConfirmation(
          'Konfirmasi Logout',
          'Apakah Anda yakin ingin keluar dari sistem?',
          function() {
            sessionStorage.removeItem('adminLoggedIn');
            document.body.className = 'login-page';
            showLogin();
            showNotification('success', 'Logout Berhasil', 'Anda telah berhasil logout');
          }
        );
      }

      function showApp() {
        const loginSection = document.getElementById('login-section');
        const appShell = document.getElementById('app-shell');
        
        loginSection.style.display = 'none';
        appShell.style.display = 'block';
        
        // Initialize data
        loadPeserta();
        loadAgenda();
        loadAgendaListForPeserta();
        loadAgendaListForMapelDropdown();
        loadAgendaListForBankSoalDropdown();
        loadAgendaListForCetakKartuDropdown();
        loadMonitoring();
        loadAgendaListForCekJawaban();
        loadJawaban();
        showTab('peserta');
      }

      function showLogin() {
        const loginSection = document.getElementById('login-section');
        const appShell = document.getElementById('app-shell');
        
        loginSection.style.display = 'flex';
        appShell.style.display = 'none';
        
        // Reset form
        document.getElementById('login_username').value = '';
        document.getElementById('login_password').value = '';
      }

      // ====== TAB FUNCTIONS ======
      function showTab(tab) {
  const tabs = ['peserta', 'agenda', 'mapel', 'banksoal', 'monitoring', 'jawaban', 'cekjawabanmapel', 'cetakkartu'];
  tabs.forEach(name => {
    document.getElementById('tab-' + name).style.display =
      (tab === name) ? 'block' : 'none';
    document.getElementById('tab-btn-' + name).classList.toggle('active', tab === name);
  });
  
  // Jika pindah ke tab cek jawaban permapel, load data agenda
  if (tab === 'cekjawabanmapel') {
    loadAgendaListForCekJawaban();
  }
}

      // ====== PESERTA FUNCTIONS ======
      function generateNISFromNoWA(noWa) {
        if (!noWa) return '';
        let digits = noWa.replace(/\D/g, '');
        if (digits.startsWith('0')) {
          digits = digits.substring(1);
        } else if (digits.startsWith('62')) {
          digits = digits.substring(2);
        }
        return digits;
      }

      function handleNoWAChange() {
        const noWa = document.getElementById('No_WA_Peserta').value;
        const nis = generateNISFromNoWA(noWa);
        document.getElementById('NIS_Username').value = nis;
      }

      function loadPeserta() {
        if (!pesertaRef) return;
        
        pesertaRef.on('value', snapshot => {
          const tbody = document.querySelector('#pesertaTable tbody');
          tbody.innerHTML = '';
          pesertaNameMap = {};

          snapshot.forEach(childSnap => {
            const firebaseId = childSnap.key;
            const data = childSnap.val();
            if (data.NIS_Username) {
              pesertaNameMap[data.NIS_Username] = data.Nama_Peserta || data.NIS_Username;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${data.NIS_Username || ''}</td>
              <td>${data.Nama_Peserta || ''}</td>
              <td>
                <div class="password-wrapper" style="position: relative; display: inline-block; width: 120px;">
                  <input type="password" value="${data.Password || ''}" readonly 
                         style="width: 100%; padding-right: 30px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; padding: 4px 30px 4px 8px;">
                  <button type="button" class="toggle-password" onclick="togglePasswordVisibility(this.previousElementSibling, this)" 
                          style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; font-size: 11px; padding: 0;">
                    üëÅÔ∏è
                  </button>
                </div>
              </td>
              <td>${data.Jenjang_Studi || ''}</td>
              <td>${data.Kelas || ''}</td>
              <td>${data.Asal_Sekolah || ''}</td>
              <td>${data.No_WA_Peserta || ''}</td>
              <td>${data.No_WA_Ortu || ''}</td>
              <td class="actions">
                <button onclick="editPeserta('${firebaseId}')">Edit</button>
                <button onclick="deletePeserta('${firebaseId}')">Hapus</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }, error => {
          showNotification('error', 'Error', 'Gagal membaca data peserta: ' + error.message);
        });
      }

      function openPesertaModalForCreate() {
        resetForm();
        showModal('modal-peserta');
      }

      function savePeserta() {
        if (!pesertaRef) {
          showNotification('error', 'Error', 'Firebase tidak terinisialisasi');
          return;
        }

        const firebaseId = document.getElementById('firebaseId').value;
        const Nama_Peserta = document.getElementById('Nama_Peserta').value.trim();
        const Password = document.getElementById('Password').value.trim();
        const Jenjang_Studi = document.getElementById('Jenjang_Studi').value.trim();
        const Kelas = document.getElementById('Kelas').value.trim();
        const Asal_Sekolah = document.getElementById('Asal_Sekolah').value.trim();
        const No_WA_Peserta = document.getElementById('No_WA_Peserta').value.trim();
        const No_WA_Ortu = document.getElementById('No_WA_Ortu').value.trim();
        const ID_Agenda = document.getElementById('ID_Agenda_Peserta').value.trim();

        const NIS_Username = generateNISFromNoWA(No_WA_Peserta);
        document.getElementById('NIS_Username').value = NIS_Username;

        if (!Nama_Peserta || !Password || !Jenjang_Studi || !Kelas ||
            !Asal_Sekolah || !No_WA_Peserta || !No_WA_Ortu || !ID_Agenda || !NIS_Username) {
          showNotification('error', 'Validasi Error', 'Mohon lengkapi semua field');
          return;
        }

        const data = {
          NIS_Username,
          Nama_Peserta,
          Password,
          Jenjang_Studi,
          Kelas,
          Asal_Sekolah,
          No_WA_Peserta,
          No_WA_Ortu,
          ID_Agenda
        };

        if (firebaseId) {
          const existingId = document.getElementById('ID_Peserta').value || firebaseId;
          data.ID_Peserta = existingId;
          pesertaRef.child(firebaseId).update(data)
            .then(() => {
              showNotification('success', 'Berhasil', 'Data peserta berhasil diperbarui');
              resetForm();
              hideModal('modal-peserta');
            })
            .catch(err => {
              showNotification('error', 'Gagal', 'Gagal update peserta: ' + err.message);
            });
        } else {
          const newRef = pesertaRef.push();
          const newId = newRef.key;
          data.ID_Peserta = newId;
          newRef.set(data)
            .then(() => {
              showNotification('success', 'Berhasil', 'Data peserta berhasil disimpan');
              document.getElementById('ID_Peserta').value = newId;
              resetForm();
              hideModal('modal-peserta');
            })
            .catch(err => {
              showNotification('error', 'Gagal', 'Gagal menyimpan peserta: ' + err.message);
            });
        }
      }

      function editPeserta(firebaseId) {
        if (!pesertaRef) return;
        
        pesertaRef.child(firebaseId).once('value')
          .then(snapshot => {
            const data = snapshot.val();
            document.getElementById('firebaseId').value = firebaseId;
            document.getElementById('ID_Peserta').value = data.ID_Peserta || '';
            document.getElementById('NIS_Username').value = data.NIS_Username || '';
            document.getElementById('Nama_Peserta').value = data.Nama_Peserta || '';
            document.getElementById('Password').value = data.Password || '';
            document.getElementById('Jenjang_Studi').value = data.Jenjang_Studi || '';
            document.getElementById('Kelas').value = data.Kelas || '';
            document.getElementById('Asal_Sekolah').value = data.Asal_Sekolah || '';
            document.getElementById('No_WA_Peserta').value = data.No_WA_Peserta || '';
            document.getElementById('No_WA_Ortu').value = data.No_WA_Ortu || '';
            document.getElementById('ID_Agenda_Peserta').value = data.ID_Agenda || '';
            
            showModal('modal-peserta');
          })
          .catch(err => {
            showNotification('error', 'Gagal', 'Gagal mengambil data peserta: ' + err.message);
          });
      }

      function deletePeserta(firebaseId) {
        showConfirmation(
          'Hapus Peserta',
          'Apakah Anda yakin ingin menghapus data peserta ini?',
          function() {
            pesertaRef.child(firebaseId).remove()
              .then(() => {
                showNotification('success', 'Berhasil', 'Data peserta berhasil dihapus');
              })
              .catch(err => {
                showNotification('error', 'Gagal', 'Gagal menghapus peserta: ' + err.message);
              });
          }
        );
      }

      function resetForm() {
        document.getElementById('firebaseId').value = '';
        document.getElementById('pesertaForm').reset();
        document.getElementById('ID_Peserta').value = '';
        document.getElementById('NIS_Username').value = '';
      }

      // ====== AGENDA FUNCTIONS ======
      function generateRandomToken() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        const length = 6 + Math.floor(Math.random() * 3);
        let token = '';
        for (let i = 0; i < length; i++) {
          token += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return token;
      }

      function generateTokenUjian() {
        const token = generateRandomToken();
        document.getElementById('Token_Ujian').value = token;
      }

      function loadAgenda() {
        if (!agendaRef) return;
        
        agendaRef.on('value', snapshot => {
          const tbody = document.querySelector('#agendaTable tbody');
          tbody.innerHTML = '';
          agendaCache = {};
          
          snapshot.forEach(childSnap => {
            const firebaseId = childSnap.key;
            const data = childSnap.val();
            agendaCache[firebaseId] = data;
            
            const mulai = data.TglJam_Mulai ? data.TglJam_Mulai.replace('T', ' ') : '';
            const selesai = data.TglJam_Selesai ? data.TglJam_Selesai.replace('T', ' ') : '';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${data.Agenda_Ujian || ''}</td>
              <td>${data.Deskripsi_Ujian || ''}</td>
              <td>${data.Jenjang_Studi || ''}</td>
              <td>${data.Jenis_Tes || ''}</td>
              <td>${mulai}</td>
              <td>${selesai}</td>
              <td>${data.Token_Ujian || ''}</td>
              <td class="actions">
                <button onclick="editAgenda('${firebaseId}')">Edit</button>
                <button onclick="deleteAgenda('${firebaseId}')">Hapus</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }, error => {
          showNotification('error', 'Error', 'Gagal membaca data agenda: ' + error.message);
        });
      }

      function loadAgendaListForPeserta() {
        const select = document.getElementById('ID_Agenda_Peserta');
        if (!agendaRef) return;
        
        agendaRef.on('value', snapshot => {
          const currentValue = select.value;
          select.innerHTML = '<option value="">-- Pilih Agenda --</option>';
          
          snapshot.forEach(childSnap => {
            const id = childSnap.key;
            const ag = childSnap.val();
            const opt = document.createElement('option');
            opt.value = id;
            let label = ag.Agenda_Ujian || id;
            if (ag.Jenjang_Studi) label += ' (' + ag.Jenjang_Studi + ')';
            opt.textContent = label;
            select.appendChild(opt);
          });
          
          if (currentValue) select.value = currentValue;
        });
      }

      function loadAgendaListForMapelDropdown() {
        const select = document.getElementById('Mapel_Agenda_Select');
        if (!agendaRef) return;
        
        agendaRef.on('value', snapshot => {
          const currentValue = select.value;
          select.innerHTML = '<option value="">-- Pilih Agenda Ujian dulu --</option>';
          
          snapshot.forEach(childSnap => {
            const id = childSnap.key;
            const ag = childSnap.val();
            const opt = document.createElement('option');
            opt.value = id;
            let label = ag.Agenda_Ujian || id;
            if (ag.Jenjang_Studi) label += ' (' + ag.Jenjang_Studi + ')';
            opt.textContent = label;
            select.appendChild(opt);
          });
          
          if (currentValue) select.value = currentValue;
        });
      }

      function loadAgendaListForBankSoalDropdown() {
        const select = document.getElementById('Bank_Agenda_Select');
        if (!agendaRef) return;
        
        agendaRef.on('value', snapshot => {
          const currentValue = select.value;
          select.innerHTML = '<option value="">-- Pilih Agenda Ujian dulu --</option>';
          
          snapshot.forEach(childSnap => {
            const id = childSnap.key;
            const ag = childSnap.val();
            const opt = document.createElement('option');
            opt.value = id;
            let label = ag.Agenda_Ujian || id;
            if (ag.Jenjang_Studi) label += ' (' + ag.Jenjang_Studi + ')';
            opt.textContent = label;
            select.appendChild(opt);
          });
          
          if (currentValue) select.value = currentValue;
        });
      }

      function loadAgendaListForCetakKartuDropdown() {
        const select = document.getElementById('CetakKartu_Agenda_Select');
        if (!agendaRef) return;
        
        agendaRef.on('value', snapshot => {
          const currentValue = select.value;
          select.innerHTML = '<option value="">-- Pilih Agenda Ujian dulu --</option>';
          
          snapshot.forEach(childSnap => {
            const id = childSnap.key;
            const ag = childSnap.val();
            const opt = document.createElement('option');
            opt.value = id;
            let label = ag.Agenda_Ujian || id;
            if (ag.Jenjang_Studi) label += ' (' + ag.Jenjang_Studi + ')';
            opt.textContent = label;
            select.appendChild(opt);
          });
          
          if (currentValue) select.value = currentValue;
        });
      }

      function openAgendaModalForCreate() {
        resetAgendaForm();
        showModal('modal-agenda');
      }

      function saveAgenda() {
        if (!agendaRef) {
          showNotification('error', 'Error', 'Firebase tidak terinisialisasi');
          return;
        }

        const firebaseAgendaId = document.getElementById('firebaseAgendaId').value;
        const Agenda_Ujian = document.getElementById('Agenda_Ujian').value.trim();
        const Deskripsi_Ujian = document.getElementById('Deskripsi_Ujian').value.trim();
        const Jenjang_Studi = document.getElementById('Jenjang_Studi_Agenda').value.trim();
        const Jenis_Tes = document.getElementById('Jenis_Tes').value.trim();
        const TglJam_Mulai = document.getElementById('TglJam_Mulai').value;
        const TglJam_Selesai = document.getElementById('TglJam_Selesai').value;
        let Token_Ujian = document.getElementById('Token_Ujian').value.trim().toUpperCase();

        if (!Agenda_Ujian || !Deskripsi_Ujian || !Jenjang_Studi || !Jenis_Tes || !TglJam_Mulai || !TglJam_Selesai) {
          showNotification('error', 'Validasi Error', 'Mohon lengkapi semua field agenda ujian');
          return;
        }

        Token_Ujian = Token_Ujian.replace(/[^A-Z0-9]/g, '');
        if (Token_Ujian.length < 6 || Token_Ujian.length > 8) {
          Token_Ujian = generateRandomToken();
        }
        document.getElementById('Token_Ujian').value = Token_Ujian;

        const data = {
          Agenda_Ujian,
          Deskripsi_Ujian,
          Jenjang_Studi,
          Jenis_Tes,
          TglJam_Mulai,
          TglJam_Selesai,
          Token_Ujian
        };

        if (firebaseAgendaId) {
          const existingId = document.getElementById('ID_Agenda_Agenda').value || firebaseAgendaId;
          data.ID_Agenda = existingId;
          agendaRef.child(firebaseAgendaId).update(data)
            .then(() => {
              showNotification('success', 'Berhasil', 'Agenda ujian berhasil diperbarui');
              resetAgendaForm();
              hideModal('modal-agenda');
            })
            .catch(err => {
              showNotification('error', 'Gagal', 'Gagal update agenda: ' + err.message);
            });
        } else {
          const newRef = agendaRef.push();
          const newId = newRef.key;
          data.ID_Agenda = newId;
          newRef.set(data)
            .then(() => {
              showNotification('success', 'Berhasil', 'Agenda ujian berhasil disimpan');
              document.getElementById('ID_Agenda_Agenda').value = newId;
              resetAgendaForm();
              hideModal('modal-agenda');
            })
            .catch(err => {
              showNotification('error', 'Gagal', 'Gagal menyimpan agenda: ' + err.message);
            });
        }
      }

      function editAgenda(firebaseAgendaId) {
        if (!agendaRef) return;
        
        agendaRef.child(firebaseAgendaId).once('value')
          .then(snapshot => {
            const data = snapshot.val();
            document.getElementById('firebaseAgendaId').value = firebaseAgendaId;
            document.getElementById('ID_Agenda_Agenda').value = data.ID_Agenda || '';
            document.getElementById('Agenda_Ujian').value = data.Agenda_Ujian || '';
            document.getElementById('Deskripsi_Ujian').value = data.Deskripsi_Ujian || '';
            document.getElementById('Jenjang_Studi_Agenda').value = data.Jenjang_Studi || '';
            document.getElementById('Jenis_Tes').value = data.Jenis_Tes || '';
            document.getElementById('TglJam_Mulai').value = data.TglJam_Mulai || '';
            document.getElementById('TglJam_Selesai').value = data.TglJam_Selesai || '';
            document.getElementById('Token_Ujian').value = data.Token_Ujian || '';
            
            showModal('modal-agenda');
          })
          .catch(err => {
            showNotification('error', 'Gagal', 'Gagal mengambil data agenda: ' + err.message);
          });
      }

      function deleteAgenda(firebaseAgendaId) {
        showConfirmation(
          'Hapus Agenda',
          'Apakah Anda yakin ingin menghapus agenda ujian ini?',
          function() {
            agendaRef.child(firebaseAgendaId).remove()
              .then(() => {
                showNotification('success', 'Berhasil', 'Agenda ujian berhasil dihapus');
              })
              .catch(err => {
                showNotification('error', 'Gagal', 'Gagal menghapus agenda: ' + err.message);
              });
          }
        );
      }

      function resetAgendaForm() {
        document.getElementById('firebaseAgendaId').value = '';
        document.getElementById('agendaForm').reset();
        document.getElementById('ID_Agenda_Agenda').value = '';
        document.getElementById('Token_Ujian').value = '';
      }

      // ====== MATA PELAJARAN FUNCTIONS ======
      function onChangeAgendaMapel() {
        currentAgendaForMapel = document.getElementById('Mapel_Agenda_Select').value;
        document.getElementById('ID_Agenda_Mapel').value = currentAgendaForMapel || '';
        resetMapelForm(false);
        loadMapelTable();
      }

      function loadMapelTable() {
        const tbody = document.querySelector('#mapelTable tbody');
        tbody.innerHTML = '';
        
        if (!currentAgendaForMapel || !mapelRef) return;
        
        mapelRef.orderByChild('ID_Agenda').equalTo(currentAgendaForMapel).once('value')
          .then(snapshot => {
            snapshot.forEach(childSnap => {
              const firebaseId = childSnap.key;
              const data = childSnap.val();
              const isSiap = data.Status_Mapel === 'Siap';
              
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${data.Nama_Mata_Pelajaran || ''}</td>
                <td>${data.Jumlah_Soal || ''}</td>
                <td>${data.Durasi_Ujian || ''}</td>
                <td>
                  <label style="display:flex; align-items:center; gap:4px; font-weight:400;">
                    <input type="checkbox" ${isSiap ? 'checked' : ''} 
                           onchange="toggleStatusMapel('${firebaseId}', this.checked)">
                    <span>${isSiap ? 'Siap' : 'Draft'}</span>
                  </label>
                </td>
                <td class="actions">
                  <button onclick="editMapel('${firebaseId}')">Edit</button>
                  <button onclick="deleteMapel('${firebaseId}')">Hapus</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          })
          .catch(err => {
            showNotification('error', 'Error', 'Gagal membaca data mapel: ' + err.message);
          });
      }

      function openMapelModalForCreate() {
        if (!currentAgendaForMapel) {
          showNotification('error', 'Error', 'Pilih Agenda Ujian terlebih dahulu');
          return;
        }
        resetMapelForm(false);
        showModal('modal-mapel');
      }

      function saveMapel() {
        if (!mapelRef) {
          showNotification('error', 'Error', 'Firebase tidak terinisialisasi');
          return;
        }

        const firebaseMapelId = document.getElementById('firebaseMapelId').value;
        const ID_Agenda = currentAgendaForMapel;
        
        if (!ID_Agenda) {
          showNotification('error', 'Error', 'Pilih Agenda Ujian terlebih dahulu');
          return;
        }
        
        const Nama_Mata_Pelajaran = document.getElementById('Nama_Mata_Pelajaran').value.trim();
        const Jumlah_Soal = document.getElementById('Jumlah_Soal').value.trim();
        const Durasi_Ujian = document.getElementById('Durasi_Ujian').value.trim();
        let Status_Mapel = document.getElementById('Status_Mapel').value || 'Draft';

        if (!Nama_Mata_Pelajaran || !Jumlah_Soal || !Durasi_Ujian) {
          showNotification('error', 'Validasi Error', 'Mohon lengkapi semua field mata pelajaran');
          return;
        }
        
        const data = {
          ID_Agenda,
          Nama_Mata_Pelajaran,
          Jumlah_Soal,
          Durasi_Ujian,
          Status_Mapel
        };
        
        if (firebaseMapelId) {
          const existingId = document.getElementById('ID_Mapel_Mapel').value || firebaseMapelId;
          data.ID_Mapel = existingId;
          mapelRef.child(firebaseMapelId).update(data)
            .then(() => {
              showNotification('success', 'Berhasil', 'Mata pelajaran berhasil diperbarui');
              resetMapelForm(false);
              loadMapelTable();
              hideModal('modal-mapel');
            })
            .catch(err => {
              showNotification('error', 'Gagal', 'Gagal update mapel: ' + err.message);
            });
        } else {
          const newRef = mapelRef.push();
          const newId = newRef.key;
          data.ID_Mapel = newId;
          newRef.set(data)
            .then(() => {
              showNotification('success', 'Berhasil', 'Mata pelajaran berhasil disimpan');
              document.getElementById('ID_Mapel_Mapel').value = newId;
              resetMapelForm(false);
              loadMapelTable();
              hideModal('modal-mapel');
            })
            .catch(err => {
              showNotification('error', 'Gagal', 'Gagal menyimpan mapel: ' + err.message);
            });
        }
      }

      function editMapel(firebaseMapelId) {
        if (!mapelRef) return;
        
        mapelRef.child(firebaseMapelId).once('value')
          .then(snapshot => {
            const data = snapshot.val();
            document.getElementById('firebaseMapelId').value = firebaseMapelId;
            currentAgendaForMapel = data.ID_Agenda || '';
            document.getElementById('Mapel_Agenda_Select').value = currentAgendaForMapel;
            document.getElementById('ID_Agenda_Mapel').value = currentAgendaForMapel;
            document.getElementById('ID_Mapel_Mapel').value = data.ID_Mapel || '';
            document.getElementById('Nama_Mata_Pelajaran').value = data.Nama_Mata_Pelajaran || '';
            document.getElementById('Jumlah_Soal').value = data.Jumlah_Soal || '';
            document.getElementById('Durasi_Ujian').value = data.Durasi_Ujian || '';
            document.getElementById('Status_Mapel').value = data.Status_Mapel || 'Draft';
            
            showModal('modal-mapel');
          })
          .catch(err => {
            showNotification('error', 'Gagal', 'Gagal mengambil data mapel: ' + err.message);
          });
      }

      function deleteMapel(firebaseMapelId) {
        showConfirmation(
          'Hapus Mata Pelajaran',
          'Apakah Anda yakin ingin menghapus mata pelajaran ini?',
          function() {
            mapelRef.child(firebaseMapelId).remove()
              .then(() => {
                showNotification('success', 'Berhasil', 'Mata pelajaran berhasil dihapus');
                loadMapelTable();
              })
              .catch(err => {
                showNotification('error', 'Gagal', 'Gagal menghapus mapel: ' + err.message);
              });
          }
        );
      }

      function toggleStatusMapel(firebaseMapelId, isSiap) {
        if (!mapelRef) return;
        
        const newStatus = isSiap ? 'Siap' : 'Draft';
        mapelRef.child(firebaseMapelId).update({ Status_Mapel: newStatus })
          .then(() => {
            loadMapelTable();
          })
          .catch(err => {
            showNotification('error', 'Gagal', 'Gagal mengubah status mapel: ' + err.message);
          });
      }

      function resetMapelForm(resetAgenda = true) {
        document.getElementById('firebaseMapelId').value = '';
        document.getElementById('mapelForm').reset();
        document.getElementById('ID_Mapel_Mapel').value = '';
        document.getElementById('Status_Mapel').value = 'Draft';
        
        if (resetAgenda) {
          currentAgendaForMapel = '';
          document.getElementById('Mapel_Agenda_Select').value = '';
          document.getElementById('ID_Agenda_Mapel').value = '';
        } else {
          document.getElementById('ID_Agenda_Mapel').value = currentAgendaForMapel || '';
        }
      }

      // ====== BANK SOAL FUNCTIONS ======
      function onTypeSoalChange() {
        const type = document.getElementById('Type_Soal').value;
        const pg = document.getElementById('group-pg');
        const perny = document.getElementById('group-pernyataan');
        const pejodohan = document.getElementById('group-pejodohan');
        
        pg.style.display = 'none';
        perny.style.display = 'none';
        pejodohan.style.display = 'none';

        if (type === 'Pilihan Ganda Tunggal' || type === 'Pilihan Ganda Kompleks') {
          pg.style.display = 'block';
        } else if (type === 'Pilihan Benar/Salah' || type === 'Pilihan Setuju/Tidak') {
          perny.style.display = 'block';
        } else if (type === 'Pilihan Pejodohan') {
          pejodohan.style.display = 'block';
        }
      }

      function setAutoNoSoal() {
        if (!currentAgendaForBank || !bankSoalRef) return;
        
        bankSoalRef.orderByChild('ID_Agenda').equalTo(currentAgendaForBank).once('value')
          .then(snapshot => {
            let maxNo = 0;
            snapshot.forEach(childSnap => {
              const d = childSnap.val();
              const n = parseInt(d.No_Soal, 10);
              if (!isNaN(n) && n > maxNo) maxNo = n;
            });
            document.getElementById('No_Soal').value = maxNo + 1;
          })
          .catch(err => {
            console.error('Gagal menghitung No_Soal:', err);
          });
      }

      function onChangeAgendaBankSoal() {
        currentAgendaForBank = document.getElementById('Bank_Agenda_Select').value;
        document.getElementById('ID_Agenda_Bank').value = currentAgendaForBank || '';
        currentMapelForBank = '';
        document.getElementById('Bank_Mapel_Select').innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
        document.getElementById('ID_Mapel_Bank').value = '';
        document.getElementById('Nama_Mata_Pelajaran_Bank').value = '';
        document.querySelector('#bankSoalTable tbody').innerHTML = '';
        document.getElementById('No_Soal').value = '';
        
        if (!currentAgendaForBank || !mapelRef) return;
        
        const select = document.getElementById('Bank_Mapel_Select');
        mapelRef.orderByChild('ID_Agenda').equalTo(currentAgendaForBank).once('value')
          .then(snapshot => {
            snapshot.forEach(childSnap => {
              const id = childSnap.key;
              const data = childSnap.val();
              const opt = document.createElement('option');
              opt.value = id;
              opt.textContent = data.Nama_Mata_Pelajaran || id;
              opt.dataset.nama = data.Nama_Mata_Pelajaran || '';
              select.appendChild(opt);
            });
          })
          .catch(err => {
            showNotification('error', 'Error', 'Gagal membaca mapel: ' + err.message);
          });
      }

      function onChangeMapelBankSoal() {
        const select = document.getElementById('Bank_Mapel_Select');
        currentMapelForBank = select.value;
        document.getElementById('ID_Mapel_Bank').value = currentMapelForBank || '';
        
        let nama = '';
        if (select && select.selectedIndex >= 0) {
          const opt = select.options[select.selectedIndex];
          if (opt && opt.dataset) nama = opt.dataset.nama || '';
        }
        
        document.getElementById('Nama_Mata_Pelajaran_Bank').value = nama;
        resetBankSoalForm(false);
        loadBankSoalTable();
      }

      function loadBankSoalTable() {
        const tbody = document.querySelector('#bankSoalTable tbody');
        tbody.innerHTML = '';
        
        if (!currentMapelForBank || !bankSoalRef) return;
        
        bankSoalRef.orderByChild('ID_Mapel').equalTo(currentMapelForBank).once('value')
          .then(snapshot => {
            const list = [];
            snapshot.forEach(childSnap => {
              const data = childSnap.val();
              list.push({ id: childSnap.key, ...data });
            });
            
            list.sort((a, b) => Number(a.No_Soal || 0) - Number(b.No_Soal || 0));
            
            list.forEach(item => {
              const tr = document.createElement('tr');
              const pertSingkat = (item.Pertanyaan || '').length > 80
                ? item.Pertanyaan.substring(0, 80) + '...'
                : (item.Pertanyaan || '');
              
              const gambarCell = item.Gambar
                ? `<a href="${item.Gambar}" target="_blank" title="Lihat gambar">üì∑</a>` : '';
              
              tr.innerHTML = `
                <td><input type="checkbox" class="banksoal-checkbox" value="${item.id}"></td>
                <td>${item.No_Soal || ''}</td>
                <td>${item.Type_Soal || ''}</td>
                <td>${pertSingkat}</td>
                <td>${gambarCell}</td>
                <td class="actions">
                  <button onclick="editSoal('${item.id}')">Edit</button>
                  <button onclick="deleteSoal('${item.id}')">Hapus</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          })
          .catch(err => {
            showNotification('error', 'Error', 'Gagal membaca bank soal: ' + err.message);
          });
      }

      function toggleSelectAllBankSoal(src) {
        const cbs = document.querySelectorAll('.banksoal-checkbox');
        cbs.forEach(cb => cb.checked = src.checked);
      }

      function selectAllBankSoal() {
        const cbs = document.querySelectorAll('.banksoal-checkbox');
        cbs.forEach(cb => cb.checked = true);
        document.getElementById('bankSoal_select_all').checked = true;
      }

      function deselectAllBankSoal() {
        const cbs = document.querySelectorAll('.banksoal-checkbox');
        cbs.forEach(cb => cb.checked = false);
        document.getElementById('bankSoal_select_all').checked = false;
      }

      function deleteSelectedBankSoal() {
        const checked = document.querySelectorAll('.banksoal-checkbox:checked');
        if (!checked.length) {
          showNotification('warning', 'Peringatan', 'Pilih soal yang akan dihapus');
          return;
        }
        
        showConfirmation(
          'Hapus Soal Terpilih',
          `Yakin akan menghapus ${checked.length} soal terpilih?`,
          function() {
            const promises = [];
            checked.forEach(cb => {
              promises.push(bankSoalRef.child(cb.value).remove());
            });
            
            Promise.all(promises)
              .then(() => {
                showNotification('success', 'Berhasil', `${checked.length} soal berhasil dihapus`);
                loadBankSoalTable();
              })
              .catch(err => {
                showNotification('error', 'Gagal', 'Gagal menghapus soal: ' + err.message);
              });
          }
        );
      }

      function deleteAllBankSoal() {
        if (!currentMapelForBank) {
          showNotification('error', 'Error', 'Pilih mata pelajaran terlebih dahulu');
          return;
        }
        
        showConfirmation(
          'Hapus Semua Soal',
          'Yakin akan menghapus SEMUA soal pada mata pelajaran ini? Tindakan ini tidak dapat dibatalkan!',
          function() {
            bankSoalRef.orderByChild('ID_Mapel').equalTo(currentMapelForBank).once('value')
              .then(snapshot => {
                const promises = [];
                let count = 0;
                
                snapshot.forEach(childSnap => {
                  promises.push(bankSoalRef.child(childSnap.key).remove());
                  count++;
                });
                
                if (count === 0) {
                  showNotification('info', 'Info', 'Tidak ada soal untuk dihapus');
                  return;
                }
                
                Promise.all(promises)
                  .then(() => {
                    showNotification('success', 'Berhasil', `${count} soal berhasil dihapus`);
                    loadBankSoalTable();
                  })
                  .catch(err => {
                    showNotification('error', 'Gagal', 'Gagal menghapus soal: ' + err.message);
                  });
              })
              .catch(err => {
                showNotification('error', 'Gagal', 'Gagal membaca data soal: ' + err.message);
              });
          }
        );
      }

      function openBankSoalModalForCreate() {
        if (!currentAgendaForBank || !currentMapelForBank) {
          showNotification('error', 'Error', 'Pilih Agenda Ujian dan Mata Pelajaran terlebih dahulu');
          return;
        }
        resetBankSoalForm(false);
        showModal('modal-banksoal');
      }

async function saveSoal() {
  if (!currentAgendaForBank || !currentMapelForBank) {
    showNotification('error', 'Error', 'Pilih Agenda Ujian dan Mata Pelajaran terlebih dahulu');
    return;
  }
  
  try {
    const firebaseSoalId = document.getElementById('firebaseSoalId').value;
    const ID_Agenda = currentAgendaForBank;
    const ID_Mapel = currentMapelForBank;
    const Nama_Mata_Pelajaran = document.getElementById('Nama_Mata_Pelajaran_Bank').value || '';
    const No_Soal = document.getElementById('No_Soal').value.trim();
    const Pertanyaan = document.getElementById('Pertanyaan').value.trim();
    const Type_Soal = document.getElementById('Type_Soal').value;
    
    if (!No_Soal || !Pertanyaan || !Type_Soal) {
      showNotification('error', 'Validasi Error', 'No Soal, Pertanyaan, dan Type Soal wajib diisi');
      return;
    }
    
    // Prepare data
    const data = {
      ID_Agenda: ID_Agenda,
      ID_Mapel: ID_Mapel,
      Nama_Mata_Pelajaran: Nama_Mata_Pelajaran,
      No_Soal: No_Soal,
      Pertanyaan: Pertanyaan,
      Type_Soal: Type_Soal,
      Pilihan_A: document.getElementById('Pilihan_A').value.trim(),
      Pilihan_B: document.getElementById('Pilihan_B').value.trim(),
      Pilihan_C: document.getElementById('Pilihan_C').value.trim(),
      Pilihan_D: document.getElementById('Pilihan_D').value.trim(),
      Pilihan_E: document.getElementById('Pilihan_E').value.trim()
    };
    
    // Add pernyataan data
    for (let i = 1; i <= 10; i++) {
      data['Pernyataan_' + i] = document.getElementById('Pernyataan_' + i)?.value.trim() || '';
    }
    
    // Add pejodohan data
    for (let j = 1; j <= 10; j++) {
      data['Pasangan_kiri_' + j] = document.getElementById('Pasangan_kiri_' + j)?.value.trim() || '';
      data['Pasangan_kanan_' + j] = document.getElementById('Pasangan_kanan_' + j)?.value.trim() || '';
    }
    
    // Handle image upload
    const fileInput = document.getElementById('Gambar');
    const file = fileInput.files[0];
    const existingUrl = document.getElementById('Gambar_Url').value || '';
    
    // ‚úÖ PERBAIKAN: Handle gambar dengan benar
    if (file) {
      try {
        showNotification('info', 'Upload Gambar', 'Sedang mengupload gambar...', 0);
        
        const context = {
          agenda: Nama_Mata_Pelajaran,
          mapel: ID_Mapel,
          noSoal: No_Soal
        };
        
        // Upload gambar ke Google Drive
        const imageUrl = await uploadToGoogleDrive(file, context);
        
        // ‚úÖ PASTIKAN imageUrl adalah link Google Drive
        if (imageUrl && imageUrl.startsWith('https://')) {
          data.Gambar = imageUrl; // Link Google Drive
        } else {
          // Jika bukan link valid, kosongkan
          data.Gambar = '';
          showNotification('warning', 'Peringatan', 'Gambar tidak berhasil diupload. Soal akan disimpan tanpa gambar.');
        }
      } catch (uploadError) {
        console.error('Image upload failed:', uploadError);
        data.Gambar = ''; // Kosongkan jika upload gagal
        showNotification('error', 'Upload Gagal', 'Gagal mengupload gambar. Soal disimpan tanpa gambar.');
      }
    } else {
      // Jika tidak ada file baru, gunakan existing URL
      data.Gambar = existingUrl;
    }
    
    // Save to Firebase
    if (firebaseSoalId) {
      await bankSoalRef.child(firebaseSoalId).update(data);
      showNotification('success', 'Berhasil', 'Soal berhasil diperbarui');
    } else {
      await bankSoalRef.push(data);
      showNotification('success', 'Berhasil', 'Soal berhasil disimpan');
    }
    
    resetBankSoalForm(false);
    loadBankSoalTable();
    hideModal('modal-banksoal');
    
  } catch (error) {
    console.error('Save soal error:', error);
    showNotification('error', 'Gagal', 'Gagal menyimpan soal: ' + error.message);
  } finally {
    hideAllNotifications();
  }
}
function editSoal(firebaseSoalId) {
  if (!bankSoalRef) return;
  
  bankSoalRef.child(firebaseSoalId).once('value')
    .then(snapshot => {
      const data = snapshot.val();
      document.getElementById('firebaseSoalId').value = firebaseSoalId;
      currentAgendaForBank = data.ID_Agenda || '';
      currentMapelForBank = data.ID_Mapel || '';
      
      document.getElementById('ID_Agenda_Bank').value = currentAgendaForBank;
      document.getElementById('ID_Mapel_Bank').value = currentMapelForBank;
      document.getElementById('Nama_Mata_Pelajaran_Bank').value = data.Nama_Mata_Pelajaran || '';
      document.getElementById('No_Soal').value = data.No_Soal || '';
      document.getElementById('Pertanyaan').value = data.Pertanyaan || '';
      document.getElementById('Type_Soal').value = data.Type_Soal || '';
      document.getElementById('Gambar_Url').value = data.Gambar || '';
      
      // Set image preview if exists
      const container = document.getElementById('imagePreviewContainer');
      container.innerHTML = '';
      
      if (data.Gambar) {
        // ‚úÖ CEK APAKAH INI LINK GOOGLE DRIVE ATAU BASE64
        if (data.Gambar.startsWith('https://drive.google.com/thumbnail')) {
          // Ini link Google Drive
          const img = document.createElement('img');
          img.src = data.Gambar;
          img.className = 'image-preview';
          img.alt = 'Gambar Soal';
          container.appendChild(img);
          
          // Tambahkan info link
          const link = document.createElement('a');
          link.href = data.Gambar;
          link.target = '_blank';
          link.textContent = 'Buka di Google Drive';
          link.style.display = 'block';
          link.style.marginTop = '5px';
          link.style.fontSize = '11px';
          container.appendChild(link);
        } else if (data.Gambar.startsWith('data:image')) {
          // Ini base64 (old data)
          const img = document.createElement('img');
          img.src = data.Gambar;
          img.className = 'image-preview';
          img.alt = 'Gambar Soal (Base64)';
          container.appendChild(img);
          
          // Info bahwa ini base64
          const info = document.createElement('div');
          info.textContent = '‚ö† Gambar dalam format base64 (perlu diupload ulang)';
          info.style.fontSize = '11px';
          info.style.color = '#f59e0b';
          info.style.marginTop = '5px';
          container.appendChild(info);
        }
      }
            
            // Set pilihan data
            document.getElementById('Pilihan_A').value = data.Pilihan_A || '';
            document.getElementById('Pilihan_B').value = data.Pilihan_B || '';
            document.getElementById('Pilihan_C').value = data.Pilihan_C || '';
            document.getElementById('Pilihan_D').value = data.Pilihan_D || '';
            document.getElementById('Pilihan_E').value = data.Pilihan_E || '';
            
            // Set pernyataan data
            for (let i = 1; i <= 10; i++) {
              const el = document.getElementById('Pernyataan_' + i);
              if (el) el.value = data['Pernyataan_' + i] || '';
            }
            
            // Set pejodohan data
            for (let i = 1; i <= 10; i++) {
              const lk = document.getElementById('Pasangan_kiri_' + i);
              const rk = document.getElementById('Pasangan_kanan_' + i);
              if (lk) lk.value = data['Pasangan_kiri_' + i] || '';
              if (rk) rk.value = data['Pasangan_kanan_' + i] || '';
            }
            
            // Update dropdowns
            document.getElementById('Bank_Agenda_Select').value = currentAgendaForBank;
            
            // Update mapel dropdown
            const mpSelect = document.getElementById('Bank_Mapel_Select');
            if (mapelRef) {
              mapelRef.orderByChild('ID_Agenda').equalTo(currentAgendaForBank).once('value')
                .then(snap => {
                  mpSelect.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
                  snap.forEach(child => {
                    const id = child.key;
                    const d = child.val();
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = d.Nama_Mata_Pelajaran || id;
                    opt.dataset.nama = d.Nama_Mata_Pelajaran || '';
                    mpSelect.appendChild(opt);
                  });
                  mpSelect.value = currentMapelForBank;
                });
            }
            
            onTypeSoalChange();
            showModal('modal-banksoal');
            
          })
          .catch(err => {
            showNotification('error', 'Gagal', 'Gagal mengambil soal: ' + err.message);
          });
      }

      function deleteSoal(firebaseSoalId) {
        showConfirmation(
          'Hapus Soal',
          'Apakah Anda yakin ingin menghapus soal ini?',
          function() {
            bankSoalRef.child(firebaseSoalId).remove()
              .then(() => {
                showNotification('success', 'Berhasil', 'Soal berhasil dihapus');
                loadBankSoalTable();
              })
              .catch(err => {
                showNotification('error', 'Gagal', 'Gagal menghapus soal: ' + err.message);
              });
          }
        );
      }

      function resetBankSoalForm(resetContext = true) {
        document.getElementById('firebaseSoalId').value = '';
        document.getElementById('Gambar_Url').value = '';
        document.getElementById('Gambar').value = '';
        document.getElementById('imagePreviewContainer').innerHTML = '';
        
        if (resetContext) {
          document.getElementById('bankSoalForm').reset();
          onTypeSoalChange();
          currentAgendaForBank = '';
          currentMapelForBank = '';
          document.getElementById('Bank_Agenda_Select').value = '';
          document.getElementById('Bank_Mapel_Select').innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
          document.getElementById('ID_Agenda_Bank').value = '';
          document.getElementById('ID_Mapel_Bank').value = '';
          document.getElementById('Nama_Mata_Pelajaran_Bank').value = '';
          document.querySelector('#bankSoalTable tbody').innerHTML = '';
          document.getElementById('No_Soal').value = '';
        } else {
          document.getElementById('Pertanyaan').value = '';
          document.getElementById('Type_Soal').value = '';
          document.getElementById('Pilihan_A').value = '';
          document.getElementById('Pilihan_B').value = '';
          document.getElementById('Pilihan_C').value = '';
          document.getElementById('Pilihan_D').value = '';
          document.getElementById('Pilihan_E').value = '';
          
          for (let i = 1; i <= 10; i++) {
            const el = document.getElementById('Pernyataan_' + i);
            if (el) el.value = '';
          }
          
          for (let i = 1; i <= 10; i++) {
            const lk = document.getElementById('Pasangan_kiri_' + i);
            const rk = document.getElementById('Pasangan_kanan_' + i);
            if (lk) lk.value = '';
            if (rk) rk.value = '';
          }
          
          onTypeSoalChange();
          document.getElementById('ID_Agenda_Bank').value = currentAgendaForBank || '';
          document.getElementById('ID_Mapel_Bank').value = currentMapelForBank || '';
          setAutoNoSoal();
        }
      }

      // ====== MONITORING FUNCTIONS ======
      function loadMonitoring() {
        if (!monitoringRef) return;
        
        monitoringRef.orderByChild('TglJam_Mulai').on('value', snapshot => {
          const tbody = document.querySelector('#monitoringTable tbody');
          tbody.innerHTML = '';
          
          const dataArray = [];
          snapshot.forEach(childSnap => {
            const id = childSnap.key;
            const data = childSnap.val();
            dataArray.push({ id, data });
          });
          
          dataArray.sort((a, b) => {
            const dateA = new Date(a.data.TglJam_Mulai || 0);
            const dateB = new Date(b.data.TglJam_Mulai || 0);
            return dateB - dateA;
          });
          
          dataArray.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><input type="checkbox" class="monitoring-checkbox" value="${item.id}"></td>
              <td>${item.data.NIS_Username || ''}</td>
              <td>${item.data.Nama_Peserta || ''}</td>
              <td>${item.data.Aktivitas_Login || ''}</td>
              <td>${item.data.Judul_Ujian || ''}</td>
              <td>${item.data.Mata_Pelajaran || ''}</td>
              <td>${item.data.Status_Pengerjaan || ''}</td>
              <td>${item.data.TglJam_Mulai || ''}</td>
              <td>${item.data.Last_Update || ''}</td>
              <td>${item.data.TglJam_Selesai || ''}</td>
            `;
            tbody.appendChild(tr);
          });
        }, error => {
          showNotification('error', 'Error', 'Gagal membaca Monitoring: ' + error.message);
        });
      }

      function toggleSelectAllMonitoring(src) {
        const cbs = document.querySelectorAll('.monitoring-checkbox');
        cbs.forEach(cb => cb.checked = src.checked);
      }

      function deleteSelectedMonitoring() {
        const checked = document.querySelectorAll('.monitoring-checkbox:checked');
        if (!checked.length) {
          showNotification('warning', 'Peringatan', 'Pilih data monitoring yang akan dihapus');
          return;
        }
        
        showConfirmation(
          'Hapus Monitoring',
          `Yakin akan menghapus ${checked.length} data monitoring?`,
          function() {
            const promises = [];
            checked.forEach(cb => {
              promises.push(monitoringRef.child(cb.value).remove());
            });
            
            Promise.all(promises)
              .then(() => {
                showNotification('success', 'Berhasil', `${checked.length} data monitoring berhasil dihapus`);
              })
              .catch(err => {
                showNotification('error', 'Gagal', 'Gagal menghapus data monitoring: ' + err.message);
              });
          }
        );
      }

      // ====== JAWABAN SISWA FUNCTIONS ======
      function loadJawaban() {
        if (!jawabanRef) return;
        
        jawabanRef.orderByChild('TglJam_Mulai').on('value', snapshot => {
          const tbody = document.querySelector('#jawabanTable tbody');
          const headerTr = document.getElementById('jawabanHeaderRow');
          tbody.innerHTML = '';
          headerTr.innerHTML = '';
          
          const rows = [];
          snapshot.forEach(childSnap => {
            rows.push({ id: childSnap.key, data: childSnap.val() });
          });
          
          rows.sort((a, b) => {
            const dateA = new Date(a.data.TglJam_Mulai || 0);
            const dateB = new Date(b.data.TglJam_Mulai || 0);
            return dateB - dateA;
          });
          
          let maxJ = 0;
          rows.forEach(r => {
            const d = r.data;
            for (const key in d) {
              if (key.indexOf('Jwb') === 0) {
                const num = parseInt(key.substring(3), 10);
                if (!isNaN(num) && num > maxJ) maxJ = num;
              }
            }
          });
          
          let headerHtml = `
            <th><input type="checkbox" id="jawaban_select_all" onclick="toggleSelectAllJawaban(this)"></th>
            <th>Nama Siswa</th>
            <th>Agenda Ujian</th>
            <th>Mata Pelajaran</th>
            <th>Jenis Tes</th>
          `;
          
          for (let i = 1; i <= maxJ; i++) {
            headerHtml += `<th>Jwb${i}</th>`;
          }
          
          headerHtml += `
            <th>Status</th>
            <th>TglJam_Mulai</th>
            <th>EndAt</th>
            <th>TglJam_Selesai</th>
          `;
          headerTr.innerHTML = headerHtml;
          
          rows.forEach(r => {
            const d = r.data;
            const nis = d.NIS_Username || '';
            const namaSiswa = pesertaNameMap[nis] || nis;
            
            let jenisTes = '';
            const agendaId = d.ID_Agenda || '';
            if (agendaId && agendaCache[agendaId]) {
              jenisTes = agendaCache[agendaId].Jenis_Tes || '';
            }
            
            let rowHtml = `
              <td><input type="checkbox" class="jawaban-checkbox" value="${r.id}"></td>
              <td>${namaSiswa}</td>
              <td>${d.Judul_Ujian || ''}</td>
              <td>${d.Mata_Pelajaran || ''}</td>
              <td>${jenisTes}</td>
            `;
            
            for (let i = 1; i <= maxJ; i++) {
              rowHtml += `<td>${d['Jwb' + i] || ''}</td>`;
            }
            
            rowHtml += `
              <td>${d.Status || ''}</td>
              <td>${d.TglJam_Mulai || ''}</td>
              <td>${d.EndAt || ''}</td>
              <td>${d.TglJam_Selesai || ''}</td>
            `;
            
            const tr = document.createElement('tr');
            tr.innerHTML = rowHtml;
            tbody.appendChild(tr);
          });
          
        }, error => {
          showNotification('error', 'Error', 'Gagal membaca Jawaban Siswa: ' + error.message);
        });
      }

      function toggleSelectAllJawaban(src) {
        const cbs = document.querySelectorAll('.jawaban-checkbox');
        cbs.forEach(cb => cb.checked = src.checked);
      }

      function deleteSelectedJawaban() {
        const checked = document.querySelectorAll('.jawaban-checkbox:checked');
        if (!checked.length) {
          showNotification('warning', 'Peringatan', 'Pilih data jawaban yang akan dihapus');
          return;
        }
        
        showConfirmation(
          'Hapus Jawaban',
          `Yakin akan menghapus ${checked.length} data jawaban?`,
          function() {
            const promises = [];
            checked.forEach(cb => {
              promises.push(jawabanRef.child(cb.value).remove());
            });
            
            Promise.all(promises)
              .then(() => {
                showNotification('success', 'Berhasil', `${checked.length} data jawaban berhasil dihapus`);
              })
              .catch(err => {
                showNotification('error', 'Gagal', 'Gagal menghapus data jawaban: ' + err.message);
              });
          }
        );
      }

      function loadAgendaListForCekJawaban() {
  const select = document.getElementById('CekJawaban_Agenda_Select');
  if (!agendaRef) return;
  
  agendaRef.on('value', snapshot => {
    const currentValue = select.value;
    select.innerHTML = '<option value="">-- Pilih Agenda Ujian --</option>';
    
    snapshot.forEach(childSnap => {
      const id = childSnap.key;
      const ag = childSnap.val();
      const opt = document.createElement('option');
      opt.value = id;
      let label = ag.Agenda_Ujian || id;
      if (ag.Jenjang_Studi) label += ' (' + ag.Jenjang_Studi + ')';
      opt.textContent = label;
      select.appendChild(opt);
    });
    
    if (currentValue) select.value = currentValue;
  });
}

function onChangeAgendaCekJawaban() {
  const agendaId = document.getElementById('CekJawaban_Agenda_Select').value;
  selectedMapelsForJawaban = [];
  jawabanPermapelData = [];
  document.getElementById('cekJawabanMapelTableContainer').innerHTML = `
    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px;">
      <div>üìã</div>
      <div>Pilih agenda ujian dan mata pelajaran, lalu klik "Tampilkan Jawaban"</div>
    </div>
  `;
  
  if (!agendaId) {
    document.getElementById('mapelCheckboxContainer').innerHTML = 
      '<div style="font-size: 12px; color: var(--text-muted);">Pilih agenda ujian terlebih dahulu</div>';
    return;
  }
  
  loadMapelCheckboxes(agendaId);
}

async function loadMapelCheckboxes(agendaId) {
  const container = document.getElementById('mapelCheckboxContainer');
  container.innerHTML = '<div style="font-size: 12px; color: var(--text-muted);">Memuat mata pelajaran...</div>';
  
  try {
    // Ambil data mapel
    const mapelSnapshot = await mapelRef.orderByChild('ID_Agenda').equalTo(agendaId).once('value');
    const mapels = [];
    
    mapelSnapshot.forEach(childSnap => {
      const data = childSnap.val();
      mapels.push({
        id: childSnap.key,
        name: data.Nama_Mata_Pelajaran || '',
        jumlahSoal: data.Jumlah_Soal || 0,
        status: data.Status_Mapel || 'Draft'
      });
    });
    
    if (mapels.length === 0) {
      container.innerHTML = '<div style="font-size: 12px; color: var(--text-muted);">Tidak ada mata pelajaran untuk agenda ini</div>';
      return;
    }
    
    // Ambil data bank soal untuk menghitung jumlah soal per mapel
    const bankSoalSnapshot = await bankSoalRef.orderByChild('ID_Agenda').equalTo(agendaId).once('value');
    const soalCountByMapel = {};
    
    bankSoalSnapshot.forEach(childSnap => {
      const data = childSnap.val();
      const mapelId = data.ID_Mapel;
      if (mapelId) {
        soalCountByMapel[mapelId] = (soalCountByMapel[mapelId] || 0) + 1;
      }
    });
    
    // Render checkbox
    let html = '<div class="mapel-checkbox-grid">';
    mapels.forEach(mapel => {
      const soalCount = soalCountByMapel[mapel.id] || 0;
      const isSiap = mapel.status === 'Siap';
      
      html += `
        <div class="mapel-checkbox-item">
          <input type="checkbox" 
                 id="mapel_${mapel.id}" 
                 value="${mapel.id}" 
                 data-name="${mapel.name}"
                 ${isSiap ? '' : 'disabled'}
                 onchange="handleMapelCheckboxChange(this)">
          <label for="mapel_${mapel.id}" class="mapel-checkbox-label">
            ${mapel.name}
            <span class="mapel-checkbox-count">${soalCount} soal</span>
            ${!isSiap ? '<span style="color:#f59e0b; font-size:10px;">(Draft)</span>' : ''}
          </label>
        </div>
      `;
    });
    html += '</div>';
    
    container.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading mapel checkboxes:', error);
    container.innerHTML = '<div style="font-size: 12px; color: var(--danger);">Gagal memuat mata pelajaran</div>';
  }
}

function handleMapelCheckboxChange(checkbox) {
  const mapelId = checkbox.value;
  const mapelName = checkbox.getAttribute('data-name');
  
  if (checkbox.checked) {
    selectedMapelsForJawaban.push({ id: mapelId, name: mapelName });
  } else {
    selectedMapelsForJawaban = selectedMapelsForJawaban.filter(m => m.id !== mapelId);
  }
  
  // Update UI
  const count = selectedMapelsForJawaban.length;
  const infoText = count > 0 
    ? `${count} mapel dipilih` 
    : 'Pilih mata pelajaran';
  
  const infoEl = document.createElement('div');
  infoEl.style.cssText = 'font-size: 12px; margin-top: 8px; padding: 6px; background: #f0f9ff; border-radius: 4px;';
  infoEl.textContent = infoText;
  
  const existingInfo = container.querySelector('.selection-info');
  if (existingInfo) existingInfo.remove();
  
  container.appendChild(infoEl);
  infoEl.className = 'selection-info';
}

async function loadJawabanPermapel() {
  const agendaId = document.getElementById('CekJawaban_Agenda_Select').value;
  
  if (!agendaId) {
    showNotification('error', 'Error', 'Pilih agenda ujian terlebih dahulu');
    return;
  }
  
  if (selectedMapelsForJawaban.length === 0) {
    showNotification('error', 'Error', 'Pilih minimal satu mata pelajaran');
    return;
  }
  
  showNotification('info', 'Memuat Data', 'Sedang mengambil data jawaban...', 0);
  
  try {
    // Ambil data jawaban untuk agenda ini
    const jawabanSnapshot = await jawabanRef.orderByChild('ID_Agenda').equalTo(agendaId).once('value');
    jawabanPermapelData = [];
    
    // Ambil data peserta untuk mapping nama
    const pesertaSnapshot = await pesertaRef.once('value');
    const pesertaMap = {};
    pesertaSnapshot.forEach(child => {
      const data = child.val();
      if (data.NIS_Username) {
        pesertaMap[data.NIS_Username] = data.Nama_Peserta || data.NIS_Username;
      }
    });
    
    // Proses setiap jawaban
    jawabanSnapshot.forEach(childSnap => {
      const data = childSnap.val();
      const mapelName = data.Mata_Pelajaran || '';
      
      // Cek apakah mapel ini dipilih
      const selectedMapel = selectedMapelsForJawaban.find(m => 
        m.name === mapelName || m.id === data.ID_Mapel
      );
      
      if (selectedMapel) {
        const siswaName = pesertaMap[data.NIS_Username] || data.NIS_Username;
        
        // Kumpulkan jawaban per nomor soal
        const jawabanPerSoal = {};
        for (let i = 1; i <= 100; i++) {
          const key = `Jwb${i}`;
          if (data[key] !== undefined) {
            jawabanPerSoal[i] = data[key];
          }
        }
        
        jawabanPermapelData.push({
          namaSiswa: siswaName,
          mapel: mapelName,
          jawaban: jawabanPerSoal,
          nis: data.NIS_Username || '',
          status: data.Status || '',
          tglMulai: data.TglJam_Mulai || ''
        });
      }
    });
    
    // Ambil data bank soal untuk header (nomor soal)
    const bankSoalMap = {};
    for (const mapel of selectedMapelsForJawaban) {
      const soalSnapshot = await bankSoalRef
        .orderByChild('ID_Mapel')
        .equalTo(mapel.id)
        .once('value');
      
      const soalNumbers = [];
      soalSnapshot.forEach(child => {
        const soalData = child.val();
        const noSoal = parseInt(soalData.No_Soal) || 0;
        if (noSoal > 0) {
          soalNumbers.push(noSoal);
        }
      });
      
      soalNumbers.sort((a, b) => a - b);
      bankSoalMap[mapel.name] = soalNumbers;
    }
    
    // Render tabel
    renderJawabanPermapelTable(bankSoalMap);
    
    hideAllNotifications();
    showNotification('success', 'Berhasil', `Menampilkan ${jawabanPermapelData.length} data jawaban`);
    
  } catch (error) {
    hideAllNotifications();
    console.error('Error loading jawaban permapel:', error);
    showNotification('error', 'Gagal', 'Gagal memuat data jawaban: ' + error.message);
  }
}

function renderJawabanPermapelTable(bankSoalMap) {
  const container = document.getElementById('cekJawabanMapelTableContainer');
  
  if (jawabanPermapelData.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
        <div>üì≠</div>
        <div>Tidak ada data jawaban untuk mata pelajaran yang dipilih</div>
      </div>
    `;
    return;
  }
  
  // Gabungkan semua nomor soal dari mapel yang dipilih
  const allSoalNumbers = new Set();
  Object.values(bankSoalMap).forEach(numbers => {
    numbers.forEach(num => allSoalNumbers.add(num));
  });
  
  const sortedSoalNumbers = Array.from(allSoalNumbers).sort((a, b) => a - b);
  
  // Buat HTML tabel
  let html = `
    <div class="section-header" style="margin-top: 20px;">
      <h3>Hasil Jawaban</h3>
      <p class="section-subtitle">${jawabanPermapelData.length} data jawaban ditemukan</p>
    </div>
    
    <div class="jawaban-table-container">
      <table class="jawaban-permapel-table">
        <thead>
          <tr>
            <th style="width: 40px;">Aksi</th>
            <th style="min-width: 150px;">Nama Siswa</th>
            <th style="min-width: 120px;">Mata Pelajaran</th>
  `;
  
  // Header nomor soal
  sortedSoalNumbers.forEach(no => {
    html += `<th style="min-width: 40px;">${no}</th>`;
  });
  
  html += `
            <th style="min-width: 80px;">Status</th>
            <th style="min-width: 120px;">Waktu Mulai</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  // Data baris
  jawabanPermapelData.forEach((item, index) => {
    html += `
      <tr>
        <td>
          <button onclick="detailJawabanSiswa('${item.nis}', '${item.mapel}')" 
                  style="padding: 3px 8px; font-size: 11px;">Detail</button>
        </td>
        <td style="text-align: left; padding-left: 10px;">${item.namaSiswa}</td>
        <td>${item.mapel}</td>
    `;
    
    // Jawaban per nomor soal
    sortedSoalNumbers.forEach(no => {
      const jawaban = item.jawaban[no] || '';
      let cellClass = 'jawaban-kosong';
      let displayText = jawaban || '-';
      
      if (jawaban) {
        cellClass = jawaban.length > 0 ? 'jawaban-benar' : 'jawaban-kosong';
      }
      
      html += `<td class="${cellClass}">${displayText}</td>`;
    });
    
    html += `
        <td>${item.status}</td>
        <td>${item.tglMulai || '-'}</td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
    
    <div style="margin-top: 15px; font-size: 12px; color: var(--text-muted); display: flex; justify-content: space-between;">
      <div>
        <span class="jawaban-benar" style="padding: 2px 6px; border-radius: 3px;">‚óè</span> Terisi
        <span class="jawaban-kosong" style="padding: 2px 6px; border-radius: 3px; margin-left: 10px;">‚óè</span> Kosong
      </div>
      <div>Total: ${jawabanPermapelData.length} siswa</div>
    </div>
  `;
  
  container.innerHTML = html;
}

function detailJawabanSiswa(nis, mapel) {
  // Cari data lengkap siswa
  const siswaData = jawabanPermapelData.find(item => 
    item.nis === nis && item.mapel === mapel
  );
  
  if (!siswaData) {
    showNotification('error', 'Error', 'Data siswa tidak ditemukan');
    return;
  }
  
  // Tampilkan modal dengan detail lengkap
  const detailHtml = `
    <div style="padding: 15px;">
      <h3 style="margin-top: 0; color: var(--text);">Detail Jawaban</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
        <div><strong>Nama Siswa:</strong> ${siswaData.namaSiswa}</div>
        <div><strong>NIS:</strong> ${nis}</div>
        <div><strong>Mata Pelajaran:</strong> ${mapel}</div>
        <div><strong>Status:</strong> ${siswaData.status}</div>
        <div><strong>Waktu Mulai:</strong> ${siswaData.tglMulai || '-'}</div>
      </div>
      
      <h4 style="margin-bottom: 10px;">Jawaban Detail:</h4>
      <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 10px;">
        <table style="width: 100%; font-size: 12px;">
          <thead>
            <tr>
              <th style="padding: 6px; background: var(--surface-alt);">No Soal</th>
              <th style="padding: 6px; background: var(--surface-alt);">Jawaban</th>
            </tr>
          </thead>
          <tbody>
            ${Object.entries(siswaData.jawaban).map(([no, jawab]) => `
              <tr>
                <td style="padding: 6px; border-bottom: 1px solid var(--border); text-align: center; font-weight: 600;">${no}</td>
                <td style="padding: 6px; border-bottom: 1px solid var(--border); text-align: center; ${jawab ? 'background: #dcfce7;' : 'background: #f3f4f6;'}">
                  ${jawab || '<em style="color: #6b7280;">Kosong</em>'}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  // Tampilkan modal custom
  const modalId = 'modal-detail-jawaban';
  let modal = document.getElementById(modalId);
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'modal-backdrop';
    modal.innerHTML = `
      <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
          <div class="modal-title">Detail Jawaban Siswa</div>
          <button type="button" class="modal-close-btn" onclick="hideModal('${modalId}')">&times;</button>
        </div>
        <div class="modal-body" id="${modalId}-body"></div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  document.getElementById(`${modalId}-body`).innerHTML = detailHtml;
  showModal(modalId);
}

function exportJawabanPermapelToExcel() {
  if (jawabanPermapelData.length === 0) {
    showNotification('error', 'Error', 'Tidak ada data untuk di-export');
    return;
  }
  
  try {
    // Kumpulkan semua nomor soal
    const allSoalNumbers = new Set();
    jawabanPermapelData.forEach(item => {
      Object.keys(item.jawaban).forEach(no => allSoalNumbers.add(parseInt(no)));
    });
    
    const sortedSoalNumbers = Array.from(allSoalNumbers).sort((a, b) => a - b);
    
    // Buat CSV
    let csv = 'Nama Siswa,Mata Pelajaran,NIS,Status,Waktu Mulai';
    
    // Header untuk nomor soal
    sortedSoalNumbers.forEach(no => {
      csv += `,Soal ${no}`;
    });
    
    csv += '\n';
    
    // Data
    jawabanPermapelData.forEach(item => {
      const row = [
        `"${item.namaSiswa}"`,
        `"${item.mapel}"`,
        `"${item.nis}"`,
        `"${item.status}"`,
        `"${item.tglMulai || ''}"`
      ];
      
      sortedSoalNumbers.forEach(no => {
        const jawaban = item.jawaban[no] || '';
        row.push(`"${jawaban}"`);
      });
      
      csv += row.join(',') + '\n';
    });
    
    // Download file
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `jawaban_permapel_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('success', 'Berhasil', 'Data berhasil di-export ke CSV');
    
  } catch (error) {
    console.error('Error exporting to CSV:', error);
    showNotification('error', 'Gagal', 'Gagal mengexport data: ' + error.message);
  }
}

function clearJawabanPermapel() {
  jawabanPermapelData = [];
  document.getElementById('cekJawabanMapelTableContainer').innerHTML = `
    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px;">
      <div>üìã</div>
      <div>Pilih agenda ujian dan mata pelajaran, lalu klik "Tampilkan Jawaban"</div>
    </div>
  `;
}

      // ====== CETAK KARTU FUNCTIONS ======
      function onChangeAgendaCetakKartu() {
        currentAgendaForKartu = document.getElementById('CetakKartu_Agenda_Select').value;
        loadKartuPesertaTable();
      }

      function loadKartuPesertaTable() {
        const tbody = document.querySelector('#cetakKartuTable tbody');
        tbody.innerHTML = '';
        kartuPesertaList = [];
        
        if (!currentAgendaForKartu || !pesertaRef) return;
        
        pesertaRef.orderByChild('ID_Agenda').equalTo(currentAgendaForKartu).once('value')
          .then(snapshot => {
            let idx = 0;
            snapshot.forEach(childSnap => {
              const data = childSnap.val();
              kartuPesertaList.push(data);
              
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><input type="checkbox" class="kartu-checkbox" data-index="${idx}"></td>
                <td>${data.NIS_Username || ''}</td>
                <td>${data.Nama_Peserta || ''}</td>
                <td>
                  <div class="password-wrapper" style="position: relative; display: inline-block; width: 100px;">
                    <input type="password" value="${data.Password || ''}" readonly 
                           style="width: 100%; padding-right: 30px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; padding: 4px 30px 4px 8px;">
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility(this.previousElementSibling, this)" 
                            style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; font-size: 11px; padding: 0;">
                      üëÅÔ∏è
                    </button>
                  </div>
                </td>
                <td class="actions">
                  <button type="button" onclick="printKartuSingle(${idx})">Print</button>
                </td>
              `;
              tbody.appendChild(tr);
              idx++;
            });
          })
          .catch(err => {
            showNotification('error', 'Error', 'Gagal membaca peserta: ' + err.message);
          });
      }

      function toggleSelectAllKartu(src) {
        const cbs = document.querySelectorAll('.kartu-checkbox');
        cbs.forEach(cb => cb.checked = src.checked);
      }

      function buildKartuHtml(peserta, agendaData) {
        const agendaName = agendaData && agendaData.Agenda_Ujian ? agendaData.Agenda_Ujian : peserta.ID_Agenda || '';
        const token = agendaData && agendaData.Token_Ujian ? agendaData.Token_Ujian : '';
        const nama = peserta.Nama_Peserta || '';
        const sekolah = peserta.Asal_Sekolah || '';
        const kelas = peserta.Kelas || '';
        const username = peserta.NIS_Username || '';
        const password = peserta.Password || '';
        const jenjang = peserta.Jenjang_Studi || '';
        const deskripsi = agendaData && agendaData.Deskripsi_Ujian ? agendaData.Deskripsi_Ujian : '';
        const jenisTes = agendaData && agendaData.Jenis_Tes ? agendaData.Jenis_Tes : '';
        
        return `
          <div class="kartu-container">
            <div class="kartu-logo">CBT 2026</div>
            <div class="kartu-header">KARTU PESERTA UJIAN</div>
            <div class="kartu-title">${agendaName}</div>
            ${deskripsi ? `<div style="text-align:center; font-size:11px; color:#4b5563; margin-bottom:10px;">${deskripsi}</div>` : ''}
            ${jenisTes ? `<div style="text-align:center; font-size:11px; color:#2563eb; font-weight:600; margin-bottom:8px;">${jenisTes}</div>` : ''}
            
            <table class="kartu-table">
              <tr><td class="label">Nama Peserta</td><td>: ${nama}</td></tr>
              <tr><td class="label">Jenjang</td><td>: ${jenjang} - ${kelas}</td></tr>
              <tr><td class="label">Asal Sekolah</td><td>: ${sekolah}</td></tr>
              <tr><td class="label">Username</td><td>: ${username}</td></tr>
              <tr><td class="label">Password</td><td>: ${password}</td></tr>
              <tr><td class="label">Token Ujian</td><td>: <strong style="color:#2563eb;">${token}</strong></td></tr>
            </table>
            
            <div style="margin: 10px 0; padding: 8px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #2563eb;">
              <div style="font-size: 11px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">Petunjuk:</div>
              <div style="font-size: 9px; color: #374151;">
                1. Bawa kartu ini saat ujian<br>
                2. Jaga kerahasiaan username & password<br>
                3. Masukkan token saat memulai ujian<br>
                4. Login 15 menit sebelum ujian dimulai
              </div>
            </div>
            
            <div class="kartu-footer">
              Kartu ini berlaku untuk satu peserta ujian. Dilarang memperbanyak tanpa izin.
            </div>
            <div class="kartu-watermark">CBT2026-Developed by D14nr ¬© 2026</div>
          </div>
        `;
      }

      function printKartuSingle(index) {
        if (!currentAgendaForKartu) {
          showNotification('error', 'Error', 'Pilih Agenda Ujian terlebih dahulu');
          return;
        }
        
        const peserta = kartuPesertaList[index];
        if (!peserta) return;
        
        const agendaData = agendaCache[currentAgendaForKartu] || {};
        const html = buildKartuHtml(peserta, agendaData);
        
        const area = document.getElementById('printArea');
        area.innerHTML = html;
        area.style.display = 'block';
        
        setTimeout(() => {
          window.print();
          setTimeout(() => {
            area.innerHTML = '';
            area.style.display = 'none';
          }, 500);
        }, 100);
      }

      function printKartuSelected() {
        if (!currentAgendaForKartu) {
          showNotification('error', 'Error', 'Pilih Agenda Ujian terlebih dahulu');
          return;
        }
        
        const checked = document.querySelectorAll('.kartu-checkbox:checked');
        if (!checked.length) {
          showNotification('warning', 'Peringatan', 'Pilih peserta yang akan dicetak kartunya');
          return;
        }
        
        const agendaData = agendaCache[currentAgendaForKartu] || {};
        let html = '';
        
        checked.forEach(cb => {
          const idx = parseInt(cb.getAttribute('data-index'), 10);
          const peserta = kartuPesertaList[idx];
          if (peserta) {
            html += buildKartuHtml(peserta, agendaData);
          }
        });
        
        const area = document.getElementById('printArea');
        area.innerHTML = html;
        area.style.display = 'block';
        
        setTimeout(() => {
          window.print();
          setTimeout(() => {
            area.innerHTML = '';
            area.style.display = 'none';
          }, 500);
        }, 100);
      }

      // ====== MODAL FUNCTIONS ======
      function showModal(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.add('show');
        document.body.style.overflow = 'hidden';
      }

      function hideModal(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.remove('show');
        document.body.style.overflow = '';
      }

      function togglePasswordVisibility(inputElement, buttonElement) {
        const input = typeof inputElement === 'string' 
          ? document.getElementById(inputElement) 
          : inputElement;
        
        if (input.type === 'password') {
          input.type = 'text';
          buttonElement.textContent = 'üôà';
        } else {
          input.type = 'password';
          buttonElement.textContent = 'üëÅÔ∏è';
        }
      }

      function exportJawabanToCsv() {
  if (!jawabanRef) return;
  
  showNotification('info', 'Export Data', 'Menyiapkan data untuk di-export...', 0);
  
  jawabanRef.once('value')
    .then(snapshot => {
      const rows = [];
      snapshot.forEach(childSnap => {
        rows.push({ id: childSnap.key, data: childSnap.val() });
      });
      
      if (rows.length === 0) {
        hideAllNotifications();
        showNotification('warning', 'Peringatan', 'Tidak ada data jawaban untuk di-export');
        return;
      }
      
      // Tentukan header
      const maxJ = 100; // Maksimal 100 soal
      let csv = 'NIS,Nama Siswa,Agenda Ujian,Mata Pelajaran,Jenis Tes,Status,TglJam_Mulai,EndAt,TglJam_Selesai';
      
      for (let i = 1; i <= maxJ; i++) {
        csv += `,Jwb${i}`;
      }
      
      csv += '\n';
      
      // Isi data
      rows.forEach(r => {
        const d = r.data;
        const nis = d.NIS_Username || '';
        const namaSiswa = pesertaNameMap[nis] || nis;
        let jenisTes = '';
        
        if (d.ID_Agenda && agendaCache[d.ID_Agenda]) {
          jenisTes = agendaCache[d.ID_Agenda].Jenis_Tes || '';
        }
        
        const row = [
          `"${nis}"`,
          `"${namaSiswa}"`,
          `"${d.Judul_Ujian || ''}"`,
          `"${d.Mata_Pelajaran || ''}"`,
          `"${jenisTes}"`,
          `"${d.Status || ''}"`,
          `"${d.TglJam_Mulai || ''}"`,
          `"${d.EndAt || ''}"`,
          `"${d.TglJam_Selesai || ''}"`
        ];
        
        for (let i = 1; i <= maxJ; i++) {
          row.push(`"${d['Jwb' + i] || ''}"`);
        }
        
        csv += row.join(',') + '\n';
      });
      
      // Download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `jawaban_siswa_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      hideAllNotifications();
      showNotification('success', 'Berhasil', `Data berhasil di-export (${rows.length} baris)`);
      
    })
    .catch(err => {
      hideAllNotifications();
      showNotification('error', 'Gagal', 'Gagal mengexport data: ' + err.message);
    });
}

      // ====== INITIALIZATION ======
      document.addEventListener('DOMContentLoaded', function() {
        checkLoginStatus();
        
        // Check if Google Apps Script URL is configured
        if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL.includes('YOUR_WEB_APP_URL')) {
          showNotification('warning', 'Konfigurasi', 'URL Google Apps Script belum dikonfigurasi. Upload gambar akan menggunakan fallback ke base64.', 10000);
        }
      });

    </script>
  </body>
</html
