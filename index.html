<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login Admin - Portal Admin CBT 2026</title>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
      /* [CSS tetap sama seperti sebelumnya] */
      :root {
        /* Semua CSS sebelumnya tetap sama */
      }
      /* ... CSS tetap sama ... */
    </style>
  </head>
  <body class="login-page">

    <!-- LOGIN SECTION (sama seperti sebelumnya) -->
    <div id="login-section">
      <div class="login-card">
        <div class="login-title">Login Admin</div>
        <div class="login-subtitle">Portal Admin CBT 2026</div>
        <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
          <input type="text" id="login_username" placeholder="Username" required>
          
          <div class="password-wrapper">
            <input type="password" id="login_password" placeholder="Password" required>
            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('login_password', this)">
              üëÅÔ∏è
            </button>
          </div>
          
          <button type="submit" class="login-btn">Masuk</button>
        </form>
      </div>
    </div>

    <!-- MAIN APP SHELL (sama seperti sebelumnya) -->
    <div class="app-shell" id="app-shell">
      <!-- [Semua HTML untuk UI tetap sama] -->
    </div>

    <!-- MODALS (sama seperti sebelumnya) -->
    <!-- ... semua modal tetap sama ... -->

    <!-- Modern Notification System (sama) -->
    <div class="notification-container" id="notificationContainer"></div>
    <div class="confirmation-dialog" id="confirmationDialog">
      <div class="confirmation-box">
        <div class="confirmation-icon warning">‚ö†Ô∏è</div>
        <h3 class="confirmation-title" id="dialogTitle">Konfirmasi</h3>
        <p class="confirmation-message" id="dialogMessage">Apakah Anda yakin?</p>
        <div class="confirmation-buttons">
          <button class="confirmation-btn cancel" onclick="hideConfirmation()">Batal</button>
          <button class="confirmation-btn confirm" id="confirmActionBtn">Ya, Lanjutkan</button>
        </div>
      </div>
    </div>
    <div class="toast-notification" id="toastNotification">
      <span class="toast-icon">üìã</span>
      <span class="toast-message" id="toastMessage">Pesan toast</span>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-text">Developed by D14nr ¬© 2026</div>
        <div class="footer-subtext">Portal Admin CBT 2026</div>
      </div>
    </footer>

    <!-- Area khusus untuk print kartu -->
    <div id="printArea"></div>

    <script>
      // ====== KONFIGURASI SUPABASE ======
      const SUPABASE_URL = 'https://ffitekntuuratjfyccwd.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmaXRla250dXVyYXRqZnljY3dkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODUwNzU0NywiZXhwIjoyMDg0MDgzNTQ3fQ.5GAynFyNRB0IJcOsr1EZSB9p3zbR39jDM4I0zL8Nrao';

      // ====== GOOGLE APPS SCRIPT URL ======
      const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwOXJ-kL-ywDQv-GAe4bDlngnTN7ljOr6fTdtz3a6O0x-JTgyo/exec';

      // ====== INISIALISASI SUPABASE ======
      let supabase;

      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase initialized successfully');
      } catch (error) {
        console.error('Supabase initialization error:', error);
        showNotification('error', 'Database Error', 'Gagal menginisialisasi database. Periksa koneksi internet.');
      }

      // ====== VARIABEL GLOBAL ======
      let pesertaNameMap = {};
      let currentAgendaForMapel = '';
      let currentAgendaForBank = '';
      let importBankSoalMapelMap = {};
      let currentMapelForBank = '';
      let currentAgendaForKartu = '';
      let kartuPesertaList = [];
      let agendaCache = {};
      let selectedJawabanForReset = null;
      let resetMapelList = [];

      // ====== UTILITY FUNCTIONS ======
      // [Semua fungsi utility tetap sama seperti sebelumnya]
      // showNotification, closeNotification, hideAllNotifications, showConfirmation, hideConfirmation
      // fileToBase64, uploadToGoogleDrive, previewImage
      // ... (sama seperti kode sebelumnya)

      // ====== LOGIN FUNCTIONS ======
      function checkLoginStatus() {
        const loggedIn = sessionStorage.getItem('adminLoggedIn');
        
        if (loggedIn === 'true') {
          document.body.className = 'app-page';
          showApp();
        } else {
          document.body.className = 'login-page';
          showLogin();
        }
      }

      function handleLogin() {
        const username = document.getElementById('login_username').value;
        const password = document.getElementById('login_password').value;

        const validCredentials = [
          { user: 'Admin', pass: '290192' },
          { user: 'admin', pass: 'admin123' }
        ];
        
        const isValid = validCredentials.some(cred => 
          cred.user === username && cred.pass === password
        );
        
        if (isValid) {
          sessionStorage.setItem('adminLoggedIn', 'true');
          document.body.className = 'app-page';
          showApp();
          showNotification('success', 'Login Berhasil', 'Selamat datang di Portal Admin CBT 2026');
        } else {
          showNotification('error', 'Login Gagal', 'Username atau Password salah!');
          document.getElementById('login_password').value = '';
          document.getElementById('login_password').focus();
        }
      }

      function handleLogout() {
        showConfirmation(
          'Konfirmasi Logout',
          'Apakah Anda yakin ingin keluar dari sistem?',
          function() {
            sessionStorage.removeItem('adminLoggedIn');
            document.body.className = 'login-page';
            showLogin();
            showNotification('success', 'Logout Berhasil', 'Anda telah berhasil logout');
          }
        );
      }

      function showApp() {
        const loginSection = document.getElementById('login-section');
        const appShell = document.getElementById('app-shell');
        
        loginSection.style.display = 'none';
        appShell.style.display = 'block';
        
        loadPeserta();
        loadAgenda();
        loadAgendaListForPeserta();
        loadAgendaListForMapelDropdown();
        loadAgendaListForBankSoalDropdown();
        loadAgendaListForCetakKartuDropdown();
        loadMonitoring();
        loadJawaban();
        showTab('peserta');
      }

      function showLogin() {
        const loginSection = document.getElementById('login-section');
        const appShell = document.getElementById('app-shell');
        
        loginSection.style.display = 'flex';
        appShell.style.display = 'none';
        
        document.getElementById('login_username').value = '';
        document.getElementById('login_password').value = '';
      }

      // ====== TAB FUNCTIONS ======
      function showTab(tab) {
        const tabs = ['peserta', 'agenda', 'mapel', 'banksoal', 'monitoring', 'jawaban', 'cetakkartu'];
        tabs.forEach(name => {
          document.getElementById('tab-' + name).style.display =
            (tab === name) ? 'block' : 'none';
          document.getElementById('tab-btn-' + name).classList.toggle('active', tab === name);
        });
      }

      // ====== PESERTA FUNCTIONS (SUPABASE) ======
      function generateNISFromNoWA(noWa) {
        if (!noWa) return '';
        let digits = noWa.replace(/\D/g, '');
        if (digits.startsWith('0')) {
          digits = digits.substring(1);
        } else if (digits.startsWith('62')) {
          digits = digits.substring(2);
        }
        return digits;
      }

      function handleNoWAChange() {
        const noWa = document.getElementById('No_WA_Peserta').value;
        const nis = generateNISFromNoWA(noWa);
        document.getElementById('NIS_Username').value = nis;
      }

      async function loadPeserta() {
        try {
          const { data, error } = await supabase
            .from('peserta')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;

          const tbody = document.querySelector('#pesertaTable tbody');
          tbody.innerHTML = '';
          pesertaNameMap = {};

          data.forEach(peserta => {
            pesertaNameMap[peserta.nis_username] = peserta.nama_peserta || peserta.nis_username;

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${peserta.nis_username || ''}</td>
              <td>${peserta.nama_peserta || ''}</td>
              <td>
                <div class="password-wrapper" style="position: relative; display: inline-block; width: 120px;">
                  <input type="password" value="${peserta.password || ''}" readonly 
                         style="width: 100%; padding-right: 30px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; padding: 4px 30px 4px 8px;">
                  <button type="button" class="toggle-password" onclick="togglePasswordVisibility(this.previousElementSibling, this)" 
                          style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; font-size: 11px; padding: 0;">
                    üëÅÔ∏è
                  </button>
                </div>
              </td>
              <td>${peserta.jenjang_studi || ''}</td>
              <td>${peserta.kelas || ''}</td>
              <td>${peserta.asal_sekolah || ''}</td>
              <td>${peserta.no_wa_peserta || ''}</td>
              <td>${peserta.no_wa_ortu || ''}</td>
              <td class="actions">
                <button onclick="editPeserta('${peserta.id}')">Edit</button>
                <button onclick="deletePeserta('${peserta.id}')">Hapus</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          showNotification('error', 'Error', 'Gagal membaca data peserta: ' + error.message);
        }
      }

      function openPesertaModalForCreate() {
        resetForm();
        showModal('modal-peserta');
      }

      async function savePeserta() {
        try {
          const firebaseId = document.getElementById('firebaseId').value;
          const Nama_Peserta = document.getElementById('Nama_Peserta').value.trim();
          const Password = document.getElementById('Password').value.trim();
          const Jenjang_Studi = document.getElementById('Jenjang_Studi').value.trim();
          const Kelas = document.getElementById('Kelas').value.trim();
          const Asal_Sekolah = document.getElementById('Asal_Sekolah').value.trim();
          const No_WA_Peserta = document.getElementById('No_WA_Peserta').value.trim();
          const No_WA_Ortu = document.getElementById('No_WA_Ortu').value.trim();
          const ID_Agenda = document.getElementById('ID_Agenda_Peserta').value.trim();

          const NIS_Username = generateNISFromNoWA(No_WA_Peserta);
          document.getElementById('NIS_Username').value = NIS_Username;

          if (!Nama_Peserta || !Password || !Jenjang_Studi || !Kelas ||
              !Asal_Sekolah || !No_WA_Peserta || !No_WA_Ortu || !ID_Agenda || !NIS_Username) {
            showNotification('error', 'Validasi Error', 'Mohon lengkapi semua field');
            return;
          }

          const pesertaData = {
            nis_username: NIS_Username,
            nama_peserta: Nama_Peserta,
            password: Password,
            jenjang_studi: Jenjang_Studi,
            kelas: Kelas,
            asal_sekolah: Asal_Sekolah,
            no_wa_peserta: No_WA_Peserta,
            no_wa_ortu: No_WA_Ortu,
            id_agenda: ID_Agenda,
            tanggal_daftar: new Date().toISOString(),
            status: 'Aktif'
          };

          if (firebaseId) {
            // Update existing peserta
            const { error } = await supabase
              .from('peserta')
              .update(pesertaData)
              .eq('id', firebaseId);

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Data peserta berhasil diperbarui');
          } else {
            // Insert new peserta
            const { data, error } = await supabase
              .from('peserta')
              .insert([pesertaData])
              .select();

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Data peserta berhasil disimpan');
            document.getElementById('ID_Peserta').value = data[0].id;
          }

          resetForm();
          hideModal('modal-peserta');
          loadPeserta();
          
        } catch (error) {
          showNotification('error', 'Gagal', 'Gagal menyimpan peserta: ' + error.message);
        }
      }

      async function editPeserta(id) {
        try {
          const { data, error } = await supabase
            .from('peserta')
            .select('*')
            .eq('id', id)
            .single();

          if (error) throw error;

          document.getElementById('firebaseId').value = id;
          document.getElementById('ID_Peserta').value = data.id;
          document.getElementById('NIS_Username').value = data.nis_username || '';
          document.getElementById('Nama_Peserta').value = data.nama_peserta || '';
          document.getElementById('Password').value = data.password || '';
          document.getElementById('Jenjang_Studi').value = data.jenjang_studi || '';
          document.getElementById('Kelas').value = data.kelas || '';
          document.getElementById('Asal_Sekolah').value = data.asal_sekolah || '';
          document.getElementById('No_WA_Peserta').value = data.no_wa_peserta || '';
          document.getElementById('No_WA_Ortu').value = data.no_wa_ortu || '';
          document.getElementById('ID_Agenda_Peserta').value = data.id_agenda || '';
          
          showModal('modal-peserta');
        } catch (error) {
          showNotification('error', 'Gagal', 'Gagal mengambil data peserta: ' + error.message);
        }
      }

      async function deletePeserta(id) {
        showConfirmation(
          'Hapus Peserta',
          'Apakah Anda yakin ingin menghapus data peserta ini?',
          async function() {
            try {
              const { error } = await supabase
                .from('peserta')
                .delete()
                .eq('id', id);

              if (error) throw error;
              
              showNotification('success', 'Berhasil', 'Data peserta berhasil dihapus');
              loadPeserta();
            } catch (error) {
              showNotification('error', 'Gagal', 'Gagal menghapus peserta: ' + error.message);
            }
          }
        );
      }

      function resetForm() {
        document.getElementById('firebaseId').value = '';
        document.getElementById('pesertaForm').reset();
        document.getElementById('ID_Peserta').value = '';
        document.getElementById('NIS_Username').value = '';
      }

      // ====== AGENDA FUNCTIONS (SUPABASE) ======
      // Note: Tabel agenda_ujian tidak ada di struktur yang diberikan
      // Saya akan asumsikan tabel agenda_ujian dengan kolom:
      // id, agenda_ujian, deskripsi_ujian, jenjang_studi, jenis_tes, tgljam_mulai, tgljam_selesai, token_ujian

      async function loadAgenda() {
        try {
          const { data, error } = await supabase
            .from('agenda_ujian')
            .select('*')
            .order('tgljam_mulai', { ascending: false });
          
          if (error) throw error;

          const tbody = document.querySelector('#agendaTable tbody');
          tbody.innerHTML = '';
          agendaCache = {};
          
          data.forEach(agenda => {
            agendaCache[agenda.id] = agenda;
            
            const mulai = agenda.tgljam_mulai ? new Date(agenda.tgljam_mulai).toLocaleString() : '';
            const selesai = agenda.tgljam_selesai ? new Date(agenda.tgljam_selesai).toLocaleString() : '';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${agenda.agenda_ujian || ''}</td>
              <td>${agenda.deskripsi_ujian || ''}</td>
              <td>${agenda.jenjang_studi || ''}</td>
              <td>${agenda.jenis_tes || ''}</td>
              <td>${mulai}</td>
              <td>${selesai}</td>
              <td>${agenda.token_ujian || ''}</td>
              <td class="actions">
                <button onclick="editAgenda('${agenda.id}')">Edit</button>
                <button onclick="deleteAgenda('${agenda.id}')">Hapus</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          showNotification('error', 'Error', 'Gagal membaca data agenda: ' + error.message);
        }
      }

      async function loadAgendaListForPeserta() {
        const select = document.getElementById('ID_Agenda_Peserta');
        
        try {
          const { data, error } = await supabase
            .from('agenda_ujian')
            .select('id, agenda_ujian, jenjang_studi')
            .order('agenda_ujian');
          
          if (error) throw error;

          const currentValue = select.value;
          select.innerHTML = '<option value="">-- Pilih Agenda --</option>';
          
          data.forEach(agenda => {
            const opt = document.createElement('option');
            opt.value = agenda.id;
            let label = agenda.agenda_ujian || agenda.id;
            if (agenda.jenjang_studi) label += ' (' + agenda.jenjang_studi + ')';
            opt.textContent = label;
            select.appendChild(opt);
          });
          
          if (currentValue) select.value = currentValue;
        } catch (error) {
          console.error('Error loading agenda list:', error);
        }
      }

      // Fungsi loadAgendaListForMapelDropdown, loadAgendaListForBankSoalDropdown, loadAgendaListForCetakKartuDropdown
      // akan menggunakan query yang sama seperti loadAgendaListForPeserta

      function generateRandomToken() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        const length = 6 + Math.floor(Math.random() * 3);
        let token = '';
        for (let i = 0; i < length; i++) {
          token += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return token;
      }

      function generateTokenUjian() {
        const token = generateRandomToken();
        document.getElementById('Token_Ujian').value = token;
      }

      // [Fungsi-fungsi untuk agenda lainnya akan menggunakan pola yang sama seperti peserta]

      // ====== MATA PELAJARAN FUNCTIONS (SUPABASE) ======
      async function loadMapelTable() {
        const tbody = document.querySelector('#mapelTable tbody');
        tbody.innerHTML = '';
        
        if (!currentAgendaForMapel) return;
        
        try {
          const { data, error } = await supabase
            .from('mata_pelajaran')
            .select('*')
            .eq('id_agenda', currentAgendaForMapel)
            .order('nama_mata_pelajaran');
          
          if (error) throw error;

          data.forEach(mapel => {
            const isSiap = mapel.status_mapel === 'Siap';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${mapel.nama_mata_pelajaran || ''}</td>
              <td>${mapel.jumlah_soal || ''}</td>
              <td>${mapel.durasi_ujian || ''}</td>
              <td>
                <label style="display:flex; align-items:center; gap:4px; font-weight:400;">
                  <input type="checkbox" ${isSiap ? 'checked' : ''} 
                         onchange="toggleStatusMapel('${mapel.id}', this.checked)">
                  <span>${isSiap ? 'Siap' : 'Draft'}</span>
                </label>
              </td>
              <td class="actions">
                <button onclick="editMapel('${mapel.id}')">Edit</button>
                <button onclick="deleteMapel('${mapel.id}')">Hapus</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          showNotification('error', 'Error', 'Gagal membaca data mapel: ' + error.message);
        }
      }

      async function saveMapel() {
        try {
          const mapelId = document.getElementById('firebaseMapelId').value;
          const ID_Agenda = currentAgendaForMapel;
          
          if (!ID_Agenda) {
            showNotification('error', 'Error', 'Pilih Agenda Ujian terlebih dahulu');
            return;
          }
          
          const Nama_Mata_Pelajaran = document.getElementById('Nama_Mata_Pelajaran').value.trim();
          const Jumlah_Soal = parseInt(document.getElementById('Jumlah_Soal').value) || 0;
          const Durasi_Ujian = parseInt(document.getElementById('Durasi_Ujian').value) || 0;
          let Status_Mapel = document.getElementById('Status_Mapel').value || 'Draft';

          if (!Nama_Mata_Pelajaran || !Jumlah_Soal || !Durasi_Ujian) {
            showNotification('error', 'Validasi Error', 'Mohon lengkapi semua field mata pelajaran');
            return;
          }
          
          const mapelData = {
            nama_mata_pelajaran: Nama_Mata_Pelajaran,
            id_agenda: ID_Agenda,
            jumlah_soal: Jumlah_Soal,
            durasi_ujian: Durasi_Ujian,
            status_mapel: Status_Mapel,
            updated_at: new Date().toISOString()
          };
          
          if (mapelId) {
            // Update existing mapel
            const { error } = await supabase
              .from('mata_pelajaran')
              .update(mapelData)
              .eq('id', mapelId);

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Mata pelajaran berhasil diperbarui');
          } else {
            // Insert new mapel
            mapelData.created_at = new Date().toISOString();
            const { data, error } = await supabase
              .from('mata_pelajaran')
              .insert([mapelData])
              .select();

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Mata pelajaran berhasil disimpan');
            document.getElementById('ID_Mapel_Mapel').value = data[0].id;
          }
          
          resetMapelForm(false);
          loadMapelTable();
          hideModal('modal-mapel');
          
        } catch (error) {
          showNotification('error', 'Gagal', 'Gagal menyimpan mapel: ' + error.message);
        }
      }

      // [Fungsi-fungsi untuk mapel lainnya akan menggunakan pola yang sama]

      // ====== BANK SOAL FUNCTIONS (SUPABASE) ======
      async function loadBankSoalTable() {
        const tbody = document.querySelector('#bankSoalTable tbody');
        tbody.innerHTML = '';
        
        if (!currentMapelForBank) return;
        
        try {
          const { data, error } = await supabase
            .from('bank_soal')
            .select('*')
            .eq('id_mapel', currentMapelForBank)
            .order('no_soal');
          
          if (error) throw error;

          data.forEach(soal => {
            const tr = document.createElement('tr');
            const pertSingkat = (soal.pertanyaan || '').length > 80
              ? soal.pertanyaan.substring(0, 80) + '...'
              : (soal.pertanyaan || '');
            
            const gambarCell = soal.gambar_url
              ? `<a href="${soal.gambar_url}" target="_blank" title="Lihat gambar">üì∑</a>` : '';
            
            tr.innerHTML = `
              <td><input type="checkbox" class="banksoal-checkbox" value="${soal.id}"></td>
              <td>${soal.no_soal || ''}</td>
              <td>${soal.type_soal || ''}</td>
              <td>${pertSingkat}</td>
              <td>${gambarCell}</td>
              <td class="actions">
                <button onclick="editSoal('${soal.id}')">Edit</button>
                <button onclick="deleteSoal('${soal.id}')">Hapus</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          showNotification('error', 'Error', 'Gagal membaca bank soal: ' + error.message);
        }
      }

      async function saveSoal() {
        if (!currentAgendaForBank || !currentMapelForBank) {
          showNotification('error', 'Error', 'Pilih Agenda Ujian dan Mata Pelajaran terlebih dahulu');
          return;
        }
        
        try {
          const soalId = document.getElementById('firebaseSoalId').value;
          const No_Soal = parseInt(document.getElementById('No_Soal').value) || 0;
          const Pertanyaan = document.getElementById('Pertanyaan').value.trim();
          const Type_Soal = document.getElementById('Type_Soal').value;
          
          if (!No_Soal || !Pertanyaan || !Type_Soal) {
            showNotification('error', 'Validasi Error', 'No Soal, Pertanyaan, dan Type Soal wajib diisi');
            return;
          }
          
          const soalData = {
            id_mapel: currentMapelForBank,
            no_soal: No_Soal,
            type_soal: Type_Soal,
            pertanyaan: Pertanyaan,
            pilihan_a: document.getElementById('Pilihan_A').value.trim(),
            pilihan_b: document.getElementById('Pilihan_B').value.trim(),
            pilihan_c: document.getElementById('Pilihan_C').value.trim(),
            pilihan_d: document.getElementById('Pilihan_D').value.trim(),
            pilihan_e: document.getElementById('Pilihan_E').value.trim(),
            updated_at: new Date().toISOString()
          };
          
          // Tambahkan pernyataan
          for (let i = 1; i <= 10; i++) {
            soalData['pernyataan_' + i] = document.getElementById('Pernyataan_' + i)?.value.trim() || '';
          }
          
          // Tambahkan pejodohan
          for (let j = 1; j <= 10; j++) {
            soalData['pernyataan_kiri_' + j] = document.getElementById('Pasangan_kiri_' + j)?.value.trim() || '';
            soalData['pernyataan_kanan_' + j] = document.getElementById('Pasangan_kanan_' + j)?.value.trim() || '';
          }
          
          const fileInput = document.getElementById('Gambar');
          const file = fileInput.files[0];
          const existingUrl = document.getElementById('Gambar_Url').value || '';
          
          if (file) {
            showNotification('info', 'Upload Gambar', 'Sedang mengupload gambar...', 0);
            
            const context = {
              agenda: currentAgendaForBank,
              mapel: currentMapelForBank,
              noSoal: No_Soal
            };
            
            const imageUrl = await uploadToGoogleDrive(file, context);
            soalData.gambar_url = imageUrl;
          } else {
            soalData.gambar_url = existingUrl;
          }
          
          if (soalId) {
            // Update existing soal
            const { error } = await supabase
              .from('bank_soal')
              .update(soalData)
              .eq('id', soalId);

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Soal berhasil diperbarui');
          } else {
            // Insert new soal
            soalData.created_at = new Date().toISOString();
            const { error } = await supabase
              .from('bank_soal')
              .insert([soalData]);

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Soal berhasil disimpan');
          }
          
          resetBankSoalForm(false);
          loadBankSoalTable();
          hideModal('modal-banksoal');
          
        } catch (error) {
          console.error('Save soal error:', error);
          showNotification('error', 'Gagal', 'Gagal menyimpan soal: ' + error.message);
        } finally {
          hideAllNotifications();
        }
      }

      // [Fungsi-fungsi untuk bank soal lainnya akan menggunakan pola yang sama]

      // ====== JAWABAN FUNCTIONS (SUPABASE) ======
      async function loadJawaban() {
        try {
          const { data, error } = await supabase
            .from('jawaban')
            .select(`
              *,
              peserta:nama_peserta_snap,
              agenda:nama_agenda_snap
            `)
            .order('tgljam_mulai', { ascending: false });
          
          if (error) throw error;

          const tbody = document.querySelector('#jawabanTable tbody');
          const headerTr = document.getElementById('jawabanHeaderRow');
          tbody.innerHTML = '';
          headerTr.innerHTML = '';
          
          // Parse jawaban untuk menentukan jumlah kolom
          let maxJ = 0;
          data.forEach(jawaban => {
            if (jawaban.jawaban) {
              try {
                const jwb = JSON.parse(jawaban.jawaban);
                const keys = Object.keys(jwb);
                keys.forEach(key => {
                  if (key.startsWith('Jwb')) {
                    const num = parseInt(key.substring(3), 10);
                    if (!isNaN(num) && num > maxJ) maxJ = num;
                  }
                });
              } catch (e) {
                console.log('Jawaban bukan JSON:', jawaban.jawaban);
              }
            }
          });
          
          let headerHtml = `
            <th><input type="checkbox" id="jawaban_select_all" onclick="toggleSelectAllJawaban(this)"></th>
            <th>Nama Siswa</th>
            <th>Agenda Ujian</th>
            <th>Mata Pelajaran</th>
            <th>Status</th>
          `;
          
          for (let i = 1; i <= maxJ; i++) {
            headerHtml += `<th>Jwb${i}</th>`;
          }
          
          headerHtml += `
            <th>TglJam_Mulai</th>
            <th>TglJam_Selesai</th>
            <th>Aksi</th>
          `;
          headerTr.innerHTML = headerHtml;
          
          data.forEach(jawaban => {
            let jawabanCount = 0;
            let jawabanObj = {};
            
            if (jawaban.jawaban) {
              try {
                jawabanObj = JSON.parse(jawaban.jawaban);
                Object.keys(jawabanObj).forEach(key => {
                  if (key.startsWith('Jwb') && jawabanObj[key] && jawabanObj[key].trim() !== '') {
                    jawabanCount++;
                  }
                });
              } catch (e) {
                console.log('Error parsing jawaban:', e);
              }
            }
            
            const jawabanBadge = jawabanCount > 0 
              ? `<span class="jawaban-badge">${jawabanCount}</span>` 
              : '';
            
            let rowHtml = `
              <td><input type="checkbox" class="jawaban-checkbox" value="${jawaban.id}"></td>
              <td>${jawaban.peserta || jawaban.nama_peserta_snap || ''} ${jawabanBadge}</td>
              <td>${jawaban.agenda || jawaban.nama_agenda_snap || ''}</td>
              <td>${jawaban.nama_mapel_snap || ''}</td>
              <td>${jawaban.status || ''}</td>
            `;
            
            for (let i = 1; i <= maxJ; i++) {
              const jawabanText = jawabanObj['Jwb' + i] || '';
              const cellClass = jawabanText.trim() !== '' ? 'style="background:#d1fae5;"' : '';
              rowHtml += `<td ${cellClass}>${jawabanText}</td>`;
            }
            
            rowHtml += `
              <td>${jawaban.tgljam_mulai ? new Date(jawaban.tgljam_mulai).toLocaleString() : ''}</td>
              <td>${jawaban.tgljam_selesai ? new Date(jawaban.tgljam_selesai).toLocaleString() : ''}</td>
              <td class="actions">
                <button onclick="openResetJawabanModal('${jawaban.id}')" title="Reset jawaban siswa">üîÑ Reset</button>
              </td>
            `;
            
            const tr = document.createElement('tr');
            tr.innerHTML = rowHtml;
            tbody.appendChild(tr);
          });
          
        } catch (error) {
          showNotification('error', 'Error', 'Gagal membaca Jawaban Siswa: ' + error.message);
        }
      }

      // ====== FUNGSI TAMBAHAN UNTUK SUPABASE ======
      
      // Fungsi untuk load monitoring (jika tabel monitoring tidak ada, bisa diabaikan atau dibuat)
      async function loadMonitoring() {
        try {
          // Jika tabel monitoring tidak ada, kita bisa menggunakan query lain
          // Atau membuat fungsi ini kosong sementara
          const { data, error } = await supabase
            .from('jawaban')
            .select(`
              *,
              peserta:peserta!inner(nis_username, nama_peserta)
            `)
            .order('tgljam_mulai', { ascending: false });
          
          if (error) throw error;

          const tbody = document.querySelector('#monitoringTable tbody');
          tbody.innerHTML = '';
          
          data.forEach(record => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><input type="checkbox" class="monitoring-checkbox" value="${record.id}"></td>
              <td>${record.peserta?.nis_username || ''}</td>
              <td>${record.peserta?.nama_peserta || ''}</td>
              <td>${record.tgljam_login ? 'Login' : ''} ${record.tgljam_logout ? 'Logout' : ''}</td>
              <td>${record.nama_agenda_snap || ''}</td>
              <td>${record.nama_mapel_snap || ''}</td>
              <td>${record.status || ''}</td>
              <td>${record.tgljam_mulai ? new Date(record.tgljam_mulai).toLocaleString() : ''}</td>
              <td>${record.updated_at ? new Date(record.updated_at).toLocaleString() : ''}</td>
              <td>${record.tgljam_selesai ? new Date(record.tgljam_selesai).toLocaleString() : ''}</td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          console.error('Error loading monitoring:', error);
          // Jika error, kita bisa hide tab monitoring atau tampilkan pesan
        }
      }

      // ====== FUNGSI UTILITY YANG SAMA ======
      // [Semua fungsi utility yang tidak berhubungan dengan database tetap sama]
      // showNotification, closeNotification, hideAllNotifications, showConfirmation, hideConfirmation
      // fileToBase64, uploadToGoogleDrive, previewImage, togglePasswordVisibility
      // onTypeSoalChange, setAutoNoSoal, onChangeAgendaBankSoal, onChangeMapelBankSoal
      // toggleSelectAllBankSoal, selectAllBankSoal, deselectAllBankSoal
      // deleteSelectedBankSoal, deleteAllBankSoal
      // openImportBankSoalModal, importBankSoalFromFile, downloadTemplateBankSoal
      // downloadTemplatePeserta, importPesertaFromFile
      // openBankSoalModalForCreate, editSoal, deleteSoal, resetBankSoalForm
      // toggleSelectAllMonitoring, deleteSelectedMonitoring
      // toggleSelectAllJawaban, deleteSelectedJawaban, resetAllJawabanForSelected
      // openResetJawabanModal, loadMapelForReset, toggleResetMapel, toggleAllResetMapel
      // confirmResetJawaban, performResetJawaban, openMultiResetModal
      // onChangeAgendaCetakKartu, loadKartuPesertaTable, toggleSelectAllKartu
      // buildKartuHtml, printKartuSingle, printKartuSelected
      // showModal, hideModal
      
      // ====== INISIALISASI ======
      document.addEventListener('DOMContentLoaded', function() {
        checkLoginStatus();
        
        if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL.includes('https://script.google.com/macros/s/AKfycbwOXJ-kL-ywDQv-GAe4bDlngnTN7ljOr6fTdtz3a6O0x-JTgyo/exec')) {
          showNotification('warning', 'Konfigurasi', 'URL Google Apps Script belum dikonfigurasi. Upload gambar akan menggunakan fallback ke base64.', 10000);
        }
      });

    </script>
  </body>
</html>
