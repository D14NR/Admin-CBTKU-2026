<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login Admin - Portal Admin CBT 2026</title>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
      :root {
        --bg: #f3f4f6;
        --surface: #ffffff;
        --surface-alt: #f9fafb;
        --border: #e5e7eb;
        --border-strong: #d1d5db;
        --primary: #2563eb;
        --primary-soft: rgba(37, 99, 235, 0.12);
        --primary-hover: #1d4ed8;
        --danger: #dc2626;
        --danger-soft: rgba(220, 38, 38, 0.1);
        --danger-hover: #b91c1c;
        --warning: #f59e0b;
        --warning-soft: rgba(245, 158, 11, 0.1);
        --warning-hover: #d97706;
        --text: #111827;
        --text-muted: #6b7280;
        --radius-sm: 6px;
        --radius-md: 10px;
        --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.06);
        --shadow-md: 0 4px 6px rgba(15, 23, 42, 0.08);
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html, body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      /* Body untuk halaman login */
      body.login-page {
        background: radial-gradient(circle at top left, #e0f2fe 0, #eef2ff 35%, #f9fafb 70%, #f3f4f6 100%);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Body untuk halaman app */
      body.app-page {
        background: radial-gradient(circle at top left, #e0f2fe 0, #eef2ff 35%, #f9fafb 70%, #f3f4f6 100%);
        min-height: 100vh;
      }

      /* LOGIN STYLES */
      #login-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        padding: 20px;
        width: 100%;
      }

      .login-card {
        background: #ffffff;
        width: 100%;
        max-width: 360px;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.8);
        text-align: center;
        margin-bottom: 60px;
      }

      .login-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text);
      }

      .login-subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 24px;
      }

      .login-form input {
        margin-bottom: 12px;
        width: 100%;
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-strong);
        font-size: 14px;
      }

      .login-btn {
        width: 100%;
        margin-top: 8px;
        padding: 10px;
        font-size: 14px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
      }

      .login-btn:hover {
        background: var(--primary-hover);
      }

      /* Password wrapper styles */
      .password-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .password-wrapper input {
        flex: 1;
        padding-right: 40px;
        margin-bottom: 0;
      }

      .toggle-password {
        position: absolute;
        right: 8px;
        background: transparent;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 100%;
      }

      .toggle-password:hover {
        color: var(--primary);
        background: transparent;
        box-shadow: none;
      }

      /* APP STYLES */
      .app-shell {
        max-width: 1200px;
        margin: 24px auto 40px;
        padding: 0 16px;
        display: none;
      }

      .app-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 16px;
      }

      .app-title {
        margin: 0;
        font-size: 20px;
        font-weight: 650;
        color: var(--text);
      }

      .app-subtitle {
        margin: 2px 0 0;
        font-size: 13px;
        color: var(--text-muted);
        max-width: 520px;
      }

      .app-badge {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--primary-soft);
        color: var(--primary);
        border: 1px solid rgba(37, 99, 235, 0.25);
        align-self: flex-start;
        white-space: nowrap;
        cursor: pointer;
      }

      /* Tabs */
      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 6px;
        background: rgba(255,255,255,0.9);
        border-radius: 999px;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(148, 163, 184, 0.4);
        position: sticky;
        top: 12px;
        z-index: 50;
        backdrop-filter: blur(10px);
      }

      .tab-button {
        flex: 1 1 auto;
        border-radius: 999px;
        border: none;
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 500;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease, box-shadow 0.15s;
        white-space: nowrap;
      }

      .tab-button:hover {
        background: rgba(15,23,42,0.04);
        color: var(--text);
      }

      .tab-button.active {
        background: #ffffff;
        color: var(--primary);
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
      }

      .tab-content {
        margin-top: 18px;
        padding: 16px 18px 20px;
        background: rgba(255,255,255,0.95);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
      }

      .section-header {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-bottom: 10px;
      }

      .section-header h2 {
        margin: 0;
        font-size: 17px;
        font-weight: 600;
      }

      .section-subtitle {
        margin: 0;
        font-size: 12px;
        color: var(--text-muted);
      }

      /* Forms */
      form {
        margin-bottom: 16px;
        padding: 14px 16px 16px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        background: var(--surface);
        box-shadow: var(--shadow-sm);
        max-width: 900px;
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: var(--text);
        margin-bottom: 10px;
      }

      label > input,
      label > select,
      label > textarea {
        margin-top: 4px;
      }

      input[type="text"],
      input[type="password"],
      input[type="tel"],
      input[type="number"],
      input[type="datetime-local"],
      select,
      textarea {
        width: 100%;
        padding: 7px 9px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-strong);
        background: var(--surface-alt);
        font-size: 13px;
        color: var(--text);
        transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      }

      input[type="text"]:focus,
      input[type="password"]:focus,
      input[type="tel"]:focus,
      input[type="number"]:focus,
      input[type="datetime-local"]:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 1px var(--primary-soft);
        background: #ffffff;
      }

      textarea {
        resize: vertical;
        min-height: 70px;
      }

      input[readonly] {
        background: #f3f4f6;
        color: var(--text-muted);
      }

      /* Buttons */
      button {
        border-radius: 999px;
        border: none;
        padding: 7px 14px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        background: var(--primary);
        color: #ffffff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: background-color 0.15s ease, box-shadow 0.15s ease, transform 0.04s ease;
      }

      button:hover {
        background: var(--primary-hover);
        box-shadow: 0 3px 6px rgba(37, 99, 235, 0.25);
      }

      button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.25);
      }

      button[disabled] {
        opacity: 0.65;
        cursor: default;
        box-shadow: none;
      }

      button[onclick^="delete"],
      button[onclick^="hapus"],
      button[onclick^="deleteSelected"] {
        background: var(--danger);
      }

      button[onclick^="delete"]:hover,
      button[onclick^="hapus"]:hover,
      button[onclick^="deleteSelected"]:hover {
        background: var(--danger-hover);
        box-shadow: 0 3px 6px rgba(220, 38, 38, 0.24);
      }

      button[onclick*="resetJawaban"],
      button[onclick*="Reset"] {
        background: var(--warning);
      }

      button[onclick*="resetJawaban"]:hover,
      button[onclick*="Reset"]:hover {
        background: var(--warning-hover);
        box-shadow: 0 3px 6px rgba(245, 158, 11, 0.25);
      }

      button[onclick="generateTokenUjian()"] {
        background: #0f172a;
      }

      button[onclick="generateTokenUjian()"]:hover {
        background: #020617;
      }

      .actions button {
        padding: 4px 10px;
        font-size: 12px;
      }

      /* Tables */
      .table-card {
        margin-top: 4px;
        padding: 10px 12px 12px;
        border-radius: var(--radius-md);
        background: var(--surface);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
      }

      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
        min-width: 700px;
      }

      th, td {
        border-bottom: 1px solid var(--border);
        padding: 7px 8px;
        text-align: left;
      }

      th {
        background: var(--surface-alt);
        font-weight: 600;
        color: var(--text-muted);
        position: sticky;
        top: 0;
        z-index: 1;
      }

      tbody tr:nth-child(even) {
        background: #f9fafb;
      }

      tbody tr:hover {
        background: #eff6ff;
      }

      th:first-child,
      td:first-child {
        padding-left: 10px;
      }

      th:last-child,
      td:last-child {
        padding-right: 10px;
      }

      th input[type="checkbox"] {
        transform: translateY(1px);
      }

      /* Bank Soal sections */
      #group-pg,
      #group-pernyataan,
      #group-pejodohan {
        border-radius: var(--radius-sm);
        border: 1px dashed var(--border-strong);
        background: #f9fafb;
        padding: 12px;
        margin-top: 8px;
      }

      #group-pg strong,
      #group-pernyataan strong,
      #group-pejodohan strong {
        font-size: 13px;
        color: var(--text);
        display: block;
        margin-bottom: 8px;
      }

      /* Kartu Peserta - Print Styles */
      .kartu-container {
        page-break-inside: avoid;
        border: 2px solid #111827;
        padding: 16px;
        margin: 12px auto;
        width: 8.5cm;
        height: 12cm;
        font-size: 13px;
        background: #ffffff;
        font-family: "Segoe UI", system-ui, sans-serif;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .kartu-logo {
        text-align: center;
        margin-bottom: 8px;
        color: #2563eb;
        font-weight: bold;
        font-size: 14px;
      }

      .kartu-header {
        text-align: center;
        font-weight: 700;
        margin-bottom: 8px;
        border-bottom: 3px double #111827;
        padding-bottom: 8px;
        letter-spacing: 0.05em;
        font-size: 16px;
        color: #1e293b;
      }

      .kartu-title {
        text-align: center;
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 12px;
        color: #2563eb;
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        padding: 4px 0;
      }

      .kartu-table {
        width: 100%;
        border-collapse: collapse;
        margin: 8px 0;
      }

      .kartu-table td {
        padding: 6px 4px;
        vertical-align: top;
        border-bottom: 1px solid #e5e7eb;
      }

      .kartu-table td.label {
        width: 45%;
        font-weight: 600;
        color: #374151;
      }

      .kartu-table tr:last-child td {
        border-bottom: none;
      }

      .kartu-footer {
        margin-top: 12px;
        font-size: 10px;
        color: #6b7280;
        text-align: center;
        padding: 8px;
        border-top: 1px dashed #d1d5db;
        background: #f9fafb;
        border-radius: 6px;
      }

      .kartu-watermark {
        position: absolute;
        bottom: 8px;
        right: 8px;
        font-size: 9px;
        color: #9ca3af;
        font-style: italic;
      }

      /* Print area */
      #printArea {
        display: none;
      }

      @media print {
        body * {
          visibility: hidden;
        }
        #printArea,
        #printArea * {
          visibility: visible;
        }
        #printArea {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          margin: 0;
          padding: 20px;
          display: grid !important;
          grid-template-columns: repeat(2, 1fr);
          gap: 16px;
        }
        
        .kartu-container {
          width: 100% !important;
          height: auto !important;
          margin: 0 !important;
          break-inside: avoid;
          box-shadow: none !important;
          border: 1.5px solid #000 !important;
        }
        
        @page {
          margin: 15mm;
          size: A4 portrait;
        }
      }

      /* Modal */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-backdrop.show {
        display: flex;
      }

      .modal {
        background: #ffffff;
        border-radius: 12px;
        width: 100%;
        max-width: 720px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
        border: 1px solid rgba(148, 163, 184, 0.6);
      }

      .modal-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .modal-title {
        font-size: 15px;
        font-weight: 600;
      }

      .modal-close-btn {
        border-radius: 999px;
        border: none;
        width: 26px;
        height: 26px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 18px;
        padding: 0;
      }

      .modal-close-btn:hover {
        background: rgba(15,23,42,0.05);
        color: var(--text);
      }

      .modal-body {
        padding: 12px 16px 14px;
        overflow: auto;
      }

      .modal-body form {
        box-shadow: none;
        border: none;
        padding: 0;
        margin: 0;
        max-width: 100%;
      }

      @media (max-width: 768px) {
        .app-shell {
          margin: 16px auto 24px;
          padding: 0 10px;
        }
        .tab-content {
          padding: 12px 12px 16px;
        }
        .app-header {
          margin-bottom: 10px;
        }
        .tabs {
          border-radius: 16px;
        }
        table {
          min-width: 600px;
        }
        .kartu-container {
          width: 100%;
          height: auto;
        }
      }

      @media (max-width: 480px) {
        .tabs {
          flex-wrap: nowrap;
          overflow-x: auto;
        }
        .tab-button {
          flex: 0 0 auto;
        }
      }

      /* ====== MODERN NOTIFICATION SYSTEM ====== */
      .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 99999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
        pointer-events: none;
      }

      .notification {
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        border-left: 5px solid;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        transform: translateX(120%);
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        pointer-events: auto;
        max-width: 380px;
        min-width: 300px;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.hide {
        transform: translateX(120%);
      }

      .notification-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 14px;
        font-weight: bold;
      }

      .notification-content {
        flex: 1;
        min-width: 0;
      }

      .notification-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        color: #111827;
      }

      .notification-message {
        font-size: 13px;
        color: #4b5563;
        line-height: 1.4;
      }

      .notification-close {
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 4px;
        font-size: 18px;
        line-height: 1;
        flex-shrink: 0;
        transition: color 0.2s;
      }

      .notification-close:hover {
        color: #6b7280;
      }

      /* Notification Types */
      .notification.success {
        border-left-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4, #ffffff);
      }

      .notification.success .notification-icon {
        background: #10b981;
        color: white;
      }

      .notification.error {
        border-left-color: #ef4444;
        background: linear-gradient(135deg, #fef2f2, #ffffff);
      }

      .notification.error .notification-icon {
        background: #ef4444;
        color: white;
      }

      .notification.warning {
        border-left-color: #f59e0b;
        background: linear-gradient(135deg, #fffbeb, #ffffff);
      }

      .notification.warning .notification-icon {
        background: #f59e0b;
        color: white;
      }

      .notification.info {
        border-left-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff, #ffffff);
      }

      .notification.info .notification-icon {
        background: #3b82f6;
        color: white;
      }

      /* Progress bar */
      .notification-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 0 0 12px 12px;
        overflow: hidden;
      }

      .notification-progress-bar {
        height: 100%;
        width: 100%;
        transform-origin: left;
        transform: scaleX(1);
        transition: transform linear;
      }

      .notification.success .notification-progress-bar {
        background: #10b981;
      }

      .notification.error .notification-progress-bar {
        background: #ef4444;
      }

      .notification.warning .notification-progress-bar {
        background: #f59e0b;
      }

      .notification.info .notification-progress-bar {
        background: #3b82f6;
      }

      /* Confirmation Dialog */
      .confirmation-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.75);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(4px);
      }

      .confirmation-dialog.show {
        display: flex;
      }

      .confirmation-box {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
        animation: dialogSlideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }

      @keyframes dialogSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .confirmation-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        font-size: 28px;
      }

      .confirmation-icon.warning {
        background: #fef3c7;
        color: #f59e0b;
      }

      .confirmation-icon.info {
        background: #dbeafe;
        color: #3b82f6;
      }

      .confirmation-title {
        font-size: 18px;
        font-weight: 600;
        text-align: center;
        margin-bottom: 8px;
        color: #111827;
      }

      .confirmation-message {
        font-size: 14px;
        color: #6b7280;
        text-align: center;
        margin-bottom: 24px;
        line-height: 1.5;
      }

      .confirmation-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .confirmation-btn {
        padding: 10px 24px;
        border-radius: 999px;
        border: none;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 100px;
      }

      .confirmation-btn.cancel {
        background: #f3f4f6;
        color: #4b5563;
      }

      .confirmation-btn.cancel:hover {
        background: #e5e7eb;
      }

      .confirmation-btn.confirm {
        background: #3b82f6;
        color: white;
      }

      .confirmation-btn.confirm:hover {
        background: #2563eb;
      }

      .confirmation-btn.confirm.delete {
        background: #ef4444;
      }

      .confirmation-btn.confirm.delete:hover {
        background: #dc2626;
      }

      .confirmation-btn.confirm.warning {
        background: #f59e0b;
      }

      .confirmation-btn.confirm.warning:hover {
        background: #d97706;
      }

      /* Toast Notification */
      .toast-notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: #1f2937;
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 14px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 90%;
      }

      .toast-notification.show {
        transform: translateX(-50%) translateY(0);
      }

      .toast-icon {
        font-size: 18px;
      }

      .toast-message {
        flex: 1;
      }

      /* ====== FOOTER STYLES ====== */
      .site-footer {
        padding: 16px;
        text-align: center;
        font-size: 13px;
        color: var(--text-muted);
        border-top: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        width: 100%;
        margin-top: auto;
      }

      .footer-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .footer-text {
        font-weight: 500;
        color: var(--primary);
        letter-spacing: 0.5px;
      }

      .footer-subtext {
        font-size: 11px;
        color: var(--text-muted);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .site-footer {
          margin-top: 20px;
          padding: 12px;
          font-size: 12px;
        }
        
        .footer-subtext {
          font-size: 10px;
        }
      }

      /* Image preview */
      .image-preview {
        margin-top: 10px;
        max-width: 200px;
        max-height: 150px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        object-fit: contain;
      }

      .preview-container {
        margin-top: 8px;
      }

      /* Style untuk checkbox mapel di modal reset */
      .reset-mapel-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
      }

      .reset-mapel-item:hover {
        background: #f3f4f6;
      }

      .reset-mapel-item input[type="checkbox"] {
        transform: scale(1.2);
      }

      .reset-mapel-item label {
        flex: 1;
        margin: 0;
        cursor: pointer;
        font-size: 13px;
      }

      .reset-mapel-count {
        font-size: 11px;
        color: var(--text-muted);
        background: var(--surface-alt);
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: auto;
      }

      /* Badge untuk jumlah jawaban */
      .jawaban-badge {
        font-size: 10px;
        background: #10b981;
        color: white;
        padding: 1px 6px;
        border-radius: 10px;
        margin-left: 4px;
        vertical-align: middle;
      }
    </style>
  </head>
  <body class="login-page">

    <!-- LOGIN SECTION (sama seperti sebelumnya) -->
    <div id="login-section">
      <div class="login-card">
        <div class="login-title">Login Admin</div>
        <div class="login-subtitle">Portal Admin CBT 2026</div>
        <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
          <input type="text" id="login_username" placeholder="Username" required>
          
          <div class="password-wrapper">
            <input type="password" id="login_password" placeholder="Password" required>
            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('login_password', this)">
              üëÅÔ∏è
            </button>
          </div>
          
          <button type="submit" class="login-btn">Masuk</button>
        </form>
      </div>
    </div>

    <!-- MAIN APP SHELL (sama seperti sebelumnya) -->
    <div class="app-shell" id="app-shell">
      <!-- [Semua HTML untuk UI tetap sama] -->
    </div>

    <!-- MODALS (sama seperti sebelumnya) -->
    <!-- ... semua modal tetap sama ... -->

    <!-- Modern Notification System (sama) -->
    <div class="notification-container" id="notificationContainer"></div>
    <div class="confirmation-dialog" id="confirmationDialog">
      <div class="confirmation-box">
        <div class="confirmation-icon warning">‚ö†Ô∏è</div>
        <h3 class="confirmation-title" id="dialogTitle">Konfirmasi</h3>
        <p class="confirmation-message" id="dialogMessage">Apakah Anda yakin?</p>
        <div class="confirmation-buttons">
          <button class="confirmation-btn cancel" onclick="hideConfirmation()">Batal</button>
          <button class="confirmation-btn confirm" id="confirmActionBtn">Ya, Lanjutkan</button>
        </div>
      </div>
    </div>
    <div class="toast-notification" id="toastNotification">
      <span class="toast-icon">üìã</span>
      <span class="toast-message" id="toastMessage">Pesan toast</span>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-text">Developed by D14nr ¬© 2026</div>
        <div class="footer-subtext">Portal Admin CBT 2026</div>
      </div>
    </footer>

    <!-- Area khusus untuk print kartu -->
    <div id="printArea"></div>

    <script>
      // ====== KONFIGURASI SUPABASE ======
      const SUPABASE_URL = 'https://ffitekntuuratjfyccwd.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmaXRla250dXVyYXRqZnljY3dkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODUwNzU0NywiZXhwIjoyMDg0MDgzNTQ3fQ.5GAynFyNRB0IJcOsr1EZSB9p3zbR39jDM4I0zL8Nrao';

      // ====== GOOGLE APPS SCRIPT URL ======
      const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwOXJ-kL-ywDQv-GAe4bDlngnTN7ljOr6fTdtz3a6O0x-JTgyo/exec';

      // ====== INISIALISASI SUPABASE ======
      let supabase;

      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase initialized successfully');
      } catch (error) {
        console.error('Supabase initialization error:', error);
        showNotification('error', 'Database Error', 'Gagal menginisialisasi database. Periksa koneksi internet.');
      }

      // ====== VARIABEL GLOBAL ======
      let pesertaNameMap = {};
      let currentAgendaForMapel = '';
      let currentAgendaForBank = '';
      let importBankSoalMapelMap = {};
      let currentMapelForBank = '';
      let currentAgendaForKartu = '';
      let kartuPesertaList = [];
      let agendaCache = {};
      let selectedJawabanForReset = null;
      let resetMapelList = [];

      // ====== UTILITY FUNCTIONS ======
      // [Semua fungsi utility tetap sama seperti sebelumnya]
      // showNotification, closeNotification, hideAllNotifications, showConfirmation, hideConfirmation
      // fileToBase64, uploadToGoogleDrive, previewImage
      // ... (sama seperti kode sebelumnya)

      // ====== LOGIN FUNCTIONS ======
      function checkLoginStatus() {
        const loggedIn = sessionStorage.getItem('adminLoggedIn');
        
        if (loggedIn === 'true') {
          document.body.className = 'app-page';
          showApp();
        } else {
          document.body.className = 'login-page';
          showLogin();
        }
      }

      function handleLogin() {
        const username = document.getElementById('login_username').value;
        const password = document.getElementById('login_password').value;

        const validCredentials = [
          { user: 'Admin', pass: '290192' },
          { user: 'admin', pass: 'admin123' }
        ];
        
        const isValid = validCredentials.some(cred => 
          cred.user === username && cred.pass === password
        );
        
        if (isValid) {
          sessionStorage.setItem('adminLoggedIn', 'true');
          document.body.className = 'app-page';
          showApp();
          showNotification('success', 'Login Berhasil', 'Selamat datang di Portal Admin CBT 2026');
        } else {
          showNotification('error', 'Login Gagal', 'Username atau Password salah!');
          document.getElementById('login_password').value = '';
          document.getElementById('login_password').focus();
        }
      }

      function handleLogout() {
        showConfirmation(
          'Konfirmasi Logout',
          'Apakah Anda yakin ingin keluar dari sistem?',
          function() {
            sessionStorage.removeItem('adminLoggedIn');
            document.body.className = 'login-page';
            showLogin();
            showNotification('success', 'Logout Berhasil', 'Anda telah berhasil logout');
          }
        );
      }

      function showApp() {
        const loginSection = document.getElementById('login-section');
        const appShell = document.getElementById('app-shell');
        
        loginSection.style.display = 'none';
        appShell.style.display = 'block';
        
        loadPeserta();
        loadAgenda();
        loadAgendaListForPeserta();
        loadAgendaListForMapelDropdown();
        loadAgendaListForBankSoalDropdown();
        loadAgendaListForCetakKartuDropdown();
        loadMonitoring();
        loadJawaban();
        showTab('peserta');
      }

      function showLogin() {
        const loginSection = document.getElementById('login-section');
        const appShell = document.getElementById('app-shell');
        
        loginSection.style.display = 'flex';
        appShell.style.display = 'none';
        
        document.getElementById('login_username').value = '';
        document.getElementById('login_password').value = '';
      }

      // ====== TAB FUNCTIONS ======
      function showTab(tab) {
        const tabs = ['peserta', 'agenda', 'mapel', 'banksoal', 'monitoring', 'jawaban', 'cetakkartu'];
        tabs.forEach(name => {
          document.getElementById('tab-' + name).style.display =
            (tab === name) ? 'block' : 'none';
          document.getElementById('tab-btn-' + name).classList.toggle('active', tab === name);
        });
      }

      // ====== PESERTA FUNCTIONS (SUPABASE) ======
      function generateNISFromNoWA(noWa) {
        if (!noWa) return '';
        let digits = noWa.replace(/\D/g, '');
        if (digits.startsWith('0')) {
          digits = digits.substring(1);
        } else if (digits.startsWith('62')) {
          digits = digits.substring(2);
        }
        return digits;
      }

      function handleNoWAChange() {
        const noWa = document.getElementById('No_WA_Peserta').value;
        const nis = generateNISFromNoWA(noWa);
        document.getElementById('NIS_Username').value = nis;
      }

      async function loadPeserta() {
        try {
          const { data, error } = await supabase
            .from('peserta')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;

          const tbody = document.querySelector('#pesertaTable tbody');
          tbody.innerHTML = '';
          pesertaNameMap = {};

          data.forEach(peserta => {
            pesertaNameMap[peserta.nis_username] = peserta.nama_peserta || peserta.nis_username;

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${peserta.nis_username || ''}</td>
              <td>${peserta.nama_peserta || ''}</td>
              <td>
                <div class="password-wrapper" style="position: relative; display: inline-block; width: 120px;">
                  <input type="password" value="${peserta.password || ''}" readonly 
                         style="width: 100%; padding-right: 30px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; padding: 4px 30px 4px 8px;">
                  <button type="button" class="toggle-password" onclick="togglePasswordVisibility(this.previousElementSibling, this)" 
                          style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; font-size: 11px; padding: 0;">
                    üëÅÔ∏è
                  </button>
                </div>
              </td>
              <td>${peserta.jenjang_studi || ''}</td>
              <td>${peserta.kelas || ''}</td>
              <td>${peserta.asal_sekolah || ''}</td>
              <td>${peserta.no_wa_peserta || ''}</td>
              <td>${peserta.no_wa_ortu || ''}</td>
              <td class="actions">
                <button onclick="editPeserta('${peserta.id}')">Edit</button>
                <button onclick="deletePeserta('${peserta.id}')">Hapus</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          showNotification('error', 'Error', 'Gagal membaca data peserta: ' + error.message);
        }
      }

      function openPesertaModalForCreate() {
        resetForm();
        showModal('modal-peserta');
      }

      async function savePeserta() {
        try {
          const firebaseId = document.getElementById('firebaseId').value;
          const Nama_Peserta = document.getElementById('Nama_Peserta').value.trim();
          const Password = document.getElementById('Password').value.trim();
          const Jenjang_Studi = document.getElementById('Jenjang_Studi').value.trim();
          const Kelas = document.getElementById('Kelas').value.trim();
          const Asal_Sekolah = document.getElementById('Asal_Sekolah').value.trim();
          const No_WA_Peserta = document.getElementById('No_WA_Peserta').value.trim();
          const No_WA_Ortu = document.getElementById('No_WA_Ortu').value.trim();
          const ID_Agenda = document.getElementById('ID_Agenda_Peserta').value.trim();

          const NIS_Username = generateNISFromNoWA(No_WA_Peserta);
          document.getElementById('NIS_Username').value = NIS_Username;

          if (!Nama_Peserta || !Password || !Jenjang_Studi || !Kelas ||
              !Asal_Sekolah || !No_WA_Peserta || !No_WA_Ortu || !ID_Agenda || !NIS_Username) {
            showNotification('error', 'Validasi Error', 'Mohon lengkapi semua field');
            return;
          }

          const pesertaData = {
            nis_username: NIS_Username,
            nama_peserta: Nama_Peserta,
            password: Password,
            jenjang_studi: Jenjang_Studi,
            kelas: Kelas,
            asal_sekolah: Asal_Sekolah,
            no_wa_peserta: No_WA_Peserta,
            no_wa_ortu: No_WA_Ortu,
            id_agenda: ID_Agenda,
            tanggal_daftar: new Date().toISOString(),
            status: 'Aktif'
          };

          if (firebaseId) {
            // Update existing peserta
            const { error } = await supabase
              .from('peserta')
              .update(pesertaData)
              .eq('id', firebaseId);

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Data peserta berhasil diperbarui');
          } else {
            // Insert new peserta
            const { data, error } = await supabase
              .from('peserta')
              .insert([pesertaData])
              .select();

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Data peserta berhasil disimpan');
            document.getElementById('ID_Peserta').value = data[0].id;
          }

          resetForm();
          hideModal('modal-peserta');
          loadPeserta();
          
        } catch (error) {
          showNotification('error', 'Gagal', 'Gagal menyimpan peserta: ' + error.message);
        }
      }

      async function editPeserta(id) {
        try {
          const { data, error } = await supabase
            .from('peserta')
            .select('*')
            .eq('id', id)
            .single();

          if (error) throw error;

          document.getElementById('firebaseId').value = id;
          document.getElementById('ID_Peserta').value = data.id;
          document.getElementById('NIS_Username').value = data.nis_username || '';
          document.getElementById('Nama_Peserta').value = data.nama_peserta || '';
          document.getElementById('Password').value = data.password || '';
          document.getElementById('Jenjang_Studi').value = data.jenjang_studi || '';
          document.getElementById('Kelas').value = data.kelas || '';
          document.getElementById('Asal_Sekolah').value = data.asal_sekolah || '';
          document.getElementById('No_WA_Peserta').value = data.no_wa_peserta || '';
          document.getElementById('No_WA_Ortu').value = data.no_wa_ortu || '';
          document.getElementById('ID_Agenda_Peserta').value = data.id_agenda || '';
          
          showModal('modal-peserta');
        } catch (error) {
          showNotification('error', 'Gagal', 'Gagal mengambil data peserta: ' + error.message);
        }
      }

      async function deletePeserta(id) {
        showConfirmation(
          'Hapus Peserta',
          'Apakah Anda yakin ingin menghapus data peserta ini?',
          async function() {
            try {
              const { error } = await supabase
                .from('peserta')
                .delete()
                .eq('id', id);

              if (error) throw error;
              
              showNotification('success', 'Berhasil', 'Data peserta berhasil dihapus');
              loadPeserta();
            } catch (error) {
              showNotification('error', 'Gagal', 'Gagal menghapus peserta: ' + error.message);
            }
          }
        );
      }

      function resetForm() {
        document.getElementById('firebaseId').value = '';
        document.getElementById('pesertaForm').reset();
        document.getElementById('ID_Peserta').value = '';
        document.getElementById('NIS_Username').value = '';
      }

      // ====== AGENDA FUNCTIONS (SUPABASE) ======
      // Note: Tabel agenda_ujian tidak ada di struktur yang diberikan
      // Saya akan asumsikan tabel agenda_ujian dengan kolom:
      // id, agenda_ujian, deskripsi_ujian, jenjang_studi, jenis_tes, tgljam_mulai, tgljam_selesai, token_ujian

      async function loadAgenda() {
        try {
          const { data, error } = await supabase
            .from('agenda_ujian')
            .select('*')
            .order('tgljam_mulai', { ascending: false });
          
          if (error) throw error;

          const tbody = document.querySelector('#agendaTable tbody');
          tbody.innerHTML = '';
          agendaCache = {};
          
          data.forEach(agenda => {
            agendaCache[agenda.id] = agenda;
            
            const mulai = agenda.tgljam_mulai ? new Date(agenda.tgljam_mulai).toLocaleString() : '';
            const selesai = agenda.tgljam_selesai ? new Date(agenda.tgljam_selesai).toLocaleString() : '';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${agenda.agenda_ujian || ''}</td>
              <td>${agenda.deskripsi_ujian || ''}</td>
              <td>${agenda.jenjang_studi || ''}</td>
              <td>${agenda.jenis_tes || ''}</td>
              <td>${mulai}</td>
              <td>${selesai}</td>
              <td>${agenda.token_ujian || ''}</td>
              <td class="actions">
                <button onclick="editAgenda('${agenda.id}')">Edit</button>
                <button onclick="deleteAgenda('${agenda.id}')">Hapus</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          showNotification('error', 'Error', 'Gagal membaca data agenda: ' + error.message);
        }
      }

      async function loadAgendaListForPeserta() {
        const select = document.getElementById('ID_Agenda_Peserta');
        
        try {
          const { data, error } = await supabase
            .from('agenda_ujian')
            .select('id, agenda_ujian, jenjang_studi')
            .order('agenda_ujian');
          
          if (error) throw error;

          const currentValue = select.value;
          select.innerHTML = '<option value="">-- Pilih Agenda --</option>';
          
          data.forEach(agenda => {
            const opt = document.createElement('option');
            opt.value = agenda.id;
            let label = agenda.agenda_ujian || agenda.id;
            if (agenda.jenjang_studi) label += ' (' + agenda.jenjang_studi + ')';
            opt.textContent = label;
            select.appendChild(opt);
          });
          
          if (currentValue) select.value = currentValue;
        } catch (error) {
          console.error('Error loading agenda list:', error);
        }
      }

      // Fungsi loadAgendaListForMapelDropdown, loadAgendaListForBankSoalDropdown, loadAgendaListForCetakKartuDropdown
      // akan menggunakan query yang sama seperti loadAgendaListForPeserta

      function generateRandomToken() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        const length = 6 + Math.floor(Math.random() * 3);
        let token = '';
        for (let i = 0; i < length; i++) {
          token += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return token;
      }

      function generateTokenUjian() {
        const token = generateRandomToken();
        document.getElementById('Token_Ujian').value = token;
      }

      // [Fungsi-fungsi untuk agenda lainnya akan menggunakan pola yang sama seperti peserta]

      // ====== MATA PELAJARAN FUNCTIONS (SUPABASE) ======
      async function loadMapelTable() {
        const tbody = document.querySelector('#mapelTable tbody');
        tbody.innerHTML = '';
        
        if (!currentAgendaForMapel) return;
        
        try {
          const { data, error } = await supabase
            .from('mata_pelajaran')
            .select('*')
            .eq('id_agenda', currentAgendaForMapel)
            .order('nama_mata_pelajaran');
          
          if (error) throw error;

          data.forEach(mapel => {
            const isSiap = mapel.status_mapel === 'Siap';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${mapel.nama_mata_pelajaran || ''}</td>
              <td>${mapel.jumlah_soal || ''}</td>
              <td>${mapel.durasi_ujian || ''}</td>
              <td>
                <label style="display:flex; align-items:center; gap:4px; font-weight:400;">
                  <input type="checkbox" ${isSiap ? 'checked' : ''} 
                         onchange="toggleStatusMapel('${mapel.id}', this.checked)">
                  <span>${isSiap ? 'Siap' : 'Draft'}</span>
                </label>
              </td>
              <td class="actions">
                <button onclick="editMapel('${mapel.id}')">Edit</button>
                <button onclick="deleteMapel('${mapel.id}')">Hapus</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          showNotification('error', 'Error', 'Gagal membaca data mapel: ' + error.message);
        }
      }

      async function saveMapel() {
        try {
          const mapelId = document.getElementById('firebaseMapelId').value;
          const ID_Agenda = currentAgendaForMapel;
          
          if (!ID_Agenda) {
            showNotification('error', 'Error', 'Pilih Agenda Ujian terlebih dahulu');
            return;
          }
          
          const Nama_Mata_Pelajaran = document.getElementById('Nama_Mata_Pelajaran').value.trim();
          const Jumlah_Soal = parseInt(document.getElementById('Jumlah_Soal').value) || 0;
          const Durasi_Ujian = parseInt(document.getElementById('Durasi_Ujian').value) || 0;
          let Status_Mapel = document.getElementById('Status_Mapel').value || 'Draft';

          if (!Nama_Mata_Pelajaran || !Jumlah_Soal || !Durasi_Ujian) {
            showNotification('error', 'Validasi Error', 'Mohon lengkapi semua field mata pelajaran');
            return;
          }
          
          const mapelData = {
            nama_mata_pelajaran: Nama_Mata_Pelajaran,
            id_agenda: ID_Agenda,
            jumlah_soal: Jumlah_Soal,
            durasi_ujian: Durasi_Ujian,
            status_mapel: Status_Mapel,
            updated_at: new Date().toISOString()
          };
          
          if (mapelId) {
            // Update existing mapel
            const { error } = await supabase
              .from('mata_pelajaran')
              .update(mapelData)
              .eq('id', mapelId);

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Mata pelajaran berhasil diperbarui');
          } else {
            // Insert new mapel
            mapelData.created_at = new Date().toISOString();
            const { data, error } = await supabase
              .from('mata_pelajaran')
              .insert([mapelData])
              .select();

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Mata pelajaran berhasil disimpan');
            document.getElementById('ID_Mapel_Mapel').value = data[0].id;
          }
          
          resetMapelForm(false);
          loadMapelTable();
          hideModal('modal-mapel');
          
        } catch (error) {
          showNotification('error', 'Gagal', 'Gagal menyimpan mapel: ' + error.message);
        }
      }

      // [Fungsi-fungsi untuk mapel lainnya akan menggunakan pola yang sama]

      // ====== BANK SOAL FUNCTIONS (SUPABASE) ======
      async function loadBankSoalTable() {
        const tbody = document.querySelector('#bankSoalTable tbody');
        tbody.innerHTML = '';
        
        if (!currentMapelForBank) return;
        
        try {
          const { data, error } = await supabase
            .from('bank_soal')
            .select('*')
            .eq('id_mapel', currentMapelForBank)
            .order('no_soal');
          
          if (error) throw error;

          data.forEach(soal => {
            const tr = document.createElement('tr');
            const pertSingkat = (soal.pertanyaan || '').length > 80
              ? soal.pertanyaan.substring(0, 80) + '...'
              : (soal.pertanyaan || '');
            
            const gambarCell = soal.gambar_url
              ? `<a href="${soal.gambar_url}" target="_blank" title="Lihat gambar">üì∑</a>` : '';
            
            tr.innerHTML = `
              <td><input type="checkbox" class="banksoal-checkbox" value="${soal.id}"></td>
              <td>${soal.no_soal || ''}</td>
              <td>${soal.type_soal || ''}</td>
              <td>${pertSingkat}</td>
              <td>${gambarCell}</td>
              <td class="actions">
                <button onclick="editSoal('${soal.id}')">Edit</button>
                <button onclick="deleteSoal('${soal.id}')">Hapus</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          showNotification('error', 'Error', 'Gagal membaca bank soal: ' + error.message);
        }
      }

      async function saveSoal() {
        if (!currentAgendaForBank || !currentMapelForBank) {
          showNotification('error', 'Error', 'Pilih Agenda Ujian dan Mata Pelajaran terlebih dahulu');
          return;
        }
        
        try {
          const soalId = document.getElementById('firebaseSoalId').value;
          const No_Soal = parseInt(document.getElementById('No_Soal').value) || 0;
          const Pertanyaan = document.getElementById('Pertanyaan').value.trim();
          const Type_Soal = document.getElementById('Type_Soal').value;
          
          if (!No_Soal || !Pertanyaan || !Type_Soal) {
            showNotification('error', 'Validasi Error', 'No Soal, Pertanyaan, dan Type Soal wajib diisi');
            return;
          }
          
          const soalData = {
            id_mapel: currentMapelForBank,
            no_soal: No_Soal,
            type_soal: Type_Soal,
            pertanyaan: Pertanyaan,
            pilihan_a: document.getElementById('Pilihan_A').value.trim(),
            pilihan_b: document.getElementById('Pilihan_B').value.trim(),
            pilihan_c: document.getElementById('Pilihan_C').value.trim(),
            pilihan_d: document.getElementById('Pilihan_D').value.trim(),
            pilihan_e: document.getElementById('Pilihan_E').value.trim(),
            updated_at: new Date().toISOString()
          };
          
          // Tambahkan pernyataan
          for (let i = 1; i <= 10; i++) {
            soalData['pernyataan_' + i] = document.getElementById('Pernyataan_' + i)?.value.trim() || '';
          }
          
          // Tambahkan pejodohan
          for (let j = 1; j <= 10; j++) {
            soalData['pernyataan_kiri_' + j] = document.getElementById('Pasangan_kiri_' + j)?.value.trim() || '';
            soalData['pernyataan_kanan_' + j] = document.getElementById('Pasangan_kanan_' + j)?.value.trim() || '';
          }
          
          const fileInput = document.getElementById('Gambar');
          const file = fileInput.files[0];
          const existingUrl = document.getElementById('Gambar_Url').value || '';
          
          if (file) {
            showNotification('info', 'Upload Gambar', 'Sedang mengupload gambar...', 0);
            
            const context = {
              agenda: currentAgendaForBank,
              mapel: currentMapelForBank,
              noSoal: No_Soal
            };
            
            const imageUrl = await uploadToGoogleDrive(file, context);
            soalData.gambar_url = imageUrl;
          } else {
            soalData.gambar_url = existingUrl;
          }
          
          if (soalId) {
            // Update existing soal
            const { error } = await supabase
              .from('bank_soal')
              .update(soalData)
              .eq('id', soalId);

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Soal berhasil diperbarui');
          } else {
            // Insert new soal
            soalData.created_at = new Date().toISOString();
            const { error } = await supabase
              .from('bank_soal')
              .insert([soalData]);

            if (error) throw error;
            
            showNotification('success', 'Berhasil', 'Soal berhasil disimpan');
          }
          
          resetBankSoalForm(false);
          loadBankSoalTable();
          hideModal('modal-banksoal');
          
        } catch (error) {
          console.error('Save soal error:', error);
          showNotification('error', 'Gagal', 'Gagal menyimpan soal: ' + error.message);
        } finally {
          hideAllNotifications();
        }
      }

      // [Fungsi-fungsi untuk bank soal lainnya akan menggunakan pola yang sama]

      // ====== JAWABAN FUNCTIONS (SUPABASE) ======
      async function loadJawaban() {
        try {
          const { data, error } = await supabase
            .from('jawaban')
            .select(`
              *,
              peserta:nama_peserta_snap,
              agenda:nama_agenda_snap
            `)
            .order('tgljam_mulai', { ascending: false });
          
          if (error) throw error;

          const tbody = document.querySelector('#jawabanTable tbody');
          const headerTr = document.getElementById('jawabanHeaderRow');
          tbody.innerHTML = '';
          headerTr.innerHTML = '';
          
          // Parse jawaban untuk menentukan jumlah kolom
          let maxJ = 0;
          data.forEach(jawaban => {
            if (jawaban.jawaban) {
              try {
                const jwb = JSON.parse(jawaban.jawaban);
                const keys = Object.keys(jwb);
                keys.forEach(key => {
                  if (key.startsWith('Jwb')) {
                    const num = parseInt(key.substring(3), 10);
                    if (!isNaN(num) && num > maxJ) maxJ = num;
                  }
                });
              } catch (e) {
                console.log('Jawaban bukan JSON:', jawaban.jawaban);
              }
            }
          });
          
          let headerHtml = `
            <th><input type="checkbox" id="jawaban_select_all" onclick="toggleSelectAllJawaban(this)"></th>
            <th>Nama Siswa</th>
            <th>Agenda Ujian</th>
            <th>Mata Pelajaran</th>
            <th>Status</th>
          `;
          
          for (let i = 1; i <= maxJ; i++) {
            headerHtml += `<th>Jwb${i}</th>`;
          }
          
          headerHtml += `
            <th>TglJam_Mulai</th>
            <th>TglJam_Selesai</th>
            <th>Aksi</th>
          `;
          headerTr.innerHTML = headerHtml;
          
          data.forEach(jawaban => {
            let jawabanCount = 0;
            let jawabanObj = {};
            
            if (jawaban.jawaban) {
              try {
                jawabanObj = JSON.parse(jawaban.jawaban);
                Object.keys(jawabanObj).forEach(key => {
                  if (key.startsWith('Jwb') && jawabanObj[key] && jawabanObj[key].trim() !== '') {
                    jawabanCount++;
                  }
                });
              } catch (e) {
                console.log('Error parsing jawaban:', e);
              }
            }
            
            const jawabanBadge = jawabanCount > 0 
              ? `<span class="jawaban-badge">${jawabanCount}</span>` 
              : '';
            
            let rowHtml = `
              <td><input type="checkbox" class="jawaban-checkbox" value="${jawaban.id}"></td>
              <td>${jawaban.peserta || jawaban.nama_peserta_snap || ''} ${jawabanBadge}</td>
              <td>${jawaban.agenda || jawaban.nama_agenda_snap || ''}</td>
              <td>${jawaban.nama_mapel_snap || ''}</td>
              <td>${jawaban.status || ''}</td>
            `;
            
            for (let i = 1; i <= maxJ; i++) {
              const jawabanText = jawabanObj['Jwb' + i] || '';
              const cellClass = jawabanText.trim() !== '' ? 'style="background:#d1fae5;"' : '';
              rowHtml += `<td ${cellClass}>${jawabanText}</td>`;
            }
            
            rowHtml += `
              <td>${jawaban.tgljam_mulai ? new Date(jawaban.tgljam_mulai).toLocaleString() : ''}</td>
              <td>${jawaban.tgljam_selesai ? new Date(jawaban.tgljam_selesai).toLocaleString() : ''}</td>
              <td class="actions">
                <button onclick="openResetJawabanModal('${jawaban.id}')" title="Reset jawaban siswa">üîÑ Reset</button>
              </td>
            `;
            
            const tr = document.createElement('tr');
            tr.innerHTML = rowHtml;
            tbody.appendChild(tr);
          });
          
        } catch (error) {
          showNotification('error', 'Error', 'Gagal membaca Jawaban Siswa: ' + error.message);
        }
      }

      // ====== FUNGSI TAMBAHAN UNTUK SUPABASE ======
      
      // Fungsi untuk load monitoring (jika tabel monitoring tidak ada, bisa diabaikan atau dibuat)
      async function loadMonitoring() {
        try {
          // Jika tabel monitoring tidak ada, kita bisa menggunakan query lain
          // Atau membuat fungsi ini kosong sementara
          const { data, error } = await supabase
            .from('jawaban')
            .select(`
              *,
              peserta:peserta!inner(nis_username, nama_peserta)
            `)
            .order('tgljam_mulai', { ascending: false });
          
          if (error) throw error;

          const tbody = document.querySelector('#monitoringTable tbody');
          tbody.innerHTML = '';
          
          data.forEach(record => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><input type="checkbox" class="monitoring-checkbox" value="${record.id}"></td>
              <td>${record.peserta?.nis_username || ''}</td>
              <td>${record.peserta?.nama_peserta || ''}</td>
              <td>${record.tgljam_login ? 'Login' : ''} ${record.tgljam_logout ? 'Logout' : ''}</td>
              <td>${record.nama_agenda_snap || ''}</td>
              <td>${record.nama_mapel_snap || ''}</td>
              <td>${record.status || ''}</td>
              <td>${record.tgljam_mulai ? new Date(record.tgljam_mulai).toLocaleString() : ''}</td>
              <td>${record.updated_at ? new Date(record.updated_at).toLocaleString() : ''}</td>
              <td>${record.tgljam_selesai ? new Date(record.tgljam_selesai).toLocaleString() : ''}</td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          console.error('Error loading monitoring:', error);
          // Jika error, kita bisa hide tab monitoring atau tampilkan pesan
        }
      }

      // ====== FUNGSI UTILITY YANG SAMA ======
      // [Semua fungsi utility yang tidak berhubungan dengan database tetap sama]
      // showNotification, closeNotification, hideAllNotifications, showConfirmation, hideConfirmation
      // fileToBase64, uploadToGoogleDrive, previewImage, togglePasswordVisibility
      // onTypeSoalChange, setAutoNoSoal, onChangeAgendaBankSoal, onChangeMapelBankSoal
      // toggleSelectAllBankSoal, selectAllBankSoal, deselectAllBankSoal
      // deleteSelectedBankSoal, deleteAllBankSoal
      // openImportBankSoalModal, importBankSoalFromFile, downloadTemplateBankSoal
      // downloadTemplatePeserta, importPesertaFromFile
      // openBankSoalModalForCreate, editSoal, deleteSoal, resetBankSoalForm
      // toggleSelectAllMonitoring, deleteSelectedMonitoring
      // toggleSelectAllJawaban, deleteSelectedJawaban, resetAllJawabanForSelected
      // openResetJawabanModal, loadMapelForReset, toggleResetMapel, toggleAllResetMapel
      // confirmResetJawaban, performResetJawaban, openMultiResetModal
      // onChangeAgendaCetakKartu, loadKartuPesertaTable, toggleSelectAllKartu
      // buildKartuHtml, printKartuSingle, printKartuSelected
      // showModal, hideModal
      
      // ====== INISIALISASI ======
      document.addEventListener('DOMContentLoaded', function() {
        checkLoginStatus();
        
        if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL.includes('https://script.google.com/macros/s/AKfycbwOXJ-kL-ywDQv-GAe4bDlngnTN7ljOr6fTdtz3a6O0x-JTgyo/exec')) {
          showNotification('warning', 'Konfigurasi', 'URL Google Apps Script belum dikonfigurasi. Upload gambar akan menggunakan fallback ke base64.', 10000);
        }
      });

    </script>
  </body>
</html>
