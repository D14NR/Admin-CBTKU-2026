<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login Admin - Portal Admin CBT 2026</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


    <style>
      :root {
        --bg: #f3f4f6;
        --surface: #ffffff;
        --surface-alt: #f9fafb;
        --border: #e5e7eb;
        --border-strong: #d1d5db;
        --primary: #2563eb;
        --primary-soft: rgba(37, 99, 235, 0.12);
        --primary-hover: #1d4ed8;
        --danger: #dc2626;
        --danger-soft: rgba(220, 38, 38, 0.1);
        --danger-hover: #b91c1c;
        --warning: #f59e0b;
        --warning-soft: rgba(245, 158, 11, 0.1);
        --warning-hover: #d97706;
        --text: #111827;
        --text-muted: #6b7280;
        --radius-sm: 6px;
        --radius-md: 10px;
        --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.06);
        --shadow-md: 0 4px 6px rgba(15, 23, 42, 0.08);
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html, body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      /* Body untuk halaman login */
      body.login-page {
        background: radial-gradient(circle at top left, #e0f2fe 0, #eef2ff 35%, #f9fafb 70%, #f3f4f6 100%);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Body untuk halaman app */
      body.app-page {
        background: radial-gradient(circle at top left, #e0f2fe 0, #eef2ff 35%, #f9fafb 70%, #f3f4f6 100%);
        min-height: 100vh;
      }

      /* LOGIN STYLES */
      #login-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        padding: 20px;
        width: 100%;
      }

      .login-card {
        background: #ffffff;
        width: 100%;
        max-width: 360px;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.8);
        text-align: center;
        margin-bottom: 60px;
      }

      .login-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text);
      }

      .login-subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 24px;
      }

      .login-form input {
        margin-bottom: 12px;
        width: 100%;
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-strong);
        font-size: 14px;
      }

      .login-btn {
        width: 100%;
        margin-top: 8px;
        padding: 10px;
        font-size: 14px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
      }

      .login-btn:hover {
        background: var(--primary-hover);
      }

      /* Password wrapper styles */
      .password-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .password-wrapper input {
        flex: 1;
        padding-right: 40px;
        margin-bottom: 0;
      }

      .toggle-password {
        position: absolute;
        right: 8px;
        background: transparent;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 100%;
      }

      .toggle-password:hover {
        color: var(--primary);
        background: transparent;
        box-shadow: none;
      }

      /* APP STYLES */
      .app-shell {
        max-width: 1200px;
        margin: 24px auto 40px;
        padding: 0 16px;
        display: none;
      }

      .app-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 16px;
      }

      .app-title {
        margin: 0;
        font-size: 20px;
        font-weight: 650;
        color: var(--text);
      }

      .app-subtitle {
        margin: 2px 0 0;
        font-size: 13px;
        color: var(--text-muted);
        max-width: 520px;
      }

      .app-badge {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--primary-soft);
        color: var(--primary);
        border: 1px solid rgba(37, 99, 235, 0.25);
        align-self: flex-start;
        white-space: nowrap;
        cursor: pointer;
      }

      /* Tabs */
      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 6px;
        background: rgba(255,255,255,0.9);
        border-radius: 999px;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(148, 163, 184, 0.4);
        position: sticky;
        top: 12px;
        z-index: 50;
        backdrop-filter: blur(10px);
      }

      .tab-button {
        flex: 1 1 auto;
        border-radius: 999px;
        border: none;
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 500;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease, box-shadow 0.15s;
        white-space: nowrap;
      }

      .tab-button:hover {
        background: rgba(15,23,42,0.04);
        color: var(--text);
      }

      .tab-button.active {
        background: #ffffff;
        color: var(--primary);
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
      }

      .tab-content {
        margin-top: 18px;
        padding: 16px 18px 20px;
        background: rgba(255,255,255,0.95);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
      }

      .section-header {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-bottom: 10px;
      }

      .section-header h2 {
        margin: 0;
        font-size: 17px;
        font-weight: 600;
      }

      .section-subtitle {
        margin: 0;
        font-size: 12px;
        color: var(--text-muted);
      }

      /* Forms */
      form {
        margin-bottom: 16px;
        padding: 14px 16px 16px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        background: var(--surface);
        box-shadow: var(--shadow-sm);
        max-width: 900px;
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: var(--text);
        margin-bottom: 10px;
      }

      label > input,
      label > select,
      label > textarea {
        margin-top: 4px;
      }

      input[type="text"],
      input[type="password"],
      input[type="tel"],
      input[type="number"],
      input[type="datetime-local"],
      select,
      textarea {
        width: 100%;
        padding: 7px 9px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-strong);
        background: var(--surface-alt);
        font-size: 13px;
        color: var(--text);
        transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      }

      input[type="text"]:focus,
      input[type="password"]:focus,
      input[type="tel"]:focus,
      input[type="number"]:focus,
      input[type="datetime-local"]:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 1px var(--primary-soft);
        background: #ffffff;
      }

      textarea {
        resize: vertical;
        min-height: 70px;
      }

      input[readonly] {
        background: #f3f4f6;
        color: var(--text-muted);
      }

      /* Buttons */
      button {
        border-radius: 999px;
        border: none;
        padding: 7px 14px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        background: var(--primary);
        color: #ffffff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: background-color 0.15s ease, box-shadow 0.15s ease, transform 0.04s ease;
      }

      button:hover {
        background: var(--primary-hover);
        box-shadow: 0 3px 6px rgba(37, 99, 235, 0.25);
      }

      button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.25);
      }

      button[disabled] {
        opacity: 0.65;
        cursor: default;
        box-shadow: none;
      }

      button[onclick^="delete"],
      button[onclick^="hapus"],
      button[onclick^="deleteSelected"] {
        background: var(--danger);
      }

      button[onclick^="delete"]:hover,
      button[onclick^="hapus"]:hover,
      button[onclick^="deleteSelected"]:hover {
        background: var(--danger-hover);
        box-shadow: 0 3px 6px rgba(220, 38, 38, 0.24);
      }

      button[onclick*="resetJawaban"],
      button[onclick*="Reset"] {
        background: var(--warning);
      }

      button[onclick*="resetJawaban"]:hover,
      button[onclick*="Reset"]:hover {
        background: var(--warning-hover);
        box-shadow: 0 3px 6px rgba(245, 158, 11, 0.25);
      }

      button[onclick="generateTokenUjian()"] {
        background: #0f172a;
      }

      button[onclick="generateTokenUjian()"]:hover {
        background: #020617;
      }

      .actions button {
        padding: 4px 10px;
        font-size: 12px;
      }

      /* Tables */
      .table-card {
        margin-top: 4px;
        padding: 10px 12px 12px;
        border-radius: var(--radius-md);
        background: var(--surface);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
      }

      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
        min-width: 700px;
      }

      th, td {
        border-bottom: 1px solid var(--border);
        padding: 7px 8px;
        text-align: left;
      }

      th {
        background: var(--surface-alt);
        font-weight: 600;
        color: var(--text-muted);
        position: sticky;
        top: 0;
        z-index: 1;
      }

      tbody tr:nth-child(even) {
        background: #f9fafb;
      }

      tbody tr:hover {
        background: #eff6ff;
      }

      th:first-child,
      td:first-child {
        padding-left: 10px;
      }

      th:last-child,
      td:last-child {
        padding-right: 10px;
      }

      th input[type="checkbox"] {
        transform: translateY(1px);
      }

      /* Bank Soal sections */
      #group-pg,
      #group-pernyataan,
      #group-pejodohan {
        border-radius: var(--radius-sm);
        border: 1px dashed var(--border-strong);
        background: #f9fafb;
        padding: 12px;
        margin-top: 8px;
      }

      #group-pg strong,
      #group-pernyataan strong,
      #group-pejodohan strong {
        font-size: 13px;
        color: var(--text);
        display: block;
        margin-bottom: 8px;
      }

      /* Kartu Peserta - Print Styles */
      .kartu-container {
        page-break-inside: avoid;
        border: 2px solid #111827;
        padding: 16px;
        margin: 12px auto;
        width: 8.5cm;
        height: 12cm;
        font-size: 13px;
        background: #ffffff;
        font-family: "Segoe UI", system-ui, sans-serif;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .kartu-logo {
        text-align: center;
        margin-bottom: 8px;
        color: #2563eb;
        font-weight: bold;
        font-size: 14px;
      }

      .kartu-header {
        text-align: center;
        font-weight: 700;
        margin-bottom: 8px;
        border-bottom: 3px double #111827;
        padding-bottom: 8px;
        letter-spacing: 0.05em;
        font-size: 16px;
        color: #1e293b;
      }

      .kartu-title {
        text-align: center;
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 12px;
        color: #2563eb;
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        padding: 4px 0;
      }

      .kartu-table {
        width: 100%;
        border-collapse: collapse;
        margin: 8px 0;
      }

      .kartu-table td {
        padding: 6px 4px;
        vertical-align: top;
        border-bottom: 1px solid #e5e7eb;
      }

      .kartu-table td.label {
        width: 45%;
        font-weight: 600;
        color: #374151;
      }

      .kartu-table tr:last-child td {
        border-bottom: none;
      }

      .kartu-footer {
        margin-top: 12px;
        font-size: 10px;
        color: #6b7280;
        text-align: center;
        padding: 8px;
        border-top: 1px dashed #d1d5db;
        background: #f9fafb;
        border-radius: 6px;
      }

      .kartu-watermark {
        position: absolute;
        bottom: 8px;
        right: 8px;
        font-size: 9px;
        color: #9ca3af;
        font-style: italic;
      }

      /* Print area */
      #printArea {
        display: none;
      }

      @media print {
        body * {
          visibility: hidden;
        }
        #printArea,
        #printArea * {
          visibility: visible;
        }
        #printArea {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          margin: 0;
          padding: 20px;
          display: grid !important;
          grid-template-columns: repeat(2, 1fr);
          gap: 16px;
        }
        
        .kartu-container {
          width: 100% !important;
          height: auto !important;
          margin: 0 !important;
          break-inside: avoid;
          box-shadow: none !important;
          border: 1.5px solid #000 !important;
        }
        
        @page {
          margin: 15mm;
          size: A4 portrait;
        }
      }

      /* Modal */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-backdrop.show {
        display: flex;
      }

      .modal {
        background: #ffffff;
        border-radius: 12px;
        width: 100%;
        max-width: 720px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
        border: 1px solid rgba(148, 163, 184, 0.6);
      }

      .modal-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .modal-title {
        font-size: 15px;
        font-weight: 600;
      }

      .modal-close-btn {
        border-radius: 999px;
        border: none;
        width: 26px;
        height: 26px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 18px;
        padding: 0;
      }

      .modal-close-btn:hover {
        background: rgba(15,23,42,0.05);
        color: var(--text);
      }

      .modal-body {
        padding: 12px 16px 14px;
        overflow: auto;
      }

      .modal-body form {
        box-shadow: none;
        border: none;
        padding: 0;
        margin: 0;
        max-width: 100%;
      }

      @media (max-width: 768px) {
        .app-shell {
          margin: 16px auto 24px;
          padding: 0 10px;
        }
        .tab-content {
          padding: 12px 12px 16px;
        }
        .app-header {
          margin-bottom: 10px;
        }
        .tabs {
          border-radius: 16px;
        }
        table {
          min-width: 600px;
        }
        .kartu-container {
          width: 100%;
          height: auto;
        }
      }

      @media (max-width: 480px) {
        .tabs {
          flex-wrap: nowrap;
          overflow-x: auto;
        }
        .tab-button {
          flex: 0 0 auto;
        }
      }

      /* ====== MODERN NOTIFICATION SYSTEM ====== */
      .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 99999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
        pointer-events: none;
      }

      .notification {
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        border-left: 5px solid;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        transform: translateX(120%);
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        pointer-events: auto;
        max-width: 380px;
        min-width: 300px;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.hide {
        transform: translateX(120%);
      }

      .notification-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 14px;
        font-weight: bold;
      }

      .notification-content {
        flex: 1;
        min-width: 0;
      }

      .notification-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        color: #111827;
      }

      .notification-message {
        font-size: 13px;
        color: #4b5563;
        line-height: 1.4;
      }

      .notification-close {
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 4px;
        font-size: 18px;
        line-height: 1;
        flex-shrink: 0;
        transition: color 0.2s;
      }

      .notification-close:hover {
        color: #6b7280;
      }

      /* Notification Types */
      .notification.success {
        border-left-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4, #ffffff);
      }

      .notification.success .notification-icon {
        background: #10b981;
        color: white;
      }

      .notification.error {
        border-left-color: #ef4444;
        background: linear-gradient(135deg, #fef2f2, #ffffff);
      }

      .notification.error .notification-icon {
        background: #ef4444;
        color: white;
      }

      .notification.warning {
        border-left-color: #f59e0b;
        background: linear-gradient(135deg, #fffbeb, #ffffff);
      }

      .notification.warning .notification-icon {
        background: #f59e0b;
        color: white;
      }

      .notification.info {
        border-left-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff, #ffffff);
      }

      .notification.info .notification-icon {
        background: #3b82f6;
        color: white;
      }

      /* Progress bar */
      .notification-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 0 0 12px 12px;
        overflow: hidden;
      }

      .notification-progress-bar {
        height: 100%;
        width: 100%;
        transform-origin: left;
        transform: scaleX(1);
        transition: transform linear;
      }

      .notification.success .notification-progress-bar {
        background: #10b981;
      }

      .notification.error .notification-progress-bar {
        background: #ef4444;
      }

      .notification.warning .notification-progress-bar {
        background: #f59e0b;
      }

      .notification.info .notification-progress-bar {
        background: #3b82f6;
      }

      /* Confirmation Dialog */
      .confirmation-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.75);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(4px);
      }

      .confirmation-dialog.show {
        display: flex;
      }

      .confirmation-box {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
        animation: dialogSlideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }

      @keyframes dialogSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .confirmation-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        font-size: 28px;
      }

      .confirmation-icon.warning {
        background: #fef3c7;
        color: #f59e0b;
      }

      .confirmation-icon.info {
        background: #dbeafe;
        color: #3b82f6;
      }

      .confirmation-title {
        font-size: 18px;
        font-weight: 600;
        text-align: center;
        margin-bottom: 8px;
        color: #111827;
      }

      .confirmation-message {
        font-size: 14px;
        color: #6b7280;
        text-align: center;
        margin-bottom: 24px;
        line-height: 1.5;
      }

      .confirmation-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .confirmation-btn {
        padding: 10px 24px;
        border-radius: 999px;
        border: none;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 100px;
      }

      .confirmation-btn.cancel {
        background: #f3f4f6;
        color: #4b5563;
      }

      .confirmation-btn.cancel:hover {
        background: #e5e7eb;
      }

      .confirmation-btn.confirm {
        background: #3b82f6;
        color: white;
      }

      .confirmation-btn.confirm:hover {
        background: #2563eb;
      }

      .confirmation-btn.confirm.delete {
        background: #ef4444;
      }

      .confirmation-btn.confirm.delete:hover {
        background: #dc2626;
      }

      .confirmation-btn.confirm.warning {
        background: #f59e0b;
      }

      .confirmation-btn.confirm.warning:hover {
        background: #d97706;
      }

      /* Toast Notification */
      .toast-notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: #1f2937;
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 14px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 90%;
      }

      .toast-notification.show {
        transform: translateX(-50%) translateY(0);
      }

      .toast-icon {
        font-size: 18px;
      }

      .toast-message {
        flex: 1;
      }

      /* ====== FOOTER STYLES ====== */
      .site-footer {
        padding: 16px;
        text-align: center;
        font-size: 13px;
        color: var(--text-muted);
        border-top: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        width: 100%;
        margin-top: auto;
      }

      .footer-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .footer-text {
        font-weight: 500;
        color: var(--primary);
        letter-spacing: 0.5px;
      }

      .footer-subtext {
        font-size: 11px;
        color: var(--text-muted);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .site-footer {
          margin-top: 20px;
          padding: 12px;
          font-size: 12px;
        }
        
        .footer-subtext {
          font-size: 10px;
        }
      }

      /* Image preview */
      .image-preview {
        margin-top: 10px;
        max-width: 200px;
        max-height: 150px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        object-fit: contain;
      }

      .preview-container {
        margin-top: 8px;
      }

      /* Style untuk checkbox mapel di modal reset */
      .reset-mapel-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
      }

      .reset-mapel-item:hover {
        background: #f3f4f6;
      }

      .reset-mapel-item input[type="checkbox"] {
        transform: scale(1.2);
      }

      .reset-mapel-item label {
        flex: 1;
        margin: 0;
        cursor: pointer;
        font-size: 13px;
      }

      .reset-mapel-count {
        font-size: 11px;
        color: var(--text-muted);
        background: var(--surface-alt);
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: auto;
      }

      /* Badge untuk jumlah jawaban */
      .jawaban-badge {
        font-size: 10px;
        background: #10b981;
        color: white;
        padding: 1px 6px;
        border-radius: 10px;
        margin-left: 4px;
        vertical-align: middle;
      }
    </style>
  </head>
  <body class="login-page">

    <!-- LOGIN SECTION -->
    <div id="login-section">
      <div class="login-card">
        <div class="login-title">Login Admin</div>
        <div class="login-subtitle">Portal Admin CBT 2026</div>
        <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
          <input type="text" id="login_username" placeholder="Username" required>
          
          <div class="password-wrapper">
            <input type="password" id="login_password" placeholder="Password" required>
            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('login_password', this)">
              üëÅÔ∏è
            </button>
          </div>
          
          <button type="submit" class="login-btn">Masuk</button>
        </form>
      </div>
    </div>

    <!-- MAIN APP SHELL (Hidden by default) -->
    <div class="app-shell" id="app-shell">
      <header class="app-header">
        <div>
          <h1 class="app-title">Portal Admin CBT 2026</h1>
          <p class="app-subtitle">
            Kelola peserta, agenda ujian, mata pelajaran, bank soal, monitoring, jawaban siswa, dan cetak kartu peserta.
          </p>
        </div>
        <div class="app-badge" onclick="handleLogout()" title="Klik untuk Logout">
          Admin CBT2026 (Logout)
        </div>
      </header>

      <!-- TAB MENU -->
      <div class="tabs">
        <button id="tab-btn-peserta" class="tab-button active" onclick="showTab('peserta')">
          Peserta
        </button>
        <button id="tab-btn-agenda" class="tab-button" onclick="showTab('agenda')">
          Agenda Ujian
        </button>
        <button id="tab-btn-mapel" class="tab-button" onclick="showTab('mapel')">
          Mata Pelajaran
        </button>
        <button id="tab-btn-banksoal" class="tab-button" onclick="showTab('banksoal')">
          Bank Soal
        </button>
        <button id="tab-btn-monitoring" class="tab-button" onclick="showTab('monitoring')">
          Monitoring Pengerjaan
        </button>
        <button id="tab-btn-jawaban" class="tab-button" onclick="showTab('jawaban')">
          Jawaban Siswa
        </button>
        <button id="tab-btn-cetakkartu" class="tab-button" onclick="showTab('cetakkartu')">
          Cetak Kartu
        </button>
      </div>

      <!-- TAB PESERTA -->
      <div id="tab-peserta" class="tab-content" style="display:block;">
        <div class="section-header">
          <h2>Data Peserta</h2>
          <p class="section-subtitle">Input dan kelola data peserta ujian untuk setiap agenda.</p>
        </div>

        <div style="margin-bottom:8px; display:flex; flex-wrap:wrap; gap:6px;">
          <button type="button" onclick="openPesertaModalForCreate()">+ Tambah Peserta</button>
          <button type="button" onclick="showModal('modal-import-peserta')">Import Peserta</button>
          <button type="button" onclick="exportPesertaToCsv()">Export Data</button>
        </div>

        <div class="section-header">
          <h2>Daftar Peserta</h2>
          <p class="section-subtitle">Data peserta yang tersimpan di Firebase.</p>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="pesertaTable">
              <thead>
                <tr>
                  <th>NIS_Username</th>
                  <th>Nama_Peserta</th>
                  <th>Password</th>
                  <th>Jenjang_Studi</th>
                  <th>Kelas</th>
                  <th>Asal_Sekolah</th>
                  <th>No_WA_Peserta</th>
                  <th>No_WA_Ortu</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB AGENDA UJIAN -->
      <div id="tab-agenda" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Agenda Ujian</h2>
          <p class="section-subtitle">Atur jadwal, token, dan deskripsi setiap agenda ujian.</p>
        </div>

        <div style="margin-bottom:8px;">
          <button type="button" onclick="openAgendaModalForCreate()">+ Tambah Agenda</button>
        </div>

        <div class="section-header">
          <h2>Daftar Agenda Ujian</h2>
          <p class="section-subtitle">Semua agenda ujian yang sudah dibuat.</p>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="agendaTable">
              <thead>
                <tr>
                  <th>Agenda_Ujian</th>
                  <th>Deskripsi_Ujian</th>
                  <th>Jenjang_Studi</th>
                  <th>Jenis_Tes</th>
                  <th>TglJam_Mulai</th>
                  <th>TglJam_Selesai</th>
                  <th>Token_Ujian</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB MATA PELAJARAN -->
      <div id="tab-mapel" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Mata Pelajaran</h2>
          <p class="section-subtitle">Tetapkan mapel, jumlah soal, dan durasi per agenda ujian.</p>
        </div>

        <label>
          Pilih Agenda Ujian:
          <select id="Mapel_Agenda_Select" onchange="onChangeAgendaMapel()">
            <option value="">-- Pilih Agenda Ujian dulu --</option>
          </select>
        </label>

        <div style="margin:8px 0 10px;">
          <button type="button" onclick="openMapelModalForCreate()">+ Tambah Mata Pelajaran</button>
        </div>

        <div class="section-header">
          <h2>Daftar Mata Pelajaran</h2>
          <p class="section-subtitle">Berdasarkan agenda ujian yang dipilih.</p>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="mapelTable">
              <thead>
                <tr>
                  <th>Nama_Mata_Pelajaran</th>
                  <th>Jumlah_Soal</th>
                  <th>Durasi_Ujian (menit)</th>
                  <th>Status_Mapel</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB BANK SOAL -->
      <div id="tab-banksoal" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Bank Soal</h2>
          <p class="section-subtitle">Input dan kelola butir soal per agenda dan mata pelajaran.</p>
        </div>

        <label>
          Pilih Agenda Ujian:
          <select id="Bank_Agenda_Select" onchange="onChangeAgendaBankSoal()">
            <option value="">-- Pilih Agenda Ujian dulu --</option>
          </select>
        </label>

        <label>
          Pilih Mata Pelajaran:
          <select id="Bank_Mapel_Select" onchange="onChangeMapelBankSoal()">
            <option value="">-- Pilih Mata Pelajaran --</option>
          </select>
        </label>

        <div style="margin:8px 0 10px; display:flex; flex-wrap:wrap; gap:6px;">
          <button type="button" onclick="openBankSoalModalForCreate()">+ Tambah Soal</button>
          <button type="button" onclick="openImportBankSoalModal()">Import Soal</button>
          <button type="button" onclick="deleteSelectedBankSoal()" style="background: var(--danger);">Hapus Terpilih</button>
          <button type="button" onclick="selectAllBankSoal()">Pilih Semua</button>
          <button type="button" onclick="deselectAllBankSoal()">Batal Pilih</button>
          <button type="button" onclick="deleteAllBankSoal()" style="background: var(--danger);">Hapus Semua di Mapel Ini</button>
        </div>

        <div class="section-header">
          <h2>Daftar Soal</h2>
          <p class="section-subtitle">Berdasarkan agenda dan mata pelajaran yang dipilih.</p>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="bankSoalTable">
              <thead>
                <tr>
                  <th style="width: 30px;">
                    <input type="checkbox" id="bankSoal_select_all" onclick="toggleSelectAllBankSoal(this)">
                  </th>
                  <th>No_Soal</th>
                  <th>Type_Soal</th>
                  <th>Pertanyaan</th>
                  <th>Gambar</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB MONITORING PENGERJAAN -->
      <div id="tab-monitoring" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Monitoring Pengerjaan</h2>
          <p class="section-subtitle">Pantau aktivitas login dan status pengerjaan peserta.</p>
        </div>

        <div style="margin-bottom:8px;">
          <button type="button" onclick="deleteSelectedMonitoring()">Hapus Terpilih</button>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="monitoringTable">
              <thead>
                <tr>
                  <th><input type="checkbox" id="monitoring_select_all" onclick="toggleSelectAllMonitoring(this)"></th>
                  <th>NIS_Username</th>
                  <th>Nama_Peserta</th>
                  <th>Aktivitas_Login</th>
                  <th>Judul_Ujian</th>
                  <th>Mata_Pelajaran</th>
                  <th>Status_Pengerjaan</th>
                  <th>TglJam_Mulai</th>
                  <th>Last_Update</th>
                  <th>TglJam_Selesai</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB JAWABAN SISWA -->
      <div id="tab-jawaban" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Jawaban Siswa</h2>
          <p class="section-subtitle">Rekap jawaban peserta untuk setiap sesi ujian. Klik tombol reset untuk mereset jawaban siswa.</p>
        </div>

        <div style="margin-bottom:8px; display:flex; flex-wrap:wrap; gap:6px;">
          <button type="button" onclick="deleteSelectedJawaban()">Hapus Terpilih</button>
          <button type="button" onclick="exportJawabanToCsv()">Export Data</button>
          <button type="button" onclick="resetAllJawabanForSelected()" style="background: var(--warning);">Reset Jawaban Terpilih</button>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="jawabanTable">
              <thead>
                <tr id="jawabanHeaderRow">
                  <!-- header diisi dinamis oleh JS -->
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB CETAK KARTU -->
      <div id="tab-cetakkartu" class="tab-content" style="display:none;">
        <div class="section-header">
          <h2>Cetak Kartu Peserta</h2>
          <p class="section-subtitle">Pilih agenda dan peserta yang akan dicetak kartunya.</p>
        </div>

        <label>
          Pilih Agenda Ujian:
          <select id="CetakKartu_Agenda_Select" onchange="onChangeAgendaCetakKartu()">
            <option value="">-- Pilih Agenda Ujian dulu --</option>
          </select>
        </label>

        <div style="margin:8px 0 10px;">
          <button type="button" onclick="printKartuSelected()">Print Kartu Terpilih</button>
        </div>

        <div class="section-header">
          <h2>Daftar Peserta</h2>
          <p class="section-subtitle">Peserta pada agenda ujian yang dipilih.</p>
        </div>

        <div class="table-card">
          <div class="table-container">
            <table id="cetakKartuTable">
              <thead>
                <tr>
                  <th><input type="checkbox" id="kartu_select_all" onclick="toggleSelectAllKartu(this)"></th>
                  <th>NIS_Username</th>
                  <th>Nama_Peserta</th>
                  <th>Password</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- MODALS -->

    <!-- Modal Peserta -->
    <div id="modal-peserta" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Form Peserta</div>
            <p class="section-subtitle">Tambah atau edit data peserta ujian.</p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-peserta')">&times;</button>
        </div>
        <div class="modal-body">
          <form id="pesertaForm" onsubmit="event.preventDefault(); savePeserta();">
            <input type="hidden" id="firebaseId">
            <input type="hidden" id="ID_Peserta">

            <label>
              NIS / Username (otomatis dari No. WA Peserta):
              <input type="text" id="NIS_Username" readonly>
            </label>

            <label>
              Nama Peserta:
              <input type="text" id="Nama_Peserta" required>
            </label>

            <label>
              Password:
              <div class="password-wrapper">
                <input type="password" id="Password" required>
                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('Password', this)">
                  üëÅÔ∏è
                </button>
              </div>
            </label>

            <label>
              Jenjang Studi:
              <select id="Jenjang_Studi" required>
                <option value="">-- Pilih Jenjang --</option>
                <option value="SD">SD</option>
                <option value="SMP">SMP</option>
                <option value="SMA">SMA</option>
                <option value="SMK">SMK</option>
              </select>
            </label>

            <label>
              Kelas:
              <input type="text" id="Kelas" required placeholder="Contoh: 7A, 12 IPA 1">
            </label>

            <label>
              Asal Sekolah:
              <input type="text" id="Asal_Sekolah" required>
            </label>

            <label>
              No. WA Peserta:
              <input type="tel" id="No_WA_Peserta" required
                     placeholder="Contoh: 08123456789 atau +628123456789"
                     oninput="handleNoWAChange()">
            </label>

            <label>
              No. WA Orang Tua:
              <input type="tel" id="No_WA_Ortu">
            </label>

            <label>
              Agenda (diambil dari data Agenda Ujian):
              <select id="ID_Agenda_Peserta" required>
                <option value="">-- Pilih Agenda --</option>
              </select>
            </label>

            <div style="margin-top:8px;">
              <button type="submit">Simpan</button>
              <button type="button" onclick="resetForm()" style="margin-left:6px;">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Agenda -->
    <div id="modal-agenda" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Form Agenda Ujian</div>
            <p class="section-subtitle">Tambah atau edit agenda ujian.</p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-agenda')">&times;</button>
        </div>
        <div class="modal-body">
          <form id="agendaForm" onsubmit="event.preventDefault(); saveAgenda();">
            <input type="hidden" id="firebaseAgendaId">
            <input type="hidden" id="ID_Agenda_Agenda">

            <label>
              Agenda Ujian:
              <input type="text" id="Agenda_Ujian" required>
            </label>

            <label>
              Deskripsi Ujian:
              <input type="text" id="Deskripsi_Ujian" required>
            </label>

            <label>
              Jenjang Studi:
              <select id="Jenjang_Studi_Agenda" required>
                <option value="">-- Pilih Jenjang --</option>
                <option value="SD">SD</option>
                <option value="SMP">SMP</option>
                <option value="SMA">SMA</option>
                <option value="UMUM">UMUM</option>
              </select>
            </label>

            <label>
              Jenis Tes:
              <select id="Jenis_Tes" required>
                <option value="">-- Pilih Jenis Tes --</option>
                <option value="SNBT">SNBT</option>
                <option value="UMUM">UMUM</option>
                <option value="TKA">TKA</option>
                <option value="KEDINASAN">KEDINASAN</option>
              </select>
            </label>

            <label>
              Tanggal & Jam Mulai:
              <input type="datetime-local" id="TglJam_Mulai" required>
            </label>

            <label>
              Tanggal & Jam Selesai:
              <input type="datetime-local" id="TglJam_Selesai" required>
            </label>

            <label>
              Token Ujian (6‚Äì8 karakter, huruf & angka):
              <div style="display:flex; gap:8px;">
                <input type="text" id="Token_Ujian" maxlength="8"
                       placeholder="Contoh: AB12CD, X9K2M3, 7F8G9H"
                       style="flex:1;">
                <button type="button" onclick="generateTokenUjian()">Generate</button>
              </div>
            </label>

            <div style="margin-top:8px;">
              <button type="submit">Simpan</button>
              <button type="button" onclick="resetAgendaForm()" style="margin-left:6px;">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Mapel -->
    <div id="modal-mapel" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Form Mata Pelajaran</div>
            <p class="section-subtitle">Tambah atau edit mata pelajaran untuk agenda terpilih.</p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-mapel')">&times;</button>
        </div>
        <div class="modal-body">
          <form id="mapelForm" onsubmit="event.preventDefault(); saveMapel();">
            <input type="hidden" id="firebaseMapelId">
            <input type="hidden" id="ID_Agenda_Mapel">
            <input type="hidden" id="ID_Mapel_Mapel">

            <label>
              Nama Mata Pelajaran:
              <select id="Nama_Mata_Pelajaran" required>
                <option value="">-- Pilih Mata Pelajaran --</option>
                <option value="Matematika">Matematika</option>
                <option value="Matematika Tingkat Lanjut">Matematika Tingkat Lanjut</option>
                <option value="Fisika">Fisika</option>
                <option value="Kimia">Kimia</option>
                <option value="Biologi">Biologi</option>
                <option value="Ekonomi">Ekonomi</option>
                <option value="Geografi">Geografi</option>
                <option value="Sosiologi">Sosiologi</option>
                <option value="Sejarah">Sejarah</option>
                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                <option value="Bahasa Indonesia Tingkat Lanjut">Bahasa Indonesia Tingkat Lanjut</option>
                <option value="Bahasa Inggris">Bahasa Inggris</option>
                <option value="Bahasa Inggris Tingkat Lanjut">Bahasa Inggris Tingkat Lanjut</option>
                <option value="Ilmu Pengetahuan Alam">Ilmu Pengetahuan Alam</option>
                <option value="Ilmu Pengetahuan Sosial">Ilmu Pengetahuan Sosial</option>
                <option value="Ilmu Pengetahuan Alam &amp; Sosial">Ilmu Pengetahuan Alam &amp; Sosial</option>
                <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                <option value="Produk/Projek Kreatif dan Kewirausahaan">Produk/Projek Kreatif dan Kewirausahaan</option>
                <option value="Penalaran Umum (PU)">Penalaran Umum (PU)</option>
                <option value="Pengetahuan dan Pemahaman Umum (PPU)">Pengetahuan dan Pemahaman Umum (PPU)</option>
                <option value="Pemahaman Bacaan dan Menulis (PBM)">Pemahaman Bacaan dan Menulis (PBM)</option>
                <option value="Pengetahuan Kuantitatif (PK)">Pengetahuan Kuantitatif (PK)</option>
                <option value="Literasi Bahasa Indonesia (LBIND)">Literasi Bahasa Indonesia (LBIND)</option>
                <option value="Literasi Bahasa Inggris (LBING)">Literasi Bahasa Inggris (LBING)</option>
                <option value="Penalaran Matematika (PM)">Penalaran Matematika (PM)</option>
                <option value="Tes Intelegensi Umum (TIU)">Tes Intelegensi Umum (TIU)</option>
                <option value="Prakarya dan Kewirausahaan (PKWU)">Prakarya dan Kewirausahaan (PKWU)</option>
                <option value="Tes Karakteristik Pribadi (TKP)">Tes Karakteristik Pribadi (TKP)</option>
                <option value="Tes Bahasa Inggris (TBI)">Tes Bahasa Inggris (TBI)</option>
                <option value="Tes Potensi Akademik (TPA)">Tes Potensi Akademik (TPA)</option>
              </select>
            </label>

            <label>
              Jumlah Soal:
              <input type="number" id="Jumlah_Soal" min="1" required>
            </label>

            <label>
              Durasi Ujian (menit):
              <input type="number" id="Durasi_Ujian" min="1" required placeholder="Contoh: 90">
            </label>

            <input type="hidden" id="Status_Mapel" value="Draft">

            <div style="margin-top:8px;">
              <button type="submit">Simpan</button>
              <button type="button" onclick="resetMapelForm()" style="margin-left:6px;">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Bank Soal (form manual) -->
    <div id="modal-banksoal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Form Soal</div>
            <p class="section-subtitle">Tambah atau edit butir soal untuk mapel terpilih.</p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-banksoal')">&times;</button>
        </div>
        <div class="modal-body">
          <form id="bankSoalForm" onsubmit="event.preventDefault(); saveSoal();">
            <input type="hidden" id="firebaseSoalId">
            <input type="hidden" id="Gambar_Url">
            <input type="hidden" id="ID_Agenda_Bank">
            <input type="hidden" id="ID_Mapel_Bank">

            <label>
              Nama Mata Pelajaran:
              <input type="text" id="Nama_Mata_Pelajaran_Bank" readonly>
            </label>

            <label>
              No. Soal:
              <input type="number" id="No_Soal" min="1" required readonly>
            </label>

            <label>
              Pertanyaan:
              <textarea id="Pertanyaan" rows="3" required></textarea>
            </label>

            <label>
              Gambar (opsional):
              <input type="file" id="Gambar" accept="image/*" onchange="previewImage(this)">
              <div id="imagePreviewContainer" class="preview-container"></div>
            </label>

            <label>
              Type Soal:
              <select id="Type_Soal" onchange="onTypeSoalChange()" required>
                <option value="">-- Pilih type soal --</option>
                <option value="Pilihan Ganda Tunggal">Pilihan Ganda Tunggal</option>
                <option value="Pilihan Ganda Kompleks">Pilihan Ganda Kompleks</option>
                <option value="Pilihan Benar/Salah">Pilihan Benar/Salah</option>
                <option value="Pilihan Setuju/Tidak">Pilihan Setuju/Tidak</option>
                <option value="Pilihan Pejodohan">Pilihan Pejodohan</option>
                <option value="Uraian">Uraian</option>
              </select>
            </label>

            <!-- Pilihan Ganda A‚ÄìE -->
            <div id="group-pg" style="display:none; padding:8px; margin-top:8px;">
              <strong>Pilihan Ganda (A‚ÄìE)</strong>
              <label>Pilihan A: <input type="text" id="Pilihan_A"></label>
              <label>Pilihan B: <input type="text" id="Pilihan_B"></label>
              <label>Pilihan C: <input type="text" id="Pilihan_C"></label>
              <label>Pilihan D: <input type="text" id="Pilihan_D"></label>
              <label>Pilihan E: <input type="text" id="Pilihan_E"></label>
            </div>

            <!-- Pernyataan 1‚Äì10 -->
            <div id="group-pernyataan" style="display:none; padding:8px; margin-top:8px;">
              <strong>Pernyataan (1‚Äì10)</strong>
              <label>Pernyataan 1: <input type="text" id="Pernyataan_1"></label>
              <label>Pernyataan 2: <input type="text" id="Pernyataan_2"></label>
              <label>Pernyataan 3: <input type="text" id="Pernyataan_3"></label>
              <label>Pernyataan 4: <input type="text" id="Pernyataan_4"></label>
              <label>Pernyataan 5: <input type="text" id="Pernyataan_5"></label>
              <label>Pernyataan 6: <input type="text" id="Pernyataan_6"></label>
              <label>Pernyataan 7: <input type="text" id="Pernyataan_7"></label>
              <label>Pernyataan 8: <input type="text" id="Pernyataan_8"></label>
              <label>Pernyataan 9: <input type="text" id="Pernyataan_9"></label>
              <label>Pernyataan 10:<input type="text" id="Pernyataan_10"></label>
            </div>

            <!-- Pejodohan kiri/kanan 1‚Äì10 -->
            <div id="group-pejodohan" style="display:none; padding:8px; margin-top:8px;">
              <strong>Pejodohan (Pasangan Kiri & Kanan 1‚Äì10)</strong>
              <div style="display:flex; gap:10px; margin-top:6px;">
                <div style="flex:1;">
                  <em>Pasangan Kiri</em>
                  <label>Kiri 1: <input type="text" id="Pasangan_kiri_1"></label>
                  <label>Kiri 2: <input type="text" id="Pasangan_kiri_2"></label>
                  <label>Kiri 3: <input type="text" id="Pasangan_kiri_3"></label>
                  <label>Kiri 4: <input type="text" id="Pasangan_kiri_4"></label>
                  <label>Kiri 5: <input type="text" id="Pasangan_kiri_5"></label>
                  <label>Kiri 6: <input type="text" id="Pasangan_kiri_6"></label>
                  <label>Kiri 7: <input type="text" id="Pasangan_kiri_7"></label>
                  <label>Kiri 8: <input type="text" id="Pasangan_kiri_8"></label>
                  <label>Kiri 9: <input type="text" id="Pasangan_kiri_9"></label>
                  <label>Kiri 10:<input type="text" id="Pasangan_kiri_10"></label>
                </div>
                <div style="flex:1;">
                  <em>Pasangan Kanan</em>
                  <label>Kanan 1: <input type="text" id="Pasangan_kanan_1"></label>
                  <label>Kanan 2: <input type="text" id="Pasangan_kanan_2"></label>
                  <label>Kanan 3: <input type="text" id="Pasangan_kanan_3"></label>
                  <label>Kanan 4: <input type="text" id="Pasangan_kanan_4"></label>
                  <label>Kanan 5: <input type="text" id="Pasangan_kanan_5"></label>
                  <label>Kanan 6: <input type="text" id="Pasangan_kanan_6"></label>
                  <label>Kanan 7: <input type="text" id="Pasangan_kanan_7"></label>
                  <label>Kanan 8: <input type="text" id="Pasangan_kanan_8"></label>
                  <label>Kanan 9: <input type="text" id="Pasangan_kanan_9"></label>
                  <label>Kanan 10:<input type="text" id="Pasangan_kanan_10"></label>
                </div>
              </div>
            </div>

            <div style="margin-top:10px;">
              <button type="submit">Simpan Soal</button>
              <button type="button" onclick="resetBankSoalForm()" style="margin-left:6px;">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Import Peserta -->
    <div id="modal-import-peserta" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Import Data Peserta</div>
            <p class="section-subtitle">Upload file CSV sesuai template untuk menambah banyak peserta sekaligus.</p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-import-peserta')">&times;</button>
        </div>
        <div class="modal-body">
          <p style="font-size:12px; color:var(--text-muted); margin-top:0;">
            Format: CSV dipisah koma, tanpa tanda kutip ganda di dalam isi. Hindari penggunaan koma di dalam isi kolom.
          </p>
          <button type="button" onclick="downloadTemplatePeserta()">Download Template Peserta</button>
          <div style="margin-top:10px;">
            <label>
              Pilih file CSV:
              <input type="file" id="file_import_peserta" accept=".csv" style="margin-top:6px;">
            </label>
          </div>
          <div style="margin-top:10px;">
            <button type="button" onclick="importPesertaFromFile()">Import</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Import Bank Soal -->
    <div id="modal-import-banksoal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Import Bank Soal</div>
            <p class="section-subtitle">
              Upload file CSV soal untuk agenda yang dipilih, lalu pilih mata pelajaran mana saja
              yang akan diimport. Gunakan kolom <strong>Mata_Pelajaran</strong> di template.
            </p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-import-banksoal')">&times;</button>
        </div>
        <div class="modal-body">
          <p style="font-size:12px; color:var(--text-muted); margin-top:0;">
            Pastikan sudah memilih <strong>Agenda Ujian</strong> di Tab Bank Soal.
            File CSV harus memiliki kolom: No_Soal, Mata_Pelajaran, Pertanyaan, Type_Soal
            (opsional: Gambar_URL, pilihan, pernyataan, pasangan).
          </p>

          <!-- daftar mapel yg tersedia utk agenda ini -->
          <div id="import-banksoal-mapel-list"
               style="margin:8px 0 10px; padding:8px; border-radius:6px; border:1px solid #e5e7eb; background:#f9fafb; font-size:12px;">
            <!-- diisi dinamis oleh JS -->
          </div>

          <button type="button" onclick="downloadTemplateBankSoal()">Download Template Bank Soal</button>

          <div style="margin-top:10px;">
            <label>
              Pilih file CSV:
              <input type="file" id="file_import_banksoal" accept=".csv" style="margin-top:6px;">
            </label>
          </div>
          <div style="margin-top:10px;">
            <button type="button" onclick="importBankSoalFromFile()">Import</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Reset Jawaban -->
    <div id="modal-reset-jawaban" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">Reset Jawaban Siswa</div>
            <p class="section-subtitle">Pilih mata pelajaran yang akan direset untuk siswa ini.</p>
          </div>
          <button type="button" class="modal-close-btn" onclick="hideModal('modal-reset-jawaban')">&times;</button>
        </div>
        <div class="modal-body">
          <div id="resetStudentInfo" style="margin-bottom: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px;">
            <strong id="resetStudentName">Nama Siswa</strong><br>
            <small id="resetStudentAgenda">Agenda: -</small><br>
            <small id="resetStudentStatus">Status: -</small>
          </div>
          
          <div id="resetMapelList" style="max-height: 300px; overflow-y: auto;">
            <p style="font-size: 12px; color: var(--text-muted);">Memuat daftar mata pelajaran...</p>
          </div>
          
          <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
            <button type="button" onclick="hideModal('modal-reset-jawaban')">Batal</button>
            <button type="button" onclick="confirmResetJawaban()" style="background: var(--warning);">Reset Jawaban Terpilih</button>
          </div>
        </div>
      </div>
    </div>
    

    <!-- Modern Notification System -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog">
      <div class="confirmation-box">
        <div class="confirmation-icon warning">‚ö†Ô∏è</div>
        <h3 class="confirmation-title" id="dialogTitle">Konfirmasi</h3>
        <p class="confirmation-message" id="dialogMessage">Apakah Anda yakin?</p>
        <div class="confirmation-buttons">
          <button class="confirmation-btn cancel" onclick="hideConfirmation()">Batal</button>
          <button class="confirmation-btn confirm" id="confirmActionBtn">Ya, Lanjutkan</button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-notification" id="toastNotification">
      <span class="toast-icon">üìã</span>
      <span class="toast-message" id="toastMessage">Pesan toast</span>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-text">Developed by D14nr ¬© 2026</div>
        <div class="footer-subtext">Portal Admin CBT 2026</div>
      </div>
    </footer>

    <!-- Area khusus untuk print kartu -->
    <div id="printArea"></div>

    <script>
// ====== KONFIGURASI SUPABASE ======
const SUPABASE_URL = 'https://hkyjuzrovvuijqncpbdl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhreWp1enJvdnZ1aWpxbmNwYmRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODkyMjMsImV4cCI6MjA4NDA2NTIyM30.DWgqBuPKqulzJDFGDK4HjPVohiss8zvXK3GbbXqSNaA';

// ====== INISIALISASI SUPABASE ======
let supabase;

function initializeSupabase() {
  try {
    if (typeof createClient !== 'undefined') {
      supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized successfully');
      return true;
    } else {
      console.error('Supabase SDK not loaded');
      showNotification('error', 'SDK Error', 'Supabase SDK tidak ditemukan. Pastikan script CDN terload.');
      return false;
    }
  } catch (error) {
    console.error('Supabase initialization error:', error);
    showNotification('error', 'Supabase Error', 'Gagal menginisialisasi Supabase: ' + error.message);
    return false;
  }
}

// ====== VARIABEL GLOBAL ======
let pesertaNameMap = {};
let currentAgendaForMapel = '';
let currentAgendaForBank = '';
let importBankSoalMapelMap = {};
let currentMapelForBank = '';
let currentAgendaForKartu = '';
let kartuPesertaList = [];
let agendaCache = {};
let selectedJawabanForReset = null;
let resetMapelList = [];

// ====== UTILITY FUNCTIONS ======

function showNotification(type, title, message, duration = 5000) {
  const container = document.getElementById('notificationContainer');
  if (!container) return;
  
  const id = 'notification-' + Date.now();
  
  const iconMap = {
    success: '‚úì',
    error: '‚úó',
    warning: '‚ö†',
    info: '‚Ñπ'
  };
  
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.id = id;
  
  notification.innerHTML = `
    <div class="notification-icon">${iconMap[type] || '‚Ñπ'}</div>
    <div class="notification-content">
      <div class="notification-title">${title}</div>
      <div class="notification-message">${message}</div>
    </div>
    <button class="notification-close" onclick="closeNotification('${id}')">&times;</button>
    <div class="notification-progress">
      <div class="notification-progress-bar" style="transform: scaleX(1); transition: transform ${duration}ms linear;"></div>
    </div>
  `;
  
  container.appendChild(notification);
  
  setTimeout(() => {
    notification.classList.add('show');
    
    setTimeout(() => {
      const progressBar = notification.querySelector('.notification-progress-bar');
      if (progressBar) {
        progressBar.style.transform = 'scaleX(0)';
      }
    }, 10);
  }, 10);
  
  if (duration > 0) {
    setTimeout(() => {
      closeNotification(id);
    }, duration);
  }
  
  return id;
}

function closeNotification(id) {
  const notification = document.getElementById(id);
  if (notification) {
    notification.classList.remove('show');
    notification.classList.add('hide');
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 400);
  }
}

function hideAllNotifications() {
  const notifications = document.querySelectorAll('.notification');
  notifications.forEach(notification => {
    notification.classList.remove('show');
    notification.classList.add('hide');
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 400);
  });
}

function showConfirmation(title, message, onConfirm) {
  const dialog = document.getElementById('confirmationDialog');
  if (!dialog) return;
  
  document.getElementById('dialogTitle').textContent = title;
  document.getElementById('dialogMessage').textContent = message;
  
  const confirmBtn = document.getElementById('confirmActionBtn');
  confirmBtn.onclick = function() {
    hideConfirmation();
    if (typeof onConfirm === 'function') {
      onConfirm();
    }
  };
  
  dialog.classList.add('show');
}

function hideConfirmation() {
  const dialog = document.getElementById('confirmationDialog');
  if (dialog) {
    dialog.classList.remove('show');
  }
}

function showToast(message, duration = 3000) {
  const toast = document.getElementById('toastNotification');
  if (!toast) return;
  
  document.getElementById('toastMessage').textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

// ====== LOGIN FUNCTIONS ======

function checkLoginStatus() {
  const loggedIn = sessionStorage.getItem('adminLoggedIn');
  
  if (loggedIn === 'true') {
    document.body.className = 'app-page';
    showApp();
  } else {
    document.body.className = 'login-page';
    showLogin();
  }
}

function handleLogin() {
  const usernameInput = document.getElementById('login_username');
  const passwordInput = document.getElementById('login_password');
  
  if (!usernameInput || !passwordInput) {
    showNotification('error', 'Login Error', 'Form login tidak ditemukan');
    return;
  }
  
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();

  console.log('Login attempt:', { username, password });

  const validCredentials = [
    { user: 'Admin', pass: '290192' },
    { user: 'admin', pass: 'admin123' }
  ];
  
  const isValid = validCredentials.some(cred => 
    cred.user === username && cred.pass === password
  );
  
  if (isValid) {
    sessionStorage.setItem('adminLoggedIn', 'true');
    document.body.className = 'app-page';
    showApp();
    showNotification('success', 'Login Berhasil', 'Selamat datang di Portal Admin CBT 2026');
  } else {
    showNotification('error', 'Login Gagal', 'Username atau Password salah!');
    passwordInput.value = '';
    passwordInput.focus();
  }
}

function handleLogout() {
  showConfirmation(
    'Konfirmasi Logout',
    'Apakah Anda yakin ingin keluar dari sistem?',
    function() {
      sessionStorage.removeItem('adminLoggedIn');
      document.body.className = 'login-page';
      showLogin();
      showNotification('success', 'Logout Berhasil', 'Anda telah berhasil logout');
    }
  );
}

function showApp() {
  const loginSection = document.getElementById('login-section');
  const appShell = document.getElementById('app-shell');
  
  if (loginSection && appShell) {
    loginSection.style.display = 'none';
    appShell.style.display = 'block';
    
    // Load data setelah masuk
    setTimeout(() => {
      if (supabase) {
        loadPeserta();
        loadAgenda();
        loadAgendaListForPeserta();
        loadAgendaListForMapelDropdown();
        loadAgendaListForBankSoalDropdown();
        loadAgendaListForCetakKartuDropdown();
        loadMonitoring();
        loadJawaban();
      }
      showTab('peserta');
    }, 100);
  }
}

function showLogin() {
  const loginSection = document.getElementById('login-section');
  const appShell = document.getElementById('app-shell');
  
  if (loginSection && appShell) {
    loginSection.style.display = 'flex';
    appShell.style.display = 'none';
  }
  
  // Reset form login
  const usernameInput = document.getElementById('login_username');
  const passwordInput = document.getElementById('login_password');
  if (usernameInput) usernameInput.value = '';
  if (passwordInput) passwordInput.value = '';
}

// ====== TAB FUNCTIONS ======

function showTab(tab) {
  const tabs = ['peserta', 'agenda', 'mapel', 'banksoal', 'monitoring', 'jawaban', 'cetakkartu'];
  tabs.forEach(name => {
    const tabElement = document.getElementById('tab-' + name);
    const tabButton = document.getElementById('tab-btn-' + name);
    
    if (tabElement) {
      tabElement.style.display = (tab === name) ? 'block' : 'none';
    }
    if (tabButton) {
      tabButton.classList.toggle('active', tab === name);
    }
  });
}

// ====== PESERTA FUNCTIONS ======

function generateNISFromNoWA(noWa) {
  if (!noWa) return '';
  let digits = noWa.replace(/\D/g, '');
  if (digits.startsWith('0')) {
    digits = digits.substring(1);
  } else if (digits.startsWith('62')) {
    digits = digits.substring(2);
  }
  return digits;
}

function handleNoWAChange() {
  const noWa = document.getElementById('No_WA_Peserta').value;
  const nis = generateNISFromNoWA(noWa);
  document.getElementById('NIS_Username').value = nis;
}

async function loadPeserta() {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase belum terinisialisasi');
    return;
  }

  try {
    const { data, error } = await supabase
      .from('peserta')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    const tbody = document.querySelector('#pesertaTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    pesertaNameMap = {};

    data.forEach(item => {
      const firebaseId = item.id;
      const data = item;
      if (data.NIS_Username) {
        pesertaNameMap[data.NIS_Username] = data.Nama_Peserta || data.NIS_Username;
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.NIS_Username || ''}</td>
        <td>${data.Nama_Peserta || ''}</td>
        <td>
          <div class="password-wrapper" style="position: relative; display: inline-block; width: 120px;">
            <input type="password" value="${data.Password || ''}" readonly 
                   style="width: 100%; padding-right: 30px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; padding: 4px 30px 4px 8px;">
            <button type="button" class="toggle-password" onclick="togglePasswordVisibility(this.previousElementSibling, this)" 
                    style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; font-size: 11px; padding: 0;">
              üëÅÔ∏è
            </button>
          </div>
        </td>
        <td>${data.Jenjang_Studi || ''}</td>
        <td>${data.Kelas || ''}</td>
        <td>${data.Asal_Sekolah || ''}</td>
        <td>${data.No_WA_Peserta || ''}</td>
        <td>${data.No_WA_Ortu || ''}</td>
        <td class="actions">
          <button onclick="editPeserta('${firebaseId}')">Edit</button>
          <button onclick="deletePeserta('${firebaseId}')">Hapus</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (error) {
    showNotification('error', 'Error', 'Gagal membaca data peserta: ' + error.message);
  }
}

function openPesertaModalForCreate() {
  resetForm();
  showModal('modal-peserta');
}

async function savePeserta() {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  const firebaseId = document.getElementById('firebaseId').value;
  const Nama_Peserta = document.getElementById('Nama_Peserta').value.trim();
  const Password = document.getElementById('Password').value.trim();
  const Jenjang_Studi = document.getElementById('Jenjang_Studi').value.trim();
  const Kelas = document.getElementById('Kelas').value.trim();
  const Asal_Sekolah = document.getElementById('Asal_Sekolah').value.trim();
  const No_WA_Peserta = document.getElementById('No_WA_Peserta').value.trim();
  const No_WA_Ortu = document.getElementById('No_WA_Ortu').value.trim();
  const ID_Agenda = document.getElementById('ID_Agenda_Peserta').value.trim();

  const NIS_Username = generateNISFromNoWA(No_WA_Peserta);
  document.getElementById('NIS_Username').value = NIS_Username;

  if (!Nama_Peserta || !Password || !Jenjang_Studi || !Kelas ||
      !Asal_Sekolah || !No_WA_Peserta || !No_WA_Ortu || !ID_Agenda || !NIS_Username) {
    showNotification('error', 'Validasi Error', 'Mohon lengkapi semua field');
    return;
  }

  const data = {
    NIS_Username,
    Nama_Peserta,
    Password,
    Jenjang_Studi,
    Kelas,
    Asal_Sekolah,
    No_WA_Peserta,
    No_WA_Ortu,
    ID_Agenda
  };

  try {
    if (firebaseId) {
      const { error } = await supabase
        .from('peserta')
        .update(data)
        .eq('id', firebaseId);
      
      if (error) throw error;
      
      showNotification('success', 'Berhasil', 'Data peserta berhasil diperbarui');
      resetForm();
      hideModal('modal-peserta');
      loadPeserta();
    } else {
      const { error } = await supabase
        .from('peserta')
        .insert([data]);
      
      if (error) throw error;
      
      showNotification('success', 'Berhasil', 'Data peserta berhasil disimpan');
      resetForm();
      hideModal('modal-peserta');
      loadPeserta();
    }
  } catch (err) {
    showNotification('error', 'Gagal', 'Gagal menyimpan peserta: ' + err.message);
  }
}

async function editPeserta(id) {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  try {
    const { data, error } = await supabase
      .from('peserta')
      .select('*')
      .eq('id', id)
      .single();
    
    if (error) throw error;
    
    document.getElementById('firebaseId').value = id;
    document.getElementById('ID_Peserta').value = data.id || '';
    document.getElementById('NIS_Username').value = data.NIS_Username || '';
    document.getElementById('Nama_Peserta').value = data.Nama_Peserta || '';
    document.getElementById('Password').value = data.Password || '';
    document.getElementById('Jenjang_Studi').value = data.Jenjang_Studi || '';
    document.getElementById('Kelas').value = data.Kelas || '';
    document.getElementById('Asal_Sekolah').value = data.Asal_Sekolah || '';
    document.getElementById('No_WA_Peserta').value = data.No_WA_Peserta || '';
    document.getElementById('No_WA_Ortu').value = data.No_WA_Ortu || '';
    document.getElementById('ID_Agenda_Peserta').value = data.ID_Agenda || '';
    
    showModal('modal-peserta');
  } catch (err) {
    showNotification('error', 'Gagal', 'Gagal mengambil data peserta: ' + err.message);
  }
}

async function deletePeserta(id) {
  showConfirmation(
    'Hapus Peserta',
    'Apakah Anda yakin ingin menghapus data peserta ini?',
    async function() {
      if (!supabase) {
        showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
        return;
      }

      try {
        const { error } = await supabase
          .from('peserta')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showNotification('success', 'Berhasil', 'Data peserta berhasil dihapus');
        loadPeserta();
      } catch (err) {
        showNotification('error', 'Gagal', 'Gagal menghapus peserta: ' + err.message);
      }
    }
  );
}

function resetForm() {
  document.getElementById('firebaseId').value = '';
  const form = document.getElementById('pesertaForm');
  if (form) form.reset();
  document.getElementById('ID_Peserta').value = '';
  document.getElementById('NIS_Username').value = '';
}

// ====== AGENDA FUNCTIONS ======

function generateRandomToken() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  const length = 6 + Math.floor(Math.random() * 3);
  let token = '';
  for (let i = 0; i < length; i++) {
    token += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return token;
}

function generateTokenUjian() {
  const token = generateRandomToken();
  document.getElementById('Token_Ujian').value = token;
}

async function loadAgenda() {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase belum terinisialisasi');
    return;
  }

  try {
    const { data, error } = await supabase
      .from('agenda_ujian')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    const tbody = document.querySelector('#agendaTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    agendaCache = {};
    
    data.forEach(item => {
      const id = item.id;
      const data = item;
      agendaCache[id] = data;
      
      const mulai = data.TglJam_Mulai ? data.TglJam_Mulai.replace('T', ' ') : '';
      const selesai = data.TglJam_Selesai ? data.TglJam_Selesai.replace('T', ' ') : '';
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.Agenda_Ujian || ''}</td>
        <td>${data.Deskripsi_Ujian || ''}</td>
        <td>${data.Jenjang_Studi || ''}</td>
        <td>${data.Jenis_Tes || ''}</td>
        <td>${mulai}</td>
        <td>${selesai}</td>
        <td>${data.Token_Ujian || ''}</td>
        <td class="actions">
          <button onclick="editAgenda('${id}')">Edit</button>
          <button onclick="deleteAgenda('${id}')">Hapus</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (error) {
    showNotification('error', 'Error', 'Gagal membaca data agenda: ' + error.message);
  }
}

async function loadAgendaListForPeserta() {
  const select = document.getElementById('ID_Agenda_Peserta');
  if (!select) return;
  
  if (!supabase) return;

  try {
    const { data, error } = await supabase
      .from('agenda_ujian')
      .select('id, Agenda_Ujian, Jenjang_Studi')
      .order('Agenda_Ujian', { ascending: true });
    
    if (error) throw error;
    
    const currentValue = select.value;
    select.innerHTML = '<option value="">-- Pilih Agenda --</option>';
    
    data.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.id;
      let label = item.Agenda_Ujian || item.id;
      if (item.Jenjang_Studi) label += ' (' + item.Jenjang_Studi + ')';
      opt.textContent = label;
      select.appendChild(opt);
    });
    
    if (currentValue) select.value = currentValue;
  } catch (error) {
    console.error('Error loading agenda for peserta:', error);
  }
}

async function loadAgendaListForMapelDropdown() {
  const select = document.getElementById('Mapel_Agenda_Select');
  if (!select) return;
  
  if (!supabase) return;

  try {
    const { data, error } = await supabase
      .from('agenda_ujian')
      .select('id, Agenda_Ujian, Jenjang_Studi')
      .order('Agenda_Ujian', { ascending: true });
    
    if (error) throw error;
    
    const currentValue = select.value;
    select.innerHTML = '<option value="">-- Pilih Agenda Ujian dulu --</option>';
    
    data.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.id;
      let label = item.Agenda_Ujian || item.id;
      if (item.Jenjang_Studi) label += ' (' + item.Jenjang_Studi + ')';
      opt.textContent = label;
      select.appendChild(opt);
    });
    
    if (currentValue) select.value = currentValue;
  } catch (error) {
    console.error('Error loading agenda for mapel:', error);
  }
}

async function loadAgendaListForBankSoalDropdown() {
  const select = document.getElementById('Bank_Agenda_Select');
  if (!select) return;
  
  if (!supabase) return;

  try {
    const { data, error } = await supabase
      .from('agenda_ujian')
      .select('id, Agenda_Ujian, Jenjang_Studi')
      .order('Agenda_Ujian', { ascending: true });
    
    if (error) throw error;
    
    const currentValue = select.value;
    select.innerHTML = '<option value="">-- Pilih Agenda Ujian dulu --</option>';
    
    data.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.id;
      let label = item.Agenda_Ujian || item.id;
      if (item.Jenjang_Studi) label += ' (' + item.Jenjang_Studi + ')';
      opt.textContent = label;
      select.appendChild(opt);
    });
    
    if (currentValue) select.value = currentValue;
  } catch (error) {
    console.error('Error loading agenda for bank soal:', error);
  }
}

async function loadAgendaListForCetakKartuDropdown() {
  const select = document.getElementById('CetakKartu_Agenda_Select');
  if (!select) return;
  
  if (!supabase) return;

  try {
    const { data, error } = await supabase
      .from('agenda_ujian')
      .select('id, Agenda_Ujian, Jenjang_Studi')
      .order('Agenda_Ujian', { ascending: true });
    
    if (error) throw error;
    
    const currentValue = select.value;
    select.innerHTML = '<option value="">-- Pilih Agenda Ujian dulu --</option>';
    
    data.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.id;
      let label = item.Agenda_Ujian || item.id;
      if (item.Jenjang_Studi) label += ' (' + item.Jenjang_Studi + ')';
      opt.textContent = label;
      select.appendChild(opt);
    });
    
    if (currentValue) select.value = currentValue;
  } catch (error) {
    console.error('Error loading agenda for cetak kartu:', error);
  }
}

function openAgendaModalForCreate() {
  resetAgendaForm();
  showModal('modal-agenda');
}

async function saveAgenda() {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  const id = document.getElementById('firebaseAgendaId').value;
  const Agenda_Ujian = document.getElementById('Agenda_Ujian').value.trim();
  const Deskripsi_Ujian = document.getElementById('Deskripsi_Ujian').value.trim();
  const Jenjang_Studi = document.getElementById('Jenjang_Studi_Agenda').value.trim();
  const Jenis_Tes = document.getElementById('Jenis_Tes').value.trim();
  const TglJam_Mulai = document.getElementById('TglJam_Mulai').value;
  const TglJam_Selesai = document.getElementById('TglJam_Selesai').value;
  let Token_Ujian = document.getElementById('Token_Ujian').value.trim().toUpperCase();

  if (!Agenda_Ujian || !Deskripsi_Ujian || !Jenjang_Studi || !Jenis_Tes || !TglJam_Mulai || !TglJam_Selesai) {
    showNotification('error', 'Validasi Error', 'Mohon lengkapi semua field agenda ujian');
    return;
  }

  Token_Ujian = Token_Ujian.replace(/[^A-Z0-9]/g, '');
  if (Token_Ujian.length < 6 || Token_Ujian.length > 8) {
    Token_Ujian = generateRandomToken();
  }
  document.getElementById('Token_Ujian').value = Token_Ujian;

  const data = {
    Agenda_Ujian,
    Deskripsi_Ujian,
    Jenjang_Studi,
    Jenis_Tes,
    TglJam_Mulai,
    TglJam_Selesai,
    Token_Ujian
  };

  try {
    if (id) {
      const { error } = await supabase
        .from('agenda_ujian')
        .update(data)
        .eq('id', id);
      
      if (error) throw error;
      
      showNotification('success', 'Berhasil', 'Agenda ujian berhasil diperbarui');
      resetAgendaForm();
      hideModal('modal-agenda');
      loadAgenda();
    } else {
      const { error } = await supabase
        .from('agenda_ujian')
        .insert([data]);
      
      if (error) throw error;
      
      showNotification('success', 'Berhasil', 'Agenda ujian berhasil disimpan');
      resetAgendaForm();
      hideModal('modal-agenda');
      loadAgenda();
    }
  } catch (err) {
    showNotification('error', 'Gagal', 'Gagal menyimpan agenda: ' + err.message);
  }
}

async function editAgenda(id) {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  try {
    const { data, error } = await supabase
      .from('agenda_ujian')
      .select('*')
      .eq('id', id)
      .single();
    
    if (error) throw error;
    
    document.getElementById('firebaseAgendaId').value = id;
    document.getElementById('ID_Agenda_Agenda').value = data.id || '';
    document.getElementById('Agenda_Ujian').value = data.Agenda_Ujian || '';
    document.getElementById('Deskripsi_Ujian').value = data.Deskripsi_Ujian || '';
    document.getElementById('Jenjang_Studi_Agenda').value = data.Jenjang_Studi || '';
    document.getElementById('Jenis_Tes').value = data.Jenis_Tes || '';
    document.getElementById('TglJam_Mulai').value = data.TglJam_Mulai || '';
    document.getElementById('TglJam_Selesai').value = data.TglJam_Selesai || '';
    document.getElementById('Token_Ujian').value = data.Token_Ujian || '';
    
    showModal('modal-agenda');
  } catch (err) {
    showNotification('error', 'Gagal', 'Gagal mengambil data agenda: ' + err.message);
  }
}

async function deleteAgenda(id) {
  showConfirmation(
    'Hapus Agenda',
    'Apakah Anda yakin ingin menghapus agenda ujian ini?',
    async function() {
      if (!supabase) {
        showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
        return;
      }

      try {
        const { error } = await supabase
          .from('agenda_ujian')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showNotification('success', 'Berhasil', 'Agenda ujian berhasil dihapus');
        loadAgenda();
      } catch (err) {
        showNotification('error', 'Gagal', 'Gagal menghapus agenda: ' + err.message);
      }
    }
  );
}

function resetAgendaForm() {
  document.getElementById('firebaseAgendaId').value = '';
  const form = document.getElementById('agendaForm');
  if (form) form.reset();
  document.getElementById('ID_Agenda_Agenda').value = '';
  document.getElementById('Token_Ujian').value = '';
}

// ====== MATA PELAJARAN FUNCTIONS ======

function onChangeAgendaMapel() {
  currentAgendaForMapel = document.getElementById('Mapel_Agenda_Select').value;
  const idAgendaInput = document.getElementById('ID_Agenda_Mapel');
  if (idAgendaInput) {
    idAgendaInput.value = currentAgendaForMapel || '';
  }
  resetMapelForm(false);
  loadMapelTable();
}

async function loadMapelTable() {
  const tbody = document.querySelector('#mapelTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (!currentAgendaForMapel || !supabase) return;
  
  try {
    const { data, error } = await supabase
      .from('mata_pelajaran')
      .select('*')
      .eq('ID_Agenda', currentAgendaForMapel)
      .order('Nama_Mata_Pelajaran', { ascending: true });
    
    if (error) throw error;
    
    data.forEach(item => {
      const id = item.id;
      const data = item;
      const isSiap = data.Status_Mapel === 'Siap';
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.Nama_Mata_Pelajaran || ''}</td>
        <td>${data.Jumlah_Soal || ''}</td>
        <td>${data.Durasi_Ujian || ''}</td>
        <td>
          <label style="display:flex; align-items:center; gap:4px; font-weight:400;">
            <input type="checkbox" ${isSiap ? 'checked' : ''} 
                   onchange="toggleStatusMapel('${id}', this.checked)">
            <span>${isSiap ? 'Siap' : 'Draft'}</span>
          </label>
        </td>
        <td class="actions">
          <button onclick="editMapel('${id}')">Edit</button>
          <button onclick="deleteMapel('${id}')">Hapus</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    showNotification('error', 'Error', 'Gagal membaca data mapel: ' + err.message);
  }
}

function openMapelModalForCreate() {
  if (!currentAgendaForMapel) {
    showNotification('error', 'Error', 'Pilih Agenda Ujian terlebih dahulu');
    return;
  }
  resetMapelForm(false);
  showModal('modal-mapel');
}

async function saveMapel() {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  const id = document.getElementById('firebaseMapelId').value;
  const ID_Agenda = currentAgendaForMapel;
  
  if (!ID_Agenda) {
    showNotification('error', 'Error', 'Pilih Agenda Ujian terlebih dahulu');
    return;
  }
  
  const Nama_Mata_Pelajaran = document.getElementById('Nama_Mata_Pelajaran').value.trim();
  const Jumlah_Soal = document.getElementById('Jumlah_Soal').value.trim();
  const Durasi_Ujian = document.getElementById('Durasi_Ujian').value.trim();
  let Status_Mapel = document.getElementById('Status_Mapel').value || 'Draft';

  if (!Nama_Mata_Pelajaran || !Jumlah_Soal || !Durasi_Ujian) {
    showNotification('error', 'Validasi Error', 'Mohon lengkapi semua field mata pelajaran');
    return;
  }
  
  const data = {
    ID_Agenda,
    Nama_Mata_Pelajaran,
    Jumlah_Soal,
    Durasi_Ujian,
    Status_Mapel
  };
  
  try {
    if (id) {
      const { error } = await supabase
        .from('mata_pelajaran')
        .update(data)
        .eq('id', id);
      
      if (error) throw error;
      
      showNotification('success', 'Berhasil', 'Mata pelajaran berhasil diperbarui');
      resetMapelForm(false);
      loadMapelTable();
      hideModal('modal-mapel');
    } else {
      const { error } = await supabase
        .from('mata_pelajaran')
        .insert([data]);
      
      if (error) throw error;
      
      showNotification('success', 'Berhasil', 'Mata pelajaran berhasil disimpan');
      resetMapelForm(false);
      loadMapelTable();
      hideModal('modal-mapel');
    }
  } catch (err) {
    showNotification('error', 'Gagal', 'Gagal menyimpan mapel: ' + err.message);
  }
}

async function editMapel(id) {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  try {
    const { data, error } = await supabase
      .from('mata_pelajaran')
      .select('*')
      .eq('id', id)
      .single();
    
    if (error) throw error;
    
    document.getElementById('firebaseMapelId').value = id;
    currentAgendaForMapel = data.ID_Agenda || '';
    const agendaSelect = document.getElementById('Mapel_Agenda_Select');
    if (agendaSelect) agendaSelect.value = currentAgendaForMapel;
    
    document.getElementById('ID_Agenda_Mapel').value = currentAgendaForMapel;
    document.getElementById('ID_Mapel_Mapel').value = data.id || '';
    document.getElementById('Nama_Mata_Pelajaran').value = data.Nama_Mata_Pelajaran || '';
    document.getElementById('Jumlah_Soal').value = data.Jumlah_Soal || '';
    document.getElementById('Durasi_Ujian').value = data.Durasi_Ujian || '';
    document.getElementById('Status_Mapel').value = data.Status_Mapel || 'Draft';
    
    showModal('modal-mapel');
  } catch (err) {
    showNotification('error', 'Gagal', 'Gagal mengambil data mapel: ' + err.message);
  }
}

async function deleteMapel(id) {
  showConfirmation(
    'Hapus Mata Pelajaran',
    'Apakah Anda yakin ingin menghapus mata pelajaran ini?',
    async function() {
      if (!supabase) {
        showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
        return;
      }

      try {
        const { error } = await supabase
          .from('mata_pelajaran')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showNotification('success', 'Berhasil', 'Mata pelajaran berhasil dihapus');
        loadMapelTable();
      } catch (err) {
        showNotification('error', 'Gagal', 'Gagal menghapus mapel: ' + err.message);
      }
    }
  );
}

async function toggleStatusMapel(id, isSiap) {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  try {
    const newStatus = isSiap ? 'Siap' : 'Draft';
    const { error } = await supabase
      .from('mata_pelajaran')
      .update({ Status_Mapel: newStatus })
      .eq('id', id);
    
    if (error) throw error;
    
    loadMapelTable();
  } catch (err) {
    showNotification('error', 'Gagal', 'Gagal mengubah status mapel: ' + err.message);
  }
}

function resetMapelForm(resetAgenda = true) {
  document.getElementById('firebaseMapelId').value = '';
  const form = document.getElementById('mapelForm');
  if (form) form.reset();
  document.getElementById('ID_Mapel_Mapel').value = '';
  document.getElementById('Status_Mapel').value = 'Draft';
  
  if (resetAgenda) {
    currentAgendaForMapel = '';
    const agendaSelect = document.getElementById('Mapel_Agenda_Select');
    if (agendaSelect) agendaSelect.value = '';
    document.getElementById('ID_Agenda_Mapel').value = '';
  } else {
    document.getElementById('ID_Agenda_Mapel').value = currentAgendaForMapel || '';
  }
}

// ====== BANK SOAL FUNCTIONS ======

function onTypeSoalChange() {
  const type = document.getElementById('Type_Soal').value;
  const pg = document.getElementById('group-pg');
  const perny = document.getElementById('group-pernyataan');
  const pejodohan = document.getElementById('group-pejodohan');
  
  if (pg) pg.style.display = 'none';
  if (perny) perny.style.display = 'none';
  if (pejodohan) pejodohan.style.display = 'none';

  if (type === 'Pilihan Ganda Tunggal' || type === 'Pilihan Ganda Kompleks') {
    if (pg) pg.style.display = 'block';
  } else if (type === 'Pilihan Benar/Salah' || type === 'Pilihan Setuju/Tidak') {
    if (perny) perny.style.display = 'block';
  } else if (type === 'Pilihan Pejodohan') {
    if (pejodohan) pejodohan.style.display = 'block';
  }
}

async function setAutoNoSoal() {
  if (!currentAgendaForBank || !supabase) return;
  
  try {
    const { data, error } = await supabase
      .from('bank_soal')
      .select('No_Soal')
      .eq('ID_Agenda', currentAgendaForBank);
    
    if (error) throw error;
    
    let maxNo = 0;
    data.forEach(item => {
      const n = parseInt(item.No_Soal, 10);
      if (!isNaN(n) && n > maxNo) maxNo = n;
    });
    
    const noSoalInput = document.getElementById('No_Soal');
    if (noSoalInput) {
      noSoalInput.value = maxNo + 1;
    }
  } catch (err) {
    console.error('Gagal menghitung No_Soal:', err);
  }
}

async function onChangeAgendaBankSoal() {
  currentAgendaForBank = document.getElementById('Bank_Agenda_Select').value;
  const idAgendaInput = document.getElementById('ID_Agenda_Bank');
  if (idAgendaInput) {
    idAgendaInput.value = currentAgendaForBank || '';
  }
  
  currentMapelForBank = '';
  const mapelSelect = document.getElementById('Bank_Mapel_Select');
  if (mapelSelect) {
    mapelSelect.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
  }
  
  const idMapelInput = document.getElementById('ID_Mapel_Bank');
  if (idMapelInput) {
    idMapelInput.value = '';
  }
  
  const namaMapelInput = document.getElementById('Nama_Mata_Pelajaran_Bank');
  if (namaMapelInput) {
    namaMapelInput.value = '';
  }
  
  const tbody = document.querySelector('#bankSoalTable tbody');
  if (tbody) {
    tbody.innerHTML = '';
  }
  
  const noSoalInput = document.getElementById('No_Soal');
  if (noSoalInput) {
    noSoalInput.value = '';
  }
  
  if (!currentAgendaForBank || !supabase) return;
  
  const select = document.getElementById('Bank_Mapel_Select');
  if (!select) return;
  
  try {
    const { data, error } = await supabase
      .from('mata_pelajaran')
      .select('id, Nama_Mata_Pelajaran')
      .eq('ID_Agenda', currentAgendaForBank)
      .order('Nama_Mata_Pelajaran', { ascending: true });
    
    if (error) throw error;
    
    data.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.id;
      opt.textContent = item.Nama_Mata_Pelajaran || item.id;
      opt.dataset.nama = item.Nama_Mata_Pelajaran || '';
      select.appendChild(opt);
    });
  } catch (err) {
    showNotification('error', 'Error', 'Gagal membaca mapel: ' + err.message);
  }
}

function onChangeMapelBankSoal() {
  const select = document.getElementById('Bank_Mapel_Select');
  if (!select) return;
  
  currentMapelForBank = select.value;
  const idMapelInput = document.getElementById('ID_Mapel_Bank');
  if (idMapelInput) {
    idMapelInput.value = currentMapelForBank || '';
  }
  
  let nama = '';
  if (select && select.selectedIndex >= 0) {
    const opt = select.options[select.selectedIndex];
    if (opt && opt.dataset) nama = opt.dataset.nama || '';
  }
  
  const namaMapelInput = document.getElementById('Nama_Mata_Pelajaran_Bank');
  if (namaMapelInput) {
    namaMapelInput.value = nama;
  }
  
  resetBankSoalForm(false);
  loadBankSoalTable();
}

async function loadBankSoalTable() {
  const tbody = document.querySelector('#bankSoalTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (!currentMapelForBank || !supabase) return;
  
  try {
    const { data, error } = await supabase
      .from('bank_soal')
      .select('*')
      .eq('ID_Mapel', currentMapelForBank)
      .order('No_Soal', { ascending: true });
    
    if (error) throw error;
    
    data.forEach(item => {
      const tr = document.createElement('tr');
      const pertSingkat = (item.Pertanyaan || '').length > 80
        ? item.Pertanyaan.substring(0, 80) + '...'
        : (item.Pertanyaan || '');
      
      const gambarCell = item.Gambar
        ? `<a href="${item.Gambar}" target="_blank" title="Lihat gambar">üì∑</a>` : '';
      
      tr.innerHTML = `
        <td><input type="checkbox" class="banksoal-checkbox" value="${item.id}"></td>
        <td>${item.No_Soal || ''}</td>
        <td>${item.Type_Soal || ''}</td>
        <td>${pertSingkat}</td>
        <td>${gambarCell}</td>
        <td class="actions">
          <button onclick="editSoal('${item.id}')">Edit</button>
          <button onclick="deleteSoal('${item.id}')">Hapus</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    showNotification('error', 'Error', 'Gagal membaca bank soal: ' + err.message);
  }
}

function toggleSelectAllBankSoal(src) {
  const cbs = document.querySelectorAll('.banksoal-checkbox');
  cbs.forEach(cb => cb.checked = src.checked);
}

function selectAllBankSoal() {
  const cbs = document.querySelectorAll('.banksoal-checkbox');
  cbs.forEach(cb => cb.checked = true);
  const selectAll = document.getElementById('bankSoal_select_all');
  if (selectAll) {
    selectAll.checked = true;
  }
}

function deselectAllBankSoal() {
  const cbs = document.querySelectorAll('.banksoal-checkbox');
  cbs.forEach(cb => cb.checked = false);
  const selectAll = document.getElementById('bankSoal_select_all');
  if (selectAll) {
    selectAll.checked = false;
  }
}

async function deleteSelectedBankSoal() {
  const checked = document.querySelectorAll('.banksoal-checkbox:checked');
  if (!checked.length) {
    showNotification('warning', 'Peringatan', 'Pilih soal yang akan dihapus');
    return;
  }
  
  showConfirmation(
    'Hapus Soal Terpilih',
    `Yakin akan menghapus ${checked.length} soal terpilih?`,
    async function() {
      if (!supabase) {
        showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
        return;
      }

      try {
        const ids = Array.from(checked).map(cb => cb.value);
        const { error } = await supabase
          .from('bank_soal')
          .delete()
          .in('id', ids);
        
        if (error) throw error;
        
        showNotification('success', 'Berhasil', `${checked.length} soal berhasil dihapus`);
        loadBankSoalTable();
      } catch (err) {
        showNotification('error', 'Gagal', 'Gagal menghapus soal: ' + err.message);
      }
    }
  );
}

async function deleteAllBankSoal() {
  if (!currentMapelForBank) {
    showNotification('error', 'Error', 'Pilih mata pelajaran terlebih dahulu');
    return;
  }
  
  showConfirmation(
    'Hapus Semua Soal',
    'Yakin akan menghapus SEMUA soal pada mata pelajaran ini? Tindakan ini tidak dapat dibatalkan!',
    async function() {
      if (!supabase) {
        showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
        return;
      }

      try {
        const { error } = await supabase
          .from('bank_soal')
          .delete()
          .eq('ID_Mapel', currentMapelForBank);
        
        if (error) throw error;
        
        showNotification('success', 'Berhasil', 'Semua soal berhasil dihapus');
        loadBankSoalTable();
      } catch (err) {
        showNotification('error', 'Gagal', 'Gagal menghapus soal: ' + err.message);
      }
    }
  );
}

// ====== IMPORT FUNCTIONS ======

function downloadTemplatePeserta() {
  const headers = [
    'Nama_Peserta',
    'Password',
    'Jenjang_Studi',
    'Kelas',
    'Asal_Sekolah',
    'No_WA_Peserta',
    'No_WA_Ortu',
    'ID_Agenda'
  ];
  
  const exampleRow = [
    'Budi Santoso',
    'password123',
    'SMA',
    '12 IPA 1',
    'SMA Negeri 1 Jakarta',
    '08123456789',
    '08129876543',
    'agenda_id_1'
  ];
  
  const csvContent = [headers.join(','), exampleRow.join(',')].join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'Template_Import_Peserta.csv';
  link.style.display = 'none';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  showNotification('success', 'Template Downloaded', 'File template peserta berhasil diunduh');
}

async function importPesertaFromFile() {
  const fileInput = document.getElementById('file_import_peserta');
  const file = fileInput.files[0];
  
  if (!file) {
    showNotification('error', 'Error', 'Pilih file CSV terlebih dahulu');
    return;
  }
  
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const csvContent = e.target.result;
      const rows = csvContent.split('\n');
      
      if (rows.length < 2) {
        showNotification('error', 'Error', 'File CSV kosong atau format salah');
        return;
      }
      
      const headers = rows[0].split(',').map(h => h.trim());
      const requiredCols = ['Nama_Peserta', 'Password', 'No_WA_Peserta', 'ID_Agenda'];
      const missingCols = requiredCols.filter(col => !headers.includes(col));
      
      if (missingCols.length > 0) {
        showNotification('error', 'Format Error', `Kolom wajib tidak ditemukan: ${missingCols.join(', ')}`);
        return;
      }
      
      showNotification('info', 'Memproses', `Mengimport ${rows.length - 1} peserta...`, 0);
      
      let successCount = 0;
      let errorCount = 0;
      const pesertaData = [];
      
      for (let i = 1; i < rows.length; i++) {
        if (!rows[i].trim()) continue;
        
        const cols = rows[i].split(',').map(c => c.trim());
        if (cols.length < 4) continue;
        
        const rowData = {};
        headers.forEach((header, index) => {
          if (index < cols.length) {
            rowData[header] = cols[index];
          }
        });
        
        // Generate NIS from phone number
        const noWa = rowData.No_WA_Peserta || '';
        const nis = generateNISFromNoWA(noWa);
        
        if (!nis) {
          errorCount++;
          continue;
        }
        
        const data = {
          NIS_Username: nis,
          Nama_Peserta: rowData.Nama_Peserta || '',
          Password: rowData.Password || '123456',
          Jenjang_Studi: rowData.Jenjang_Studi || '',
          Kelas: rowData.Kelas || '',
          Asal_Sekolah: rowData.Asal_Sekolah || '',
          No_WA_Peserta: noWa,
          No_WA_Ortu: rowData.No_WA_Ortu || '',
          ID_Agenda: rowData.ID_Agenda || ''
        };
        
        // Check for required fields
        if (!data.Nama_Peserta || !data.Password || !data.ID_Agenda) {
          errorCount++;
          continue;
        }
        
        pesertaData.push(data);
      }
      
      if (pesertaData.length > 0) {
        const { error } = await supabase
          .from('peserta')
          .insert(pesertaData);
        
        if (error) throw error;
        
        successCount = pesertaData.length;
      }
      
      hideAllNotifications();
      
      if (successCount > 0) {
        showNotification('success', 'Import Berhasil', 
          `${successCount} peserta berhasil diimport. ${errorCount > 0 ? `(${errorCount} gagal)` : ''}`);
        loadPeserta();
      } else {
        showNotification('error', 'Import Gagal', 
          `Tidak ada peserta yang berhasil diimport. ${errorCount} error.`);
      }
      
      hideModal('modal-import-peserta');
      fileInput.value = '';
      
    } catch (error) {
      hideAllNotifications();
      showNotification('error', 'Parse Error', 'Gagal membaca file CSV: ' + error.message);
    }
  };
  
  reader.onerror = function() {
    showNotification('error', 'File Error', 'Gagal membaca file');
  };
  
  reader.readAsText(file);
}

function openBankSoalModalForCreate() {
  if (!currentAgendaForBank || !currentMapelForBank) {
    showNotification('error', 'Error', 'Pilih Agenda Ujian dan Mata Pelajaran terlebih dahulu');
    return;
  }
  resetBankSoalForm(false);
  showModal('modal-banksoal');
}

async function saveSoal() {
  if (!currentAgendaForBank || !currentMapelForBank) {
    showNotification('error', 'Error', 'Pilih Agenda Ujian dan Mata Pelajaran terlebih dahulu');
    return;
  }
  
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  try {
    const id = document.getElementById('firebaseSoalId').value;
    const ID_Agenda = currentAgendaForBank;
    const ID_Mapel = currentMapelForBank;
    const Nama_Mata_Pelajaran = document.getElementById('Nama_Mata_Pelajaran_Bank').value || '';
    const No_Soal = document.getElementById('No_Soal').value.trim();
    const Pertanyaan = document.getElementById('Pertanyaan').value.trim();
    const Type_Soal = document.getElementById('Type_Soal').value;
    
    if (!No_Soal || !Pertanyaan || !Type_Soal) {
      showNotification('error', 'Validasi Error', 'No Soal, Pertanyaan, dan Type Soal wajib diisi');
      return;
    }
    
    const data = {
      ID_Agenda: ID_Agenda,
      ID_Mapel: ID_Mapel,
      Nama_Mata_Pelajaran: Nama_Mata_Pelajaran,
      No_Soal: No_Soal,
      Pertanyaan: Pertanyaan,
      Type_Soal: Type_Soal,
      Pilihan_A: document.getElementById('Pilihan_A')?.value.trim() || '',
      Pilihan_B: document.getElementById('Pilihan_B')?.value.trim() || '',
      Pilihan_C: document.getElementById('Pilihan_C')?.value.trim() || '',
      Pilihan_D: document.getElementById('Pilihan_D')?.value.trim() || '',
      Pilihan_E: document.getElementById('Pilihan_E')?.value.trim() || ''
    };
    
    for (let i = 1; i <= 10; i++) {
      const element = document.getElementById('Pernyataan_' + i);
      if (element) {
        data['Pernyataan_' + i] = element.value.trim();
      }
    }
    
    for (let j = 1; j <= 10; j++) {
      const lk = document.getElementById('Pasangan_kiri_' + j);
      const rk = document.getElementById('Pasangan_kanan_' + j);
      if (lk) data['Pasangan_kiri_' + j] = lk.value.trim();
      if (rk) data['Pasangan_kanan_' + j] = rk.value.trim();
    }
    
    // File upload handling (simplified for Supabase)
    const fileInput = document.getElementById('Gambar');
    const file = fileInput.files[0];
    const existingUrl = document.getElementById('Gambar_Url').value || '';
    
    if (file) {
      showNotification('info', 'Upload Gambar', 'Menyimpan gambar...', 3000);
      // For Supabase Storage, you would need additional setup
      // For now, we'll just save the image as base64
      const reader = new FileReader();
      reader.onload = async function(e) {
        data.Gambar = e.target.result;
        await completeSaveSoal(id, data);
      };
      reader.readAsDataURL(file);
    } else {
      data.Gambar = existingUrl;
      await completeSaveSoal(id, data);
    }
    
  } catch (error) {
    console.error('Save soal error:', error);
    showNotification('error', 'Gagal', 'Gagal menyimpan soal: ' + error.message);
    hideAllNotifications();
  }
}

async function completeSaveSoal(id, data) {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  try {
    if (id) {
      const { error } = await supabase
        .from('bank_soal')
        .update(data)
        .eq('id', id);
      
      if (error) throw error;
      
      showNotification('success', 'Berhasil', 'Soal berhasil diperbarui');
    } else {
      const { error } = await supabase
        .from('bank_soal')
        .insert([data]);
      
      if (error) throw error;
      
      showNotification('success', 'Berhasil', 'Soal berhasil disimpan');
    }
    
    resetBankSoalForm(false);
    loadBankSoalTable();
    hideModal('modal-banksoal');
    hideAllNotifications();
    
  } catch (error) {
    showNotification('error', 'Gagal', 'Gagal menyimpan soal: ' + error.message);
    hideAllNotifications();
  }
}

async function editSoal(id) {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  try {
    const { data: soalData, error } = await supabase
      .from('bank_soal')
      .select('*')
      .eq('id', id)
      .single();
    
    if (error) throw error;
    
    document.getElementById('firebaseSoalId').value = id;
    currentAgendaForBank = soalData.ID_Agenda || '';
    currentMapelForBank = soalData.ID_Mapel || '';
    
    const idAgendaInput = document.getElementById('ID_Agenda_Bank');
    if (idAgendaInput) idAgendaInput.value = currentAgendaForBank;
    
    const idMapelInput = document.getElementById('ID_Mapel_Bank');
    if (idMapelInput) idMapelInput.value = currentMapelForBank;
    
    const namaMapelInput = document.getElementById('Nama_Mata_Pelajaran_Bank');
    if (namaMapelInput) namaMapelInput.value = soalData.Nama_Mata_Pelajaran || '';
    
    document.getElementById('No_Soal').value = soalData.No_Soal || '';
    document.getElementById('Pertanyaan').value = soalData.Pertanyaan || '';
    document.getElementById('Type_Soal').value = soalData.Type_Soal || '';
    
    const gambarUrlInput = document.getElementById('Gambar_Url');
    if (gambarUrlInput) gambarUrlInput.value = soalData.Gambar || '';
    
    if (soalData.Gambar) {
      const container = document.getElementById('imagePreviewContainer');
      if (container) {
        container.innerHTML = '';
        
        const img = document.createElement('img');
        img.src = soalData.Gambar;
        img.className = 'image-preview';
        img.alt = 'Gambar Soal';
        container.appendChild(img);
      }
    }
    
    document.getElementById('Pilihan_A').value = soalData.Pilihan_A || '';
    document.getElementById('Pilihan_B').value = soalData.Pilihan_B || '';
    document.getElementById('Pilihan_C').value = soalData.Pilihan_C || '';
    document.getElementById('Pilihan_D').value = soalData.Pilihan_D || '';
    document.getElementById('Pilihan_E').value = soalData.Pilihan_E || '';
    
    for (let i = 1; i <= 10; i++) {
      const el = document.getElementById('Pernyataan_' + i);
      if (el) el.value = soalData['Pernyataan_' + i] || '';
    }
    
    for (let i = 1; i <= 10; i++) {
      const lk = document.getElementById('Pasangan_kiri_' + i);
      const rk = document.getElementById('Pasangan_kanan_' + i);
      if (lk) lk.value = soalData['Pasangan_kiri_' + i] || '';
      if (rk) rk.value = soalData['Pasangan_kanan_' + i] || '';
    }
    
    const bankAgendaSelect = document.getElementById('Bank_Agenda_Select');
    if (bankAgendaSelect) bankAgendaSelect.value = currentAgendaForBank;
    
    const mpSelect = document.getElementById('Bank_Mapel_Select');
    if (mpSelect && supabase) {
      const { data: mapelData } = await supabase
        .from('mata_pelajaran')
        .select('id, Nama_Mata_Pelajaran')
        .eq('ID_Agenda', currentAgendaForBank);
      
      if (mapelData) {
        mpSelect.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
        mapelData.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = item.Nama_Mata_Pelajaran || item.id;
          opt.dataset.nama = item.Nama_Mata_Pelajaran || '';
          mpSelect.appendChild(opt);
        });
        mpSelect.value = currentMapelForBank;
      }
    }
    
    onTypeSoalChange();
    showModal('modal-banksoal');
    
  } catch (err) {
    showNotification('error', 'Gagal', 'Gagal mengambil soal: ' + err.message);
  }
}

async function deleteSoal(id) {
  showConfirmation(
    'Hapus Soal',
    'Apakah Anda yakin ingin menghapus soal ini?',
    async function() {
      if (!supabase) {
        showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
        return;
      }

      try {
        const { error } = await supabase
          .from('bank_soal')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showNotification('success', 'Berhasil', 'Soal berhasil dihapus');
        loadBankSoalTable();
      } catch (err) {
        showNotification('error', 'Gagal', 'Gagal menghapus soal: ' + err.message);
      }
    }
  );
}

function resetBankSoalForm(resetContext = true) {
  document.getElementById('firebaseSoalId').value = '';
  const gambarUrlInput = document.getElementById('Gambar_Url');
  if (gambarUrlInput) gambarUrlInput.value = '';
  
  const gambarInput = document.getElementById('Gambar');
  if (gambarInput) gambarInput.value = '';
  
  const imageContainer = document.getElementById('imagePreviewContainer');
  if (imageContainer) imageContainer.innerHTML = '';
  
  if (resetContext) {
    const form = document.getElementById('bankSoalForm');
    if (form) form.reset();
    onTypeSoalChange();
    currentAgendaForBank = '';
    currentMapelForBank = '';
    
    const bankAgendaSelect = document.getElementById('Bank_Agenda_Select');
    if (bankAgendaSelect) bankAgendaSelect.value = '';
    
    const mapelSelect = document.getElementById('Bank_Mapel_Select');
    if (mapelSelect) mapelSelect.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
    
    const idAgendaInput = document.getElementById('ID_Agenda_Bank');
    if (idAgendaInput) idAgendaInput.value = '';
    
    const idMapelInput = document.getElementById('ID_Mapel_Bank');
    if (idMapelInput) idMapelInput.value = '';
    
    const namaMapelInput = document.getElementById('Nama_Mata_Pelajaran_Bank');
    if (namaMapelInput) namaMapelInput.value = '';
    
    const tbody = document.querySelector('#bankSoalTable tbody');
    if (tbody) tbody.innerHTML = '';
    
    const noSoalInput = document.getElementById('No_Soal');
    if (noSoalInput) noSoalInput.value = '';
  } else {
    document.getElementById('Pertanyaan').value = '';
    document.getElementById('Type_Soal').value = '';
    document.getElementById('Pilihan_A').value = '';
    document.getElementById('Pilihan_B').value = '';
    document.getElementById('Pilihan_C').value = '';
    document.getElementById('Pilihan_D').value = '';
    document.getElementById('Pilihan_E').value = '';
    
    for (let i = 1; i <= 10; i++) {
      const el = document.getElementById('Pernyataan_' + i);
      if (el) el.value = '';
    }
    
    for (let i = 1; i <= 10; i++) {
      const lk = document.getElementById('Pasangan_kiri_' + i);
      const rk = document.getElementById('Pasangan_kanan_' + i);
      if (lk) lk.value = '';
      if (rk) rk.value = '';
    }
    
    onTypeSoalChange();
    
    const idAgendaInput = document.getElementById('ID_Agenda_Bank');
    if (idAgendaInput) idAgendaInput.value = currentAgendaForBank || '';
    
    const idMapelInput = document.getElementById('ID_Mapel_Bank');
    if (idMapelInput) idMapelInput.value = currentMapelForBank || '';
    
    setAutoNoSoal();
  }
}

// ====== MONITORING FUNCTIONS ======

async function loadMonitoring() {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase belum terinisialisasi');
    return;
  }

  try {
    const { data, error } = await supabase
      .from('monitoring_pengerjaan')
      .select('*')
      .order('TglJam_Mulai', { ascending: false });
    
    if (error) throw error;
    
    const tbody = document.querySelector('#monitoringTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    data.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="monitoring-checkbox" value="${item.id}"></td>
        <td>${item.NIS_Username || ''}</td>
        <td>${item.Nama_Peserta || ''}</td>
        <td>${item.Aktivitas_Login || ''}</td>
        <td>${item.Judul_Ujian || ''}</td>
        <td>${item.Mata_Pelajaran || ''}</td>
        <td>${item.Status_Pengerjaan || ''}</td>
        <td>${item.TglJam_Mulai || ''}</td>
        <td>${item.Last_Update || ''}</td>
        <td>${item.TglJam_Selesai || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (error) {
    showNotification('error', 'Error', 'Gagal membaca Monitoring: ' + error.message);
  }
}

function toggleSelectAllMonitoring(src) {
  const cbs = document.querySelectorAll('.monitoring-checkbox');
  cbs.forEach(cb => cb.checked = src.checked);
}

async function deleteSelectedMonitoring() {
  const checked = document.querySelectorAll('.monitoring-checkbox:checked');
  if (!checked.length) {
    showNotification('warning', 'Peringatan', 'Pilih data monitoring yang akan dihapus');
    return;
  }
  
  showConfirmation(
    'Hapus Monitoring',
    `Yakin akan menghapus ${checked.length} data monitoring?`,
    async function() {
      if (!supabase) {
        showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
        return;
      }

      try {
        const ids = Array.from(checked).map(cb => cb.value);
        const { error } = await supabase
          .from('monitoring_pengerjaan')
          .delete()
          .in('id', ids);
        
        if (error) throw error;
        
        showNotification('success', 'Berhasil', `${checked.length} data monitoring berhasil dihapus`);
        loadMonitoring();
      } catch (err) {
        showNotification('error', 'Gagal', 'Gagal menghapus data monitoring: ' + err.message);
      }
    }
  );
}

// ====== JAWABAN SISWA FUNCTIONS ======

async function loadJawaban() {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase belum terinisialisasi');
    return;
  }

  try {
    const { data, error } = await supabase
      .from('jawaban_siswa')
      .select('*')
      .order('TglJam_Mulai', { ascending: false });
    
    if (error) throw error;
    
    const tbody = document.querySelector('#jawabanTable tbody');
    const headerTr = document.getElementById('jawabanHeaderRow');
    if (!tbody || !headerTr) return;
    
    tbody.innerHTML = '';
    headerTr.innerHTML = '';
    
    let maxJ = 0;
    data.forEach(item => {
      for (const key in item) {
        if (key.indexOf('Jwb') === 0) {
          const num = parseInt(key.substring(3), 10);
          if (!isNaN(num) && num > maxJ) maxJ = num;
        }
      }
    });
    
    let headerHtml = `
      <th><input type="checkbox" id="jawaban_select_all" onclick="toggleSelectAllJawaban(this)"></th>
      <th>Nama Siswa</th>
      <th>Agenda Ujian</th>
      <th>Mata Pelajaran</th>
      <th>Jenis Tes</th>
    `;
    
    for (let i = 1; i <= maxJ; i++) {
      headerHtml += `<th>Jwb${i}</th>`;
    }
    
    headerHtml += `
      <th>Status</th>
      <th>TglJam_Mulai</th>
      <th>EndAt</th>
      <th>TglJam_Selesai</th>
      <th>Aksi</th>
    `;
    headerTr.innerHTML = headerHtml;
    
    data.forEach(item => {
      const d = item;
      const nis = d.NIS_Username || '';
      const namaSiswa = pesertaNameMap[nis] || nis;
      
      let jenisTes = '';
      const agendaId = d.ID_Agenda || '';
      if (agendaId && agendaCache[agendaId]) {
        jenisTes = agendaCache[agendaId].Jenis_Tes || '';
      }
      
      let jawabanCount = 0;
      for (let i = 1; i <= maxJ; i++) {
        if (d['Jwb' + i] && d['Jwb' + i].trim() !== '') {
          jawabanCount++;
        }
      }
      
      const jawabanBadge = jawabanCount > 0 
        ? `<span class="jawaban-badge">${jawabanCount}</span>` 
        : '';
      
      let rowHtml = `
        <td><input type="checkbox" class="jawaban-checkbox" value="${item.id}"></td>
        <td>${namaSiswa} ${jawabanBadge}</td>
        <td>${d.Judul_Ujian || ''}</td>
        <td>${d.Mata_Pelajaran || ''}</td>
        <td>${jenisTes}</td>
      `;
      
      for (let i = 1; i <= maxJ; i++) {
        const jawaban = d['Jwb' + i] || '';
        const cellClass = jawaban.trim() !== '' ? 'style="background:#d1fae5;"' : '';
        rowHtml += `<td ${cellClass}>${jawaban}</td>`;
      }
      
      rowHtml += `
        <td>${d.Status || ''}</td>
        <td>${d.TglJam_Mulai || ''}</td>
        <td>${d.EndAt || ''}</td>
        <td>${d.TglJam_Selesai || ''}</td>
        <td class="actions">
          <button onclick="openResetJawabanModal('${item.id}')" title="Reset jawaban siswa">üîÑ Reset</button>
        </td>
      `;
      
      const tr = document.createElement('tr');
      tr.innerHTML = rowHtml;
      tbody.appendChild(tr);
    });
    
  } catch (error) {
    showNotification('error', 'Error', 'Gagal membaca Jawaban Siswa: ' + error.message);
  }
}

function toggleSelectAllJawaban(src) {
  const cbs = document.querySelectorAll('.jawaban-checkbox');
  cbs.forEach(cb => cb.checked = src.checked);
}

async function deleteSelectedJawaban() {
  const checked = document.querySelectorAll('.jawaban-checkbox:checked');
  if (!checked.length) {
    showNotification('warning', 'Peringatan', 'Pilih data jawaban yang akan dihapus');
    return;
  }
  
  showConfirmation(
    'Hapus Jawaban',
    `Yakin akan menghapus ${checked.length} data jawaban?`,
    async function() {
      if (!supabase) {
        showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
        return;
      }

      try {
        const ids = Array.from(checked).map(cb => cb.value);
        const { error } = await supabase
          .from('jawaban_siswa')
          .delete()
          .in('id', ids);
        
        if (error) throw error;
        
        showNotification('success', 'Berhasil', `${checked.length} data jawaban berhasil dihapus`);
        loadJawaban();
      } catch (err) {
        showNotification('error', 'Gagal', 'Gagal menghapus data jawaban: ' + err.message);
      }
    }
  );
}

// ====== CETAK KARTU FUNCTIONS ======

function onChangeAgendaCetakKartu() {
  currentAgendaForKartu = document.getElementById('CetakKartu_Agenda_Select').value;
  loadKartuPesertaTable();
}

async function loadKartuPesertaTable() {
  const tbody = document.querySelector('#cetakKartuTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  kartuPesertaList = [];
  
  if (!currentAgendaForKartu || !supabase) return;
  
  try {
    const { data, error } = await supabase
      .from('peserta')
      .select('*')
      .eq('ID_Agenda', currentAgendaForKartu)
      .order('Nama_Peserta', { ascending: true });
    
    if (error) throw error;
    
    data.forEach((item, idx) => {
      kartuPesertaList.push(item);
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="kartu-checkbox" data-index="${idx}"></td>
        <td>${item.NIS_Username || ''}</td>
        <td>${item.Nama_Peserta || ''}</td>
        <td>
          <div class="password-wrapper" style="position: relative; display: inline-block; width: 100px;">
            <input type="password" value="${item.Password || ''}" readonly 
                   style="width: 100%; padding-right: 30px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; padding: 4px 30px 4px 8px;">
            <button type="button" class="toggle-password" onclick="togglePasswordVisibility(this.previousElementSibling, this)" 
                    style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; font-size: 11px; padding: 0;">
              üëÅÔ∏è
            </button>
          </div>
        </td>
        <td class="actions">
          <button type="button" onclick="printKartuSingle(${idx})">Print</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    showNotification('error', 'Error', 'Gagal membaca peserta: ' + err.message);
  }
}

function toggleSelectAllKartu(src) {
  const cbs = document.querySelectorAll('.kartu-checkbox');
  cbs.forEach(cb => cb.checked = src.checked);
}

function buildKartuHtml(peserta, agendaData) {
  const agendaName = agendaData && agendaData.Agenda_Ujian ? agendaData.Agenda_Ujian : peserta.ID_Agenda || '';
  const token = agendaData && agendaData.Token_Ujian ? agendaData.Token_Ujian : '';
  const nama = peserta.Nama_Peserta || '';
  const sekolah = peserta.Asal_Sekolah || '';
  const kelas = peserta.Kelas || '';
  const username = peserta.NIS_Username || '';
  const password = peserta.Password || '';
  const jenjang = peserta.Jenjang_Studi || '';
  const deskripsi = agendaData && agendaData.Deskripsi_Ujian ? agendaData.Deskripsi_Ujian : '';
  const jenisTes = agendaData && agendaData.Jenis_Tes ? agendaData.Jenis_Tes : '';
  
  return `
    <div class="kartu-container">
      <div class="kartu-logo">CBT 2026</div>
      <div class="kartu-header">KARTU PESERTA UJIAN</div>
      <div class="kartu-title">${agendaName}</div>
      ${deskripsi ? `<div style="text-align:center; font-size:11px; color:#4b5563; margin-bottom:10px;">${deskripsi}</div>` : ''}
      ${jenisTes ? `<div style="text-align:center; font-size:11px; color:#2563eb; font-weight:600; margin-bottom:8px;">${jenisTes}</div>` : ''}
      
      <table class="kartu-table">
        <tr><td class="label">Nama Peserta</td><td>: ${nama}</td></tr>
        <tr><td class="label">Jenjang</td><td>: ${jenjang} - ${kelas}</td></tr>
        <tr><td class="label">Asal Sekolah</td><td>: ${sekolah}</td></tr>
        <tr><td class="label">Username</td><td>: ${username}</td></tr>
        <tr><td class="label">Password</td><td>: ${password}</td></tr>
        <tr><td class="label">Token Ujian</td><td>: <strong style="color:#2563eb;">${token}</strong></td></tr>
      </table>
      
      <div style="margin: 10px 0; padding: 8px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #2563eb;">
        <div style="font-size: 11px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">Petunjuk:</div>
        <div style="font-size: 9px; color: #374151;">
          1. Bawa kartu ini saat ujian<br>
          2. Jaga kerahasiaan username & password<br>
          3. Masukkan token saat memulai ujian<br>
          4. Login 15 menit sebelum ujian dimulai
        </div>
      </div>
      
      <div class="kartu-footer">
        Kartu ini berlaku untuk satu peserta ujian. Dilarang memperbanyak tanpa izin.
      </div>
      <div class="kartu-watermark">CBT2026-Developed by D14nr ¬© 2026</div>
    </div>
  `;
}

function printKartuSingle(index) {
  if (!currentAgendaForKartu) {
    showNotification('error', 'Error', 'Pilih Agenda Ujian terlebih dahulu');
    return;
  }
  
  const peserta = kartuPesertaList[index];
  if (!peserta) return;
  
  const agendaData = agendaCache[currentAgendaForKartu] || {};
  const html = buildKartuHtml(peserta, agendaData);
  
  const area = document.getElementById('printArea');
  if (!area) return;
  
  area.innerHTML = html;
  area.style.display = 'block';
  
  setTimeout(() => {
    window.print();
    setTimeout(() => {
      area.innerHTML = '';
      area.style.display = 'none';
    }, 500);
  }, 100);
}

function printKartuSelected() {
  if (!currentAgendaForKartu) {
    showNotification('error', 'Error', 'Pilih Agenda Ujian terlebih dahulu');
    return;
  }
  
  const checked = document.querySelectorAll('.kartu-checkbox:checked');
  if (!checked.length) {
    showNotification('warning', 'Peringatan', 'Pilih peserta yang akan dicetak kartunya');
    return;
  }
  
  const agendaData = agendaCache[currentAgendaForKartu] || {};
  let html = '';
  
  checked.forEach(cb => {
    const idx = parseInt(cb.getAttribute('data-index'), 10);
    const peserta = kartuPesertaList[idx];
    if (peserta) {
      html += buildKartuHtml(peserta, agendaData);
    }
  });
  
  const area = document.getElementById('printArea');
  if (!area) return;
  
  area.innerHTML = html;
  area.style.display = 'block';
  
  setTimeout(() => {
    window.print();
    setTimeout(() => {
      area.innerHTML = '';
      area.style.display = 'none';
    }, 500);
  }, 100);
}

// ====== MODAL FUNCTIONS ======

function showModal(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function hideModal(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('show');
  document.body.style.overflow = '';
}

function togglePasswordVisibility(inputElement, buttonElement) {
  let input;
  if (typeof inputElement === 'string') {
    input = document.getElementById(inputElement);
  } else {
    input = inputElement;
  }
  
  if (!input || !buttonElement) return;
  
  if (input.type === 'password') {
    input.type = 'text';
    buttonElement.textContent = 'üôà';
  } else {
    input.type = 'password';
    buttonElement.textContent = 'üëÅÔ∏è';
  }
}

function previewImage(input) {
  const container = document.getElementById('imagePreviewContainer');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.className = 'image-preview';
      img.alt = 'Preview Gambar';
      container.appendChild(img);
    }
    
    reader.readAsDataURL(input.files[0]);
  }
}

// ====== EXPORT FUNCTIONS ======

async function exportPesertaToCsv() {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  try {
    const { data, error } = await supabase
      .from('peserta')
      .select('*');
    
    if (error) throw error;
    
    if (data.length === 0) {
      showNotification('warning', 'Peringatan', 'Tidak ada data peserta untuk diexport');
      return;
    }
    
    const headers = [
      'NIS_Username',
      'Nama_Peserta',
      'Password',
      'Jenjang_Studi',
      'Kelas',
      'Asal_Sekolah',
      'No_WA_Peserta',
      'No_WA_Ortu',
      'ID_Agenda'
    ];
    
    const rows = data.map(item => [
      item.NIS_Username || '',
      item.Nama_Peserta || '',
      item.Password || '',
      item.Jenjang_Studi || '',
      item.Kelas || '',
      item.Asal_Sekolah || '',
      item.No_WA_Peserta || '',
      item.No_WA_Ortu || '',
      item.ID_Agenda || ''
    ]);
    
    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `Data_Peserta_${new Date().toISOString().split('T')[0]}.csv`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showNotification('success', 'Export Berhasil', 'Data peserta berhasil diexport ke CSV');
    
  } catch (error) {
    showNotification('error', 'Export Gagal', 'Gagal mengexport data: ' + error.message);
  }
}

async function exportJawabanToCsv() {
  if (!supabase) {
    showNotification('error', 'Error', 'Supabase tidak terinisialisasi');
    return;
  }

  try {
    const { data, error } = await supabase
      .from('jawaban_siswa')
      .select('*');
    
    if (error) throw error;
    
    if (data.length === 0) {
      showNotification('warning', 'Peringatan', 'Tidak ada data jawaban untuk diexport');
      return;
    }
    
    // Get all possible columns
    const allColumns = new Set();
    data.forEach(item => {
      Object.keys(item).forEach(key => {
        allColumns.add(key);
      });
    });
    
    const headers = Array.from(allColumns);
    const rows = data.map(item => 
      headers.map(header => item[header] || '')
    );
    
    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `Data_Jawaban_${new Date().toISOString().split('T')[0]}.csv`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showNotification('success', 'Export Berhasil', 'Data jawaban berhasil diexport ke CSV');
    
  } catch (error) {
    showNotification('error', 'Export Gagal', 'Gagal mengexport data: ' + error.message);
  }
}

// ====== RESET JAWABAN FUNCTIONS ======

function openResetJawabanModal(jawabanId) {
  selectedJawabanForReset = jawabanId;
  
  // TODO: Implement fungsi untuk mengambil data siswa dan daftar mapel
  showModal('modal-reset-jawaban');
}

function confirmResetJawaban() {
  // TODO: Implement fungsi reset jawaban
  showNotification('info', 'Fitur Belum Tersedia', 'Fitur reset jawaban sedang dalam pengembangan');
  hideModal('modal-reset-jawaban');
}

function resetAllJawabanForSelected() {
  const checked = document.querySelectorAll('.jawaban-checkbox:checked');
  if (!checked.length) {
    showNotification('warning', 'Peringatan', 'Pilih data jawaban yang akan direset');
    return;
  }
  
  showNotification('info', 'Fitur Belum Tersedia', 'Fitur reset massal sedang dalam pengembangan');
}

// ====== DEBUG FUNCTIONS ======

function debugResetLogin() {
  sessionStorage.removeItem('adminLoggedIn');
  showNotification('info', 'Debug', 'Login status direset');
  location.reload();
}

// ====== INITIALIZATION ======

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing...');
  
  // Inisialisasi Supabase
  const supabaseInitialized = initializeSupabase();
  
  if (!supabaseInitialized) {
    showNotification('warning', 'Inisialisasi Gagal', 
      'Supabase tidak dapat diinisialisasi. Refresh halaman atau periksa koneksi.', 8000);
  }
  
  // Cek status login
  checkLoginStatus();
  
  // Tambahkan event listener untuk form login
  const loginForm = document.querySelector('.login-form');
  if (loginForm) {
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      handleLogin();
    });
  }
  
  // Debug info
  console.log('Login status:', sessionStorage.getItem('adminLoggedIn'));
  console.log('Supabase initialized:', !!supabase);
  
  // Check if Supabase is configured with placeholder
  if (SUPABASE_URL === 'https://your-project.supabase.co') {
    showNotification('warning', 'Konfigurasi', 
      'Supabase URL dan API key belum dikonfigurasi. Silakan ganti dengan kredensial Supabase Anda.', 10000);
  }
});

// ====== EVENT LISTENERS GLOBAL ======

// Pastikan fungsi tersedia di global scope
window.handleLogin = handleLogin;
window.handleLogout = handleLogout;
window.showTab = showTab;
window.openPesertaModalForCreate = openPesertaModalForCreate;
window.editPeserta = editPeserta;
window.deletePeserta = deletePeserta;
window.handleNoWAChange = handleNoWAChange;
window.savePeserta = savePeserta;
window.resetForm = resetForm;
window.openAgendaModalForCreate = openAgendaModalForCreate;
window.editAgenda = editAgenda;
window.deleteAgenda = deleteAgenda;
window.generateTokenUjian = generateTokenUjian;
window.saveAgenda = saveAgenda;
window.resetAgendaForm = resetAgendaForm;
window.onChangeAgendaMapel = onChangeAgendaMapel;
window.openMapelModalForCreate = openMapelModalForCreate;
window.editMapel = editMapel;
window.deleteMapel = deleteMapel;
window.toggleStatusMapel = toggleStatusMapel;
window.saveMapel = saveMapel;
window.resetMapelForm = resetMapelForm;
window.onTypeSoalChange = onTypeSoalChange;
window.onChangeAgendaBankSoal = onChangeAgendaBankSoal;
window.onChangeMapelBankSoal = onChangeMapelBankSoal;
window.openBankSoalModalForCreate = openBankSoalModalForCreate;
window.editSoal = editSoal;
window.deleteSoal = deleteSoal;
window.saveSoal = saveSoal;
window.resetBankSoalForm = resetBankSoalForm;
window.toggleSelectAllBankSoal = toggleSelectAllBankSoal;
window.selectAllBankSoal = selectAllBankSoal;
window.deselectAllBankSoal = deselectAllBankSoal;
window.deleteSelectedBankSoal = deleteSelectedBankSoal;
window.deleteAllBankSoal = deleteAllBankSoal;
window.downloadTemplatePeserta = downloadTemplatePeserta;
window.importPesertaFromFile = importPesertaFromFile;
window.openImportBankSoalModal = function() {
  showModal('modal-import-banksoal');
};
window.toggleSelectAllMonitoring = toggleSelectAllMonitoring;
window.deleteSelectedMonitoring = deleteSelectedMonitoring;
window.toggleSelectAllJawaban = toggleSelectAllJawaban;
window.deleteSelectedJawaban = deleteSelectedJawaban;
window.resetAllJawabanForSelected = resetAllJawabanForSelected;
window.exportPesertaToCsv = exportPesertaToCsv;
window.exportJawabanToCsv = exportJawabanToCsv;
window.onChangeAgendaCetakKartu = onChangeAgendaCetakKartu;
window.printKartuSelected = printKartuSelected;
window.printKartuSingle = printKartuSingle;
window.toggleSelectAllKartu = toggleSelectAllKartu;
window.showModal = showModal;
window.hideModal = hideModal;
window.togglePasswordVisibility = togglePasswordVisibility;
window.previewImage = previewImage;
window.openResetJawabanModal = openResetJawabanModal;
window.confirmResetJawaban = confirmResetJawaban;
window.closeNotification = closeNotification;
window.hideConfirmation = hideConfirmation;
window.debugResetLogin = debugResetLogin;
   </script>
  </body>
</html>
